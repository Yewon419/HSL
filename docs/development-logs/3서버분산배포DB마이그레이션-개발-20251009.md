# 3ì„œë²„ ë¶„ì‚° ë°°í¬ - DB ë§ˆì´ê·¸ë ˆì´ì…˜ ë° í†µí•© ì‘ì—… ë¡œê·¸

## ì‘ì—… ê°œìš”
**ë‚ ì§œ**: 2025-10-09
**ëª©ì **: ë¡œì»¬ DBë¥¼ 103 ì„œë²„ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ê³  ë¶„ì‚° í™˜ê²½ í†µí•© ì™„ë£Œ
**ê´€ë ¨ ë¬¸ì„œ**: [3ì„œë²„Dockerë¶„ì‚°ë°°í¬-ê°œë°œ-20251008.md](3ì„œë²„Dockerë¶„ì‚°ë°°í¬-ê°œë°œ-20251008.md)

---

## ì‘ì—… ìš”ì•½

ì´ë²ˆ ì‘ì—…ì€ [3ì„œë²„Dockerë¶„ì‚°ë°°í¬-ê°œë°œ-20251008.md](3ì„œë²„Dockerë¶„ì‚°ë°°í¬-ê°œë°œ-20251008.md) ë¬¸ì„œì—ì„œ TODOë¡œ ë‚¨ì•„ìˆë˜ í•­ëª©ë“¤ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤:

âœ… ë¡œì»¬ DB ë°ì´í„°ë¥¼ 103ë²ˆ ì„œë²„ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
âœ… Airflow DAG ì‘ì„± (ì£¼ì‹ ë°ì´í„° ìˆ˜ì§‘)
âœ… Grafana ë°ì´í„°ì†ŒìŠ¤ ì—°ê²°
â¸ï¸ SSL/TLS ì¸ì¦ì„œ ì ìš© (ì§„í–‰ ì¤‘)

---

## 1ë‹¨ê³„: ì‹œìŠ¤í…œ ê¸°ë™

### 1.1 HSL ì‹œìŠ¤í…œ ê¸°ë™ ê°€ì´ë“œ ì‚¬ìš©

`start_hsl.md` íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ë¡œì»¬ ì‹œìŠ¤í…œ ê¸°ë™:

```bash
cd stock-trading-system
docker-compose up -d
docker-compose ps
```

**ê²°ê³¼**: ëª¨ë“  ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰
- PostgreSQL (TimescaleDB): localhost:5435
- Redis: localhost:6380
- InfluxDB: localhost:8086
- Backend (FastAPI): localhost:8000 (healthy)
- Grafana: localhost:3000
- Airflow Webserver: localhost:8080

### 1.2 ë¡œì»¬ DB ì ‘ì† ì •ë³´ í™•ì¸

**ìœ„ì¹˜**: `stock-trading-system/docker-compose.yml`

```yaml
POSTGRES_DB: stocktrading
POSTGRES_USER: admin
POSTGRES_PASSWORD: admin123
Port: 5435 (í˜¸ìŠ¤íŠ¸) â†’ 5432 (ì»¨í…Œì´ë„ˆ)
```

---

## 2ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

### 2.1 ë¡œì»¬ DB ë°±ì—… ìƒì„±

**ë¬¸ì œ**: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê²½ë¡œë¡œ ë°±ì—… ì‹œ Windows ê²½ë¡œ ë³€í™˜ ì˜¤ë¥˜

```bash
# ì‹¤íŒ¨
docker exec stock-db pg_dump -U admin -d stocktrading -F c -f /tmp/stocktrading_backup.dump
# ì˜¤ë¥˜: could not open output file "C:/Users/chohk/AppData/Local/Temp/stocktrading_backup.dump"
```

**í•´ê²°**: í˜¸ìŠ¤íŠ¸ ê²½ë¡œë¡œ ì§ì ‘ ë°±ì—…

```bash
# ì„±ê³µ
docker exec stock-db pg_dump -U admin -d stocktrading > F:/hhstock/stocktrading_backup.sql
```

**ê²½ê³ **: TimescaleDBì˜ circular foreign-key constraints ê²½ê³  ë°œìƒ (ì •ìƒ)
```
pg_dump: warning: there are circular foreign-key constraints on this table:
pg_dump: detail: hypertable, chunk, continuous_agg
```

**ë°±ì—… íŒŒì¼ í¬ê¸°**: 2.9GB

### 2.2 SSH ì ‘ì† í…ŒìŠ¤íŠ¸

**í™•ì¸ ì‚¬í•­**: SSH í‚¤ ê¸°ë°˜ ì¸ì¦ì€ ì„œë²„ ì¬ê¸°ë™ ì—†ì´ ì¦‰ì‹œ ì ìš©ë¨

```bash
ssh -o ConnectTimeout=5 yunsang@192.168.219.103 "echo 'SSH ì—°ê²° ì„±ê³µ'"
# ì¶œë ¥: SSH ì—°ê²° ì„±ê³µ
```

### 2.3 ë°±ì—… íŒŒì¼ ì „ì†¡

**ë¬¸ì œ**: íŒŒì¼ í¬ê¸°ê°€ 2.9GBë¡œ ì»¤ì„œ 10ë¶„ íƒ€ì„ì•„ì›ƒ ë°œìƒ

```bash
# íƒ€ì„ì•„ì›ƒ ë°œìƒ
scp F:/hhstock/stocktrading_backup.sql yunsang@192.168.219.103:/tmp/
# Command timed out after 10m 0s
```

**í•´ê²°**: ë°±ê·¸ë¼ìš´ë“œ ì „ì†¡ ì‚¬ìš©

```bash
# ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰
scp F:/hhstock/stocktrading_backup.sql yunsang@192.168.219.103:/tmp/ &
```

**ë°œê²¬**: 103 ì„œë²„ì— ì´ë¯¸ 10ì›” 8ì¼ì ë°±ì—… íŒŒì¼(2.9GB) ì¡´ì¬ í™•ì¸
- ì‚¬ìš©ì ì„ íƒ: ê¸°ì¡´ íŒŒì¼ë¡œ ì§„í–‰

### 2.4 103 ì„œë²„ DB ìƒíƒœ í™•ì¸

```bash
# DB ì»¨í…Œì´ë„ˆ ìƒíƒœ
docker ps --filter 'name=stock-db'
# ê²°ê³¼: stock-db, stock-db-backup ëª¨ë‘ Up 9 hours (healthy)

# ê¸°ì¡´ í…Œì´ë¸” í™•ì¸
docker exec stock-db psql -U admin -d stocktrading -c '\dt'
# ê²°ê³¼: 16ê°œ í…Œì´ë¸” ì¡´ì¬ (users, stocks, stock_prices ë“±)

# ë°ì´í„° í™•ì¸
SELECT COUNT(*) FROM stock_prices;          # 0
SELECT COUNT(*) FROM technical_indicators;  # 0
```

**ê²°ë¡ **: í…Œì´ë¸” ìŠ¤í‚¤ë§ˆëŠ” ìˆì§€ë§Œ ë°ì´í„°ëŠ” ë¹„ì–´ìˆìŒ

### 2.5 ë°ì´í„°ë² ì´ìŠ¤ ë³µì›

**ë¬¸ì œ**: ë‹¤ë¥¸ ì„œë¹„ìŠ¤ê°€ DB ì ‘ì† ì¤‘

```bash
DROP DATABASE IF EXISTS stocktrading;
# ERROR: database "stocktrading" is being accessed by other users
# DETAIL: There is 1 other session using the database.
```

**í•´ê²°**: ìŠ¤í‚¤ë§ˆ ì‚­ì œ í›„ ì¬ìƒì„± (ì—°ê²° ìœ ì§€)

```bash
docker exec stock-db psql -U admin -d stocktrading -c 'DROP SCHEMA public CASCADE; CREATE SCHEMA public;'
```

**ì¶œë ¥**: 17ê°œ ê°ì²´ ì‚­ì œ í™•ì¸
```
DROP SCHEMA
CREATE SCHEMA
NOTICE: drop cascades to 17 other objects
DETAIL: drop cascades to extension timescaledb
        drop cascades to table users
        drop cascades to table stocks
        ... (ì´ 17ê°œ)
```

**ë³µì› ì‹¤í–‰**:

```bash
docker exec -i stock-db psql -U admin -d stocktrading < /tmp/stocktrading_backup.sql
```

**ë³µì› ê³¼ì •**:
- í™•ì¥ ìƒì„±: `CREATE EXTENSION timescaledb`
- í•¨ìˆ˜ ìƒì„±: TimescaleDB ë‚´ë¶€ í•¨ìˆ˜ë“¤
- í…Œì´ë¸” ìƒì„±: 70ê°œ í…Œì´ë¸” (ì‚¬ìš©ì í…Œì´ë¸” 16ê°œ + TimescaleDB ì‹œìŠ¤í…œ í…Œì´ë¸”)
- ì‹œí€€ìŠ¤ ìƒì„±: AUTO_INCREMENTìš© ì‹œí€€ìŠ¤ë“¤
- ë·° ìƒì„±: Materialized view, viewë“¤
- ë°ì´í„° ë³µì‚¬: COPY ëª…ë ¹ìœ¼ë¡œ ëŒ€ëŸ‰ ë°ì´í„° ì‚½ì…

### 2.6 ë³µì› ê²€ì¦

**í…Œì´ë¸” ìˆ˜ í™•ì¸**:
```bash
docker exec stock-db psql -U admin -d stocktrading -c '\dt' | wc -l
# ê²°ê³¼: 70ê°œ í…Œì´ë¸”
```

**ë°ì´í„° ê°œìˆ˜ ë¹„êµ**:

| í•­ëª© | ë¡œì»¬ DB | 103 ì„œë²„ DB | ì¼ì¹˜ ì—¬ë¶€ |
|------|---------|-------------|-----------|
| stocks | 2,778 | 2,778 | âœ… |
| stock_prices | 3,040,694 | 3,040,694 | âœ… |
| technical_indicators | 2,988,602 | 2,988,602 | âœ… |

**TimescaleDB Hypertables í™•ì¸**:
```sql
SELECT hypertable_name, num_dimensions
FROM timescaledb_information.hypertables;
```

| hypertable_name | num_dimensions |
|-----------------|----------------|
| stock_prices | 1 |
| technical_indicators | 1 |
| indicator_values | 1 |

**ìƒ˜í”Œ ë°ì´í„° ê²€ì¦**:
```sql
SELECT ticker, company_name FROM stocks LIMIT 5;
```

| ticker | company_name |
|--------|--------------|
| 005930.KS | Samsung Electronics |
| 000660.KS | SK Hynix |
| 035420.KS | NAVER |
| AAPL | Apple Inc |
| NVDA | NVIDIA Corporation |

**ìµœì‹  ì£¼ê°€ ë°ì´í„° í™•ì¸**:
```sql
SELECT ticker, date, close_price
FROM stock_prices
ORDER BY date DESC LIMIT 5;
```

| ticker | date | close_price |
|--------|------|-------------|
| 005930 | 2025-10-07 | 70,338.48 |
| 000660 | 2025-10-07 | 134,006.47 |
| 035420 | 2025-10-07 | 185,624.97 |
| 051910 | 2025-10-07 | 408,952.26 |
| 006400 | 2025-10-07 | 363,129.83 |

**ê²°ë¡ **: âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ (100% ë°ì´í„° ì¼ì¹˜)

---

## 3ë‹¨ê³„: Airflow DAG ì‘ì„±

### 3.1 101 ì„œë²„ Airflow ìƒíƒœ í™•ì¸

```bash
ssh yunsang@192.168.219.101 "ls -la /opt/stock-trading/airflow/dags/"
```

**ê¸°ì¡´ DAG íŒŒì¼**:
- comprehensive_indicators.py
- daily_stock_data_pipeline.py
- enhanced_korean_stock_pipeline.py
- integrated_stock_pipeline.py
- korean_stock_pipeline.py (ë©”ì¸)
- market_indicators_pipeline.py
- sync_indicators_to_grafana.py
- trading_signal_monitoring.py

**ë¬¸ì œ**: `airflow dags list` ëª…ë ¹ì´ ì‘ë‹µ ì—†ìŒ (íƒ€ì„ì•„ì›ƒ)

### 3.2 ë¶„ì‚° í™˜ê²½ìš© DAG ì‘ì„±

**íŒŒì¼ëª…**: `distributed_stock_pipeline.py`

**ì„¤ê³„ ëª©ì **:
- ê¸°ì¡´ DAGëŠ” ëª¨ë†€ë¦¬ì‹ êµ¬ì¡° (ì§ì ‘ DB ì ‘ì†, í¬ë¡¤ë§)
- ìƒˆ DAGëŠ” Backend APIë¥¼ í†µí•œ ë°ì´í„° ìˆ˜ì§‘ (ë¶„ì‚° í™˜ê²½ ì í•©)

**ì£¼ìš” êµ¬ì„±**:

```python
from datetime import datetime, timedelta
from airflow import DAG
from airflow.operators.python import PythonOperator

default_args = {
    'owner': 'stock-system',
    'start_date': datetime(2025, 10, 9),
    'retries': 1,
    'retry_delay': timedelta(minutes=5),
}

dag = DAG(
    'distributed_stock_pipeline',
    default_args=default_args,
    description='Distributed stock data collection pipeline',
    schedule_interval='0 19 * * 1-5',  # ë§¤ì¼ ì˜¤í›„ 7ì‹œ (ì¥ ë§ˆê° í›„)
    catchup=False,
    max_active_runs=1,
    tags=['distributed', 'stock', 'production']
)
```

**Task 1: ë°ì´í„° ìˆ˜ì§‘ íŠ¸ë¦¬ê±°**

```python
def trigger_data_collection(**context):
    """Backend APIë¥¼ í†µí•œ ë°ì´í„° ìˆ˜ì§‘ íŠ¸ë¦¬ê±°"""
    import requests

    backend_url = 'http://192.168.219.102:8080/api/data/collect'

    response = requests.post(backend_url, timeout=600)
    response.raise_for_status()

    result = response.json()
    logging.info(f"Data collection completed: {result}")

    return result
```

**Task 2: ë°ì´í„° ê²€ì¦**

```python
def verify_data_collection(**context):
    """ë°ì´í„° ìˆ˜ì§‘ ê²°ê³¼ ê²€ì¦"""
    import requests

    backend_url = 'http://192.168.219.102:8080/api/stocks/list'

    response = requests.get(backend_url, timeout=30)
    response.raise_for_status()

    stocks = response.json()
    logging.info(f"Verified {len(stocks)} stocks in database")

    return len(stocks)
```

**Task ì˜ì¡´ì„±**:
```python
trigger_collection >> verify_collection
```

### 3.3 DAG ë°°í¬

```bash
# ë¡œì»¬ì—ì„œ íŒŒì¼ ìƒì„±
Write: F:\hhstock\distributed_stock_pipeline.py

# 101 ì„œë²„ë¡œ ì „ì†¡
scp F:/hhstock/distributed_stock_pipeline.py yunsang@192.168.219.101:/tmp/

# Airflow DAGs ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ê¶Œí•œ ì„¤ì •
sudo cp /tmp/distributed_stock_pipeline.py /opt/stock-trading/airflow/dags/
sudo chown 50000:0 /opt/stock-trading/airflow/dags/distributed_stock_pipeline.py
```

**ë°°í¬ ê²°ê³¼**:
```bash
ls -l /opt/stock-trading/airflow/dags/distributed_stock_pipeline.py
# -rw-r--r--. 1 50000 root 2254 Oct  8 18:28 distributed_stock_pipeline.py
```

**ì°¸ê³ **: AirflowëŠ” DAG íŒŒì¼ ë³€ê²½ì„ ìë™ ê°ì§€ (ì•½ 30ì´ˆ-1ë¶„ ì†Œìš”)

---

## 4ë‹¨ê³„: Grafana ë°ì´í„°ì†ŒìŠ¤ ì—°ê²°

### 4.1 ê¸°ì¡´ ì„¤ì • í™•ì¸

**ë°ì´í„°ì†ŒìŠ¤ ì„¤ì • ìœ„ì¹˜**:
```bash
/opt/stock-trading/monitoring/grafana/datasources/datasources.yml
```

**ê¸°ì¡´ ì„¤ì • (ë¬¸ì œ)**:
```yaml
datasources:
  - name: PostgreSQL
    url: stock-db:5432  # Docker ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì£¼ì†Œ (ë¶„ì‚° í™˜ê²½ì—ì„œ ì‚¬ìš© ë¶ˆê°€)
```

**ë¬¸ì œì **:
- `stock-db`ëŠ” Docker Composeì˜ ì„œë¹„ìŠ¤ëª…
- 101 ì„œë²„ Grafanaì—ì„œ 103 ì„œë²„ DBë¡œ ì—°ê²°í•˜ë ¤ë©´ ì‹¤ì œ IP í•„ìš”

### 4.2 ë°ì´í„°ì†ŒìŠ¤ ì„¤ì • ìˆ˜ì •

**ìƒˆ ì„¤ì • íŒŒì¼ ìƒì„±**:

```yaml
apiVersion: 1

datasources:
  - name: PostgreSQL
    type: postgres
    access: proxy
    url: 192.168.219.103:5432  # 103 ì„œë²„ ì‹¤ì œ IP
    database: stocktrading
    user: admin
    secureJsonData:
      password: admin123
    jsonData:
      sslmode: disable
      postgresVersion: 1500
      timescaledb: true
    editable: true

  - name: InfluxDB
    type: influxdb
    access: proxy
    url: http://192.168.219.103:8086  # 103 ì„œë²„ ì‹¤ì œ IP
    jsonData:
      version: Flux
      organization: stocktrading
      defaultBucket: metrics
      tlsSkipVerify: true
    secureJsonData:
      token: my-super-secret-auth-token
    editable: true
```

### 4.3 docker-compose.yml ë³¼ë¥¨ ê²½ë¡œ ìˆ˜ì •

**ë¬¸ì œ**: ë³¼ë¥¨ ë§ˆìš´íŠ¸ ê²½ë¡œê°€ ì˜ëª»ë¨

```yaml
# ìˆ˜ì • ì „
volumes:
  - ../../monitoring/grafana/datasources:/etc/grafana/provisioning/datasources

# ìˆ˜ì • í›„
volumes:
  - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
```

**ì´ìœ **: docker-compose.ymlì´ `/opt/stock-trading/` ìœ„ì¹˜ì— ìˆìœ¼ë¯€ë¡œ ìƒëŒ€ ê²½ë¡œ ì¡°ì • í•„ìš”

### 4.4 Grafana ì»¨í…Œì´ë„ˆ ì¬ìƒì„±

**ë¬¸ì œ**: ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆëŠ” ë³¼ë¥¨ ë³€ê²½ ë°˜ì˜ ì•ˆë¨

**í•´ê²°**:
```bash
# ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±°
docker stop stock-grafana
docker rm stock-grafana

# ìƒˆë¡œ ìƒì„±
cd /opt/stock-trading
docker compose up -d grafana
```

### 4.5 ë§ˆìš´íŠ¸ í™•ì¸

```bash
docker exec stock-grafana ls -la /etc/grafana/provisioning/datasources/

# ì¶œë ¥:
# -rw-r--r-- 1 1000 1000 636 Oct  8 22:30 datasources.yml
```

**íŒŒì¼ ë‚´ìš© í™•ì¸**:
```bash
docker exec stock-grafana cat /etc/grafana/provisioning/datasources/datasources.yml | head -15

# ì¶œë ¥: 103 ì„œë²„ IPë¡œ ë³€ê²½ëœ ì„¤ì • í™•ì¸ë¨
```

### 4.6 ë°ì´í„°ì†ŒìŠ¤ ì—°ê²° ê²€ì¦

**APIë¡œ ë°ì´í„°ì†ŒìŠ¤ ëª©ë¡ í™•ì¸**:
```bash
curl -s -u admin:admin123 'http://localhost:3000/api/datasources' | python3 -c 'import sys, json; ...'
```

**ê²°ê³¼**:
```json
[
  {
    "id": 1,
    "name": "PostgreSQL",
    "type": "postgres",
    "url": "192.168.219.103:5432",
    "database": "stocktrading"
  },
  {
    "id": 2,
    "name": "InfluxDB",
    "type": "influxdb",
    "url": "http://192.168.219.103:8086"
  }
]
```

**ì—°ê²° í…ŒìŠ¤íŠ¸**:
```bash
curl -s -X POST -u admin:admin123 'http://localhost:3000/api/datasources/uid/PCC52D03280B7034C/health'
```

**ì‘ë‹µ**:
```json
{
  "message": "Database Connection OK",
  "status": "OK"
}
```

âœ… **Grafana â†” PostgreSQL (103 ì„œë²„) ì—°ê²° ì„±ê³µ**

---

## 5ë‹¨ê³„: SSL/TLS ì¸ì¦ì„œ ì¤€ë¹„

### 5.1 ê³µì¸ IP í™•ì¸

```bash
curl -s ifconfig.me
# ê²°ê³¼: 117.111.123.99

ssh yunsang@192.168.219.101 "curl -s ifconfig.me"
# ê²°ê³¼: 117.111.123.99 (ë™ì¼)
```

**í™•ì¸**: ëª¨ë“  ì„œë²„ê°€ ë™ì¼í•œ ê³µì¸ IP ê³µìœ  (LG U+ ê³µìœ ê¸° í™˜ê²½)

### 5.2 SSL/TLS ì„¤ì • ê³„íš

**ì„ íƒí•œ ë°©ì‹**: í¬íŠ¸í¬ì›Œë”© + Duck DNS + Let's Encrypt

**í•„ìš”í•œ ì‘ì—…**:
1. Duck DNS ë¬´ë£Œ ë„ë©”ì¸ ìƒì„± (ì˜ˆ: mystock.duckdns.org)
2. LG U+ ê³µìœ ê¸° í¬íŠ¸í¬ì›Œë”© ì„¤ì •
   - 80 â†’ 192.168.219.101:80 (Let's Encrypt ì¸ì¦ìš©)
   - 443 â†’ 192.168.219.101:443 (HTTPS)
   - 8080 â†’ 192.168.219.102:8080 (Backend)
3. Certbotìœ¼ë¡œ Let's Encrypt SSL ì¸ì¦ì„œ ë°œê¸‰
4. Nginx SSL ì„¤ì • ì ìš©

**í˜„ì¬ ìƒíƒœ**: Duck DNS ë„ë©”ì¸ ìƒì„± ëŒ€ê¸° ì¤‘

---

## ìµœì¢… ê²°ê³¼

### âœ… ì™„ë£Œëœ ì‘ì—…

| ì‘ì—… | ìƒíƒœ | ë¹„ê³  |
|------|------|------|
| ë¡œì»¬ DB â†’ 103 ì„œë²„ ë§ˆì´ê·¸ë ˆì´ì…˜ | âœ… ì™„ë£Œ | 2.9GB, 3ë°±ë§Œê±´ ë°ì´í„° |
| Airflow DAG ì‘ì„± | âœ… ì™„ë£Œ | distributed_stock_pipeline.py |
| Grafana ë°ì´í„°ì†ŒìŠ¤ ì—°ê²° | âœ… ì™„ë£Œ | 103 ì„œë²„ PostgreSQL ì—°ê²° OK |
| SSL/TLS ì¸ì¦ì„œ ì ìš© | â¸ï¸ ì§„í–‰ ì¤‘ | Duck DNS ë„ë©”ì¸ ìƒì„± ëŒ€ê¸° |

### ğŸ“Š ì‹œìŠ¤í…œ í˜„í™©

**Database Server (192.168.219.103)**
- PostgreSQL: 2,778 ì¢…ëª©, 304ë§Œê±´ ì£¼ê°€ ë°ì´í„°, 298ë§Œê±´ ì§€í‘œ
- Redis: Running
- InfluxDB: Running

**Backend Server (192.168.219.102)**
- FastAPI Backend: Running
- Celery Worker/Beat: Running
- Nginx: 8080 í¬íŠ¸

**Scheduler Server (192.168.219.101)**
- Airflow Webserver/Scheduler: Running
- Grafana: Running (103 ì„œë²„ DB ì—°ê²°ë¨)
- Nginx: 80, 443 í¬íŠ¸

### ğŸ”— ì ‘ì† ì •ë³´

**ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬**:
- Backend: http://192.168.219.102:8080
- Airflow: http://192.168.219.101:8080
- Grafana: http://192.168.219.101:3000

**ì™¸ë¶€ ì ‘ì†**: SSL ì„¤ì • ì™„ë£Œ í›„ ê°€ëŠ¥

---

## ì£¼ìš” í•™ìŠµ ë‚´ìš©

### 1. Windows í™˜ê²½ì—ì„œ PostgreSQL ë°±ì—…
- ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê²½ë¡œ ì‚¬ìš© ì‹œ Windows ê²½ë¡œ ë³€í™˜ ë¬¸ì œ
- í˜¸ìŠ¤íŠ¸ ê²½ë¡œë¡œ ì§ì ‘ ë¦¬ë‹¤ì´ë ‰ì…˜ì´ ë” ì•ˆì „

### 2. SSH í‚¤ ì¸ì¦
- ì„œë²„ ì¬ê¸°ë™ ì—†ì´ ì¦‰ì‹œ ì ìš©ë¨
- `~/.ssh/authorized_keys` ìˆ˜ì • í›„ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥

### 3. Docker Compose ë³¼ë¥¨ ë§ˆìš´íŠ¸
- ìƒëŒ€ ê²½ë¡œëŠ” docker-compose.yml íŒŒì¼ ìœ„ì¹˜ ê¸°ì¤€
- ì»¨í…Œì´ë„ˆ ì¬ìƒì„± í•„ìš”: ë³¼ë¥¨ ë§ˆìš´íŠ¸ ê²½ë¡œ ë³€ê²½ ì‹œ

### 4. Grafana Provisioning
- `/etc/grafana/provisioning/datasources/` ë””ë ‰í† ë¦¬ì— YAML íŒŒì¼ ë°°ì¹˜
- ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ ìë™ ë¡œë“œ
- APIë¡œ ì—°ê²° ìƒíƒœ í™•ì¸ ê°€ëŠ¥

### 5. TimescaleDB Hypertable
- `pg_dump` ì‹œ circular foreign-key ê²½ê³ ëŠ” ì •ìƒ
- ë³µì› ì‹œ `--disable-triggers` ì˜µì…˜ í•„ìš” ì—†ìŒ (full dump)
- Hypertable ë©”íƒ€ë°ì´í„°ë„ í•¨ê»˜ ë³µì›ë¨

---

## ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì§„í–‰ ê°€ëŠ¥
1. âœ… Duck DNS ë„ë©”ì¸ ìƒì„± (ì‚¬ìš©ì ì‘ì—…)
2. âœ… LG U+ ê³µìœ ê¸° í¬íŠ¸í¬ì›Œë”© ì„¤ì •
3. âœ… Let's Encrypt SSL ì¸ì¦ì„œ ë°œê¸‰
4. âœ… Nginx SSL/TLS ì„¤ì •

### ì¤‘ê¸° ê³„íš
- Airflow DAG í…ŒìŠ¤íŠ¸ ë° ìŠ¤ì¼€ì¤„ë§ í™œì„±í™”
- Grafana ëŒ€ì‹œë³´ë“œ ë§ˆì´ê·¸ë ˆì´ì…˜ (ë¡œì»¬ â†’ 101 ì„œë²„)
- ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì„¤ì •
- ë°±ì—… ìë™í™” (103 ì„œë²„)

### ì¥ê¸° ê³„íš
- ë¡œë“œ ë°¸ëŸ°ì‹± (Nginx)
- ê³ ê°€ìš©ì„±(HA) êµ¬ì„± ê²€í† 
- ìë™ ìŠ¤ì¼€ì¼ë§ ê²€í† 

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ì°¸ê³ 

### DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ
```bash
# ì—°ê²° ì¤‘ì¸ ì„¸ì…˜ í™•ì¸
SELECT pid, usename, application_name, client_addr
FROM pg_stat_activity
WHERE datname = 'stocktrading';

# ìŠ¤í‚¤ë§ˆ ì‚­ì œë¡œ ìš°íšŒ (ì—°ê²° ìœ ì§€)
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
```

### Grafana ë°ì´í„°ì†ŒìŠ¤ ì—°ê²° ì‹¤íŒ¨ ì‹œ
```bash
# ì»¨í…Œì´ë„ˆ ì¬ìƒì„± í•„ìˆ˜
docker stop stock-grafana && docker rm stock-grafana
docker compose up -d grafana

# ë§ˆìš´íŠ¸ í™•ì¸
docker exec stock-grafana ls -la /etc/grafana/provisioning/datasources/

# ë¡œê·¸ í™•ì¸
docker logs stock-grafana --tail 50
```

### Airflow DAG ì¸ì‹ ì•ˆë  ë•Œ
```bash
# DAG íŒŒì¼ ê¶Œí•œ í™•ì¸ (UID 50000 í•„ìš”)
ls -l /opt/stock-trading/airflow/dags/

# ê¶Œí•œ ìˆ˜ì •
sudo chown 50000:0 /opt/stock-trading/airflow/dags/*.py

# ìŠ¤ì¼€ì¤„ëŸ¬ ì¬ì‹œì‘
docker restart stock-airflow-scheduler
```

---

**ì‘ì—… ì‹œê°„**: ì•½ 2ì‹œê°„
**ì‘ì—…ì**: Claude Code Assistant
**ê´€ë ¨ ì´ìŠˆ**: ì—†ìŒ
**ë‹¤ìŒ ì‘ì—… ë¬¸ì„œ**: SSL/TLS ì„¤ì • ì™„ë£Œ ì‹œ ë³„ë„ ë¬¸ì„œ ì‘ì„± ì˜ˆì •
