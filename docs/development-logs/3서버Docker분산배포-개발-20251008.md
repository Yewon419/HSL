# 3대 서버 Docker 분산 배포 작업 로그

## 작업 개요
날짜: 2025-10-08
목적: 개발 환경을 3대 Rocky Linux 서버에 Docker 기반 분산 배포
서버: 192.168.219.101 (Scheduler), 192.168.219.102 (Backend), 192.168.219.103 (Database)

## 서버 아키텍처

### Database Server (192.168.219.103)
- **PostgreSQL (TimescaleDB)**: 5432 포트
- **Redis**: 6379 포트
- **InfluxDB**: 8086 포트
- **Backup Service**: 자동 백업

### Backend Server (192.168.219.102)
- **FastAPI Backend**: 8000 포트
- **Celery Worker**: 분산 작업 처리
- **Celery Beat**: 스케줄링
- **Nginx**: 8080 포트 (Frontend + API Proxy)

### Scheduler Server (192.168.219.101)
- **Airflow Webserver**: 8080 포트
- **Airflow Scheduler**: 워크플로우 관리
- **Grafana**: 3000 포트
- **Nginx**: 80, 443 포트

## 배포 프로세스

### 1단계: Docker 설치

#### 1.1 Docker 설치 스크립트 생성
```bash
# stock-trading-system/deployment/install-docker.sh
#!/bin/bash
set -e

# Docker CE 설치
dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Docker 서비스 시작
systemctl start docker
systemctl enable docker

# yunsang 사용자를 docker 그룹에 추가
usermod -aG docker yunsang
```

#### 1.2 3대 서버에 Docker 설치
```bash
# 각 서버에서 실행
chmod +x stock-trading-system/deployment/install-docker.sh
sudo ./stock-trading-system/deployment/install-docker.sh
```

**문제**: Windows에서 생성한 스크립트의 CRLF 개행 문자 오류
```bash
/tmp/install-docker.sh: line 2: $'\r': command not found
```

**해결**:
```bash
sed -i 's/\r$//' stock-trading-system/deployment/install-docker.sh
```

### 2단계: Database Server (103) 배포

#### 2.1 환경 설정
```bash
# .env 파일 생성
DB_PASSWORD=admin123
DB_USER=admin
DB_NAME=stocktrading
REDIS_PASSWORD=
INFLUX_TOKEN=my-super-secret-auth-token
```

#### 2.2 포트 충돌 해결
**문제**: 기존 PostgreSQL과 Redis가 포트 사용 중
```bash
netstat -tlnp | grep 5432
tcp 0 0 0.0.0.0:5432 0.0.0.0:* LISTEN 24162/postgres
```

**해결**: 기존 서비스 중지
```bash
sudo kill -9 24162  # PostgreSQL
sudo kill -9 2088   # Redis
```

#### 2.3 컨테이너 시작
```bash
cd /opt/stock-trading/deployment/database-server
docker compose up -d
```

**결과**: ✅ 모든 서비스 정상 작동
- PostgreSQL: Healthy
- Redis: Healthy
- InfluxDB: Healthy

### 3단계: Backend Server (102) 배포

#### 3.1 pandas_ta 의존성 충돌

**문제**: pandas_ta 설치 실패
```
ERROR: Could not find a version that satisfies the requirement pandas-ta==0.3.14b0
ERROR: pandas-ta 0.4.67b0 depends on numpy>=2.2.6
ERROR: pandas 2.1.3 depends on numpy<2
```

**해결**: pandas_ta 제거하고 순수 pandas/numpy로 재구현

```python
# backend/stock_service/indicators.py (수정 전)
import pandas_ta as ta

def calculate_rsi(df: pd.DataFrame, period: int = 14) -> pd.Series:
    return ta.rsi(df['Close'], length=period)

# backend/stock_service/indicators.py (수정 후)
def calculate_rsi(df: pd.DataFrame, period: int = 14) -> pd.Series:
    """Calculate RSI without pandas_ta"""
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
    rs = gain / loss
    rsi = 100 - (100 / (1 + rs))
    return rsi
```

모든 기술 지표를 pandas/numpy로 재구현:
- Stochastic Oscillator
- MACD
- RSI
- SMA (Simple Moving Average)
- Bollinger Bands

#### 3.2 Celery Beat 스케줄러 오류

**문제**: Django Celery Beat 스케줄러 모듈 없음
```
ModuleNotFoundError: No module named 'django_celery_beat'
```

**해결**: 기본 스케줄러로 변경
```yaml
# docker-compose.yml (수정 전)
command: celery -A celery_app beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler

# docker-compose.yml (수정 후)
command: celery -A celery_app beat --loglevel=info
```

#### 3.3 Nginx 포트 충돌

**문제**: 포트 80 이미 사용 중
```
failed to bind host port for 0.0.0.0:80:172.18.0.4:80/tcp: address already in use
```

**해결**: Nginx 포트를 8080으로 변경
```yaml
# docker-compose.yml
ports:
  - "8080:80"  # 80 → 8080으로 변경
  - "443:443"
```

#### 3.4 Docker 네트워크 설정

**문제**: External 네트워크가 존재하지 않음
```yaml
networks:
  stock-network:
    external: true  # 문제 발생
```

**해결**: External 옵션 제거
```yaml
networks:
  stock-network:
    driver: bridge
```

#### 3.5 Celerybeat Schedule 마운트 오류

**문제**: 파일을 디렉토리로 마운트 시도
```
error mounting "/opt/stock-trading/celerybeat-schedule" to rootfs: cannot create subdirectories
```

**해결**: 볼륨 마운트 제거
```yaml
# volumes:
#   - ./celerybeat-schedule:/app/celerybeat-schedule  # 제거
```

### 4단계: Scheduler Server (101) 배포

#### 4.1 Airflow 환경 설정

**Fernet Key 생성**:
```python
from cryptography.fernet import Fernet
key = Fernet.generate_key()
# P8f3UJSquIcVVlofIvvHN3j6X4Jb-TJge6mhXb6i0yQ=
```

#### 4.2 Nginx 포트 충돌

**문제**: 기존 Nginx 서비스가 포트 80 사용 중
```bash
netstat -tlnp | grep :80
tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 1378/nginx: master
```

**해결**: 시스템 Nginx 서비스 중지
```bash
sudo systemctl stop nginx
sudo systemctl disable nginx
```

#### 4.3 Airflow 로그 권한 문제

**문제**: Airflow가 로그 디렉토리에 쓰기 권한 없음
```
PermissionError: [Errno 13] Permission denied: '/opt/airflow/logs/scheduler'
ValueError: Unable to configure handler 'processor'
```

**해결**: Airflow 사용자(UID 50000) 소유권 설정
```bash
sudo chown -R 50000:0 /opt/stock-trading/airflow/logs
sudo chown -R 50000:0 /opt/stock-trading/airflow/dags
sudo chown -R 50000:0 /opt/stock-trading/airflow/plugins
```

#### 4.4 Airflow 데이터베이스 초기화

```bash
# Airflow DB 생성
docker exec stock-db psql -U admin -d postgres -c 'CREATE DATABASE airflow;'
docker exec stock-db psql -U admin -d postgres -c 'CREATE DATABASE grafana;'

# Airflow DB 초기화
docker exec stock-airflow-webserver airflow db init

# 관리자 사용자 생성
docker exec stock-airflow-webserver airflow users create \
  --username admin \
  --firstname Admin \
  --lastname User \
  --role Admin \
  --email admin@example.com \
  --password admin123
```

### 5단계: Frontend 및 API 통합

#### 5.1 CORS 오류

**문제**: 브라우저에서 다른 포트로의 요청 차단
```
Access to fetch at 'http://192.168.219.102:8000/api/v1/users/token'
from origin 'http://192.168.219.102:8080' has been blocked by CORS policy
```

**원인**: 프론트엔드(8080)에서 백엔드(8000)로 직접 요청

**해결**: API 요청을 같은 포트(8080)로 변경하여 Nginx 프록시 활용

```javascript
// frontend/app.js (수정 전)
this.baseURL = 'http://192.168.219.102:8000/api';

// frontend/app.js (수정 후)
this.baseURL = 'http://192.168.219.102:8080/api';
```

```javascript
// frontend/index.html (수정 전)
const baseURL = 'http://192.168.219.102:8000';

// frontend/index.html (수정 후)
const baseURL = 'http://192.168.219.102:8080';
```

#### 5.2 Nginx 프록시 설정 오류

**문제**: 루트 경로(/)가 백엔드 API로 프록시되어 프론트엔드 파일 서빙 안됨

```nginx
# nginx/conf.d/default.conf (수정 전)
location / {
    proxy_pass http://backend;  # 모든 요청이 백엔드로!
}
```

**해결**: 루트는 프론트엔드 파일 서빙, /api만 프록시

```nginx
# nginx/conf.d/default.conf (수정 후)
server {
    listen 80;
    root /usr/share/nginx/html;
    index index.html;

    # HTML/JS 파일 캐싱 비활성화
    location ~* \.(html|js)$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # API 프록시
    location /api {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        # CORS 헤더 추가
        add_header 'Access-Control-Allow-Origin' '*' always;
    }

    # 프론트엔드 파일 서빙
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

#### 5.3 localhost 참조 문제

**문제**: 프론트엔드 코드에 localhost 하드코딩
```javascript
const baseURL = 'http://localhost:8000';
```

**해결**: 모든 localhost를 서버 IP로 변경
```bash
sed -i "s|http://localhost:8000|http://192.168.219.102:8080|g" frontend/index.html
sed -i "s|http://192.168.219.102:8000|http://192.168.219.102:8080|g" frontend/app.js
```

#### 5.4 존재하지 않는 DOM 요소 접근

**문제**: app.js에서 없는 버튼에 이벤트 리스너 추가 시도
```javascript
document.getElementById('load-indicators-btn').addEventListener('click', ...);
// load-indicators-btn 요소가 index.html에 없음
```

**해결**: 해당 라인 주석 처리
```javascript
// document.getElementById('load-indicators-btn').addEventListener('click', () => this.loadIndicators());
```

### 6단계: 데이터베이스 초기화

#### 6.1 bcrypt 라이브러리 문제

**문제**: passlib의 bcrypt 호환성 문제
```python
ValueError: password cannot be longer than 72 bytes
```

**해결**: bcrypt 4.0.1 설치
```bash
docker exec stock-backend pip install 'bcrypt==4.0.1'
docker restart stock-backend stock-celery-worker stock-celery-beat
```

#### 6.2 데이터베이스 테이블 생성

```bash
# 테이블 생성
docker exec stock-backend python -c "
from database import engine, Base
import models
Base.metadata.create_all(bind=engine)
"

# 생성된 테이블 확인
docker exec stock-db psql -U admin -d stocktrading -c '\dt'
```

**생성된 테이블 (16개)**:
- users, stocks, stock_prices, stock_fundamentals
- technical_indicators, patterns
- portfolios, simulations, simulation_trades
- ai_recommendations, user_alerts
- investor_trades, sectors, industries
- stock_classifications, industry_correlations

#### 6.3 관리자 계정 생성

```bash
# API를 통한 사용자 등록
curl -X POST "http://192.168.219.102:8080/api/v1/users/register" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","email":"admin@example.com","password":"admin123"}'

# 응답
{
  "username":"admin",
  "email":"admin@example.com",
  "id":1,
  "initial_capital":"10000000.00",
  "current_assets":"10000000.00",
  "created_at":"2025-10-08T14:08:03.391565Z"
}
```

#### 6.4 백엔드 라우터 prefix 수정

**문제**: 프론트엔드는 `/api/v1/stocks` 호출하지만 백엔드는 `/api/stocks`로 등록됨

```python
# main.py (수정 전)
app.include_router(stock_router, prefix="/api/stocks", tags=["stocks"])

# main.py (수정 후)
app.include_router(stock_router, prefix="/api/v1/stocks", tags=["stocks"])
```

## 최종 배포 결과

### Database Server (103)
```bash
NAMES             STATUS
stock-db-backup   Up 37 minutes
stock-db          Up 37 minutes (healthy)
stock-influxdb    Up 40 minutes (healthy)
stock-redis       Up 37 minutes (healthy)
```

### Backend Server (102)
```bash
NAMES                 STATUS
stock-celery-beat     Up 16 minutes
stock-celery-worker   Up 18 minutes
stock-nginx-backend   Up 18 minutes
stock-backend         Up 18 minutes (healthy)
```

### Scheduler Server (101)
```bash
NAMES                     STATUS
stock-nginx-scheduler     Up 6 minutes
stock-airflow-webserver   Up 2 minutes (healthy)
stock-airflow-scheduler   Up 2 minutes (healthy)
stock-grafana             Up 6 minutes (healthy)
```

### 접속 정보

**Frontend & Backend API**
- URL: http://192.168.219.102:8080
- Username: admin
- Password: admin123

**Airflow**
- URL: http://192.168.219.101:8080
- Username: admin
- Password: admin123

**Grafana**
- URL: http://192.168.219.101:3000
- Username: admin
- Password: admin123

## 핵심 문제 해결 요약

### 1. pandas_ta 의존성 충돌
- **원인**: numpy 버전 충돌 (pandas_ta는 numpy>=2.2.6, pandas는 numpy<2)
- **해결**: pandas_ta 제거, 순수 pandas/numpy로 기술지표 재구현
- **영향**: 모든 기술지표 계산 함수 재작성 필요

### 2. CORS 정책 위반
- **원인**: 다른 포트 간 직접 요청 (8080 → 8000)
- **해결**: API 요청을 같은 포트(8080)의 Nginx로 변경, Nginx가 백엔드로 프록시
- **핵심**: 브라우저 입장에서 같은 출처로 인식되도록 설정

### 3. Nginx 프록시 설정
- **원인**: 루트 경로를 백엔드로 프록시하여 프론트엔드 파일 서빙 불가
- **해결**: 루트는 정적 파일 서빙, `/api` 경로만 백엔드로 프록시
- **추가**: HTML/JS 파일 캐싱 비활성화로 개발 편의성 향상

### 4. Celery Beat 스케줄러
- **원인**: django_celery_beat 모듈 없음
- **해결**: 기본 스케줄러 사용 (Django 의존성 제거)
- **영향**: 스케줄 정보가 코드에 하드코딩됨 (database scheduler 대신)

### 5. Airflow 권한 문제
- **원인**: 로그 디렉토리 권한 부족 (UID 불일치)
- **해결**: Airflow 컨테이너 사용자(UID 50000)로 소유권 변경
- **학습**: Docker 볼륨 마운트 시 사용자 권한 고려 필요

### 6. bcrypt 호환성
- **원인**: passlib[bcrypt]와 bcrypt 버전 호환 문제
- **해결**: bcrypt 4.0.1 명시적 설치
- **교훈**: 암호화 라이브러리는 버전 명시 필요

## 트러블슈팅 체크리스트

### 컨테이너가 재시작 반복하는 경우
```bash
# 로그 확인
docker logs <container_name> --tail 50

# 일반적인 원인
1. 필수 환경변수 누락
2. 포트 충돌
3. 볼륨 마운트 경로 오류
4. 의존성 라이브러리 누락
```

### CORS 오류 발생 시
```bash
# 원인 진단
1. 프론트엔드 baseURL 확인 (포트 일치 여부)
2. Nginx 프록시 설정 확인 (proxy_pass)
3. 백엔드 CORS 설정 확인

# 해결 순서
1. API 요청을 Nginx 포트로 변경
2. Nginx에서 CORS 헤더 추가
3. 브라우저 캐시 완전 삭제
```

### 데이터베이스 연결 실패 시
```bash
# 연결 테스트
docker exec stock-db psql -U admin -d stocktrading -c 'SELECT 1'

# 일반적인 원인
1. 환경변수 DATABASE_URL 오류
2. 데이터베이스 서비스 미실행
3. 방화벽/네트워크 문제
4. 테이블 미생성
```

### Nginx 404/502 오류
```bash
# 설정 검증
docker exec stock-nginx-backend nginx -t

# 로그 확인
docker logs stock-nginx-backend --tail 30

# 일반적인 원인
1. location 블록 순서 오류 (/, /api)
2. proxy_pass URL 오류
3. upstream 서비스 미실행
4. 정적 파일 경로 오류 (root, try_files)
```

## 개선 사항 및 향후 작업

### 단기 (1주일 이내)
- [ ] 로컬 DB 데이터를 103번 서버로 마이그레이션
- [ ] Airflow DAG 작성 (주식 데이터 수집)
- [ ] Grafana 데이터소스 연결
- [ ] SSL/TLS 인증서 적용 (Let's Encrypt)
- [ ] 로그 수집 시스템 구축 (ELK Stack)

### 중기 (1개월 이내)
- [ ] CI/CD 파이프라인 구축 (GitHub Actions)
- [ ] 백업 자동화 및 복구 테스트
- [ ] 모니터링 알림 설정 (Slack/Email)
- [ ] 성능 테스트 및 최적화
- [ ] API 문서 자동화 (Swagger UI)

### 장기
- [ ] Kubernetes 마이그레이션 고려
- [ ] 고가용성(HA) 구성
- [ ] 자동 스케일링 설정
- [ ] 재해 복구(DR) 계획 수립

## 참고 문서

- [Docker Compose 네트워크 가이드](https://docs.docker.com/compose/networking/)
- [Nginx 프록시 설정](https://nginx.org/en/docs/http/ngx_http_proxy_module.html)
- [Apache Airflow 공식 문서](https://airflow.apache.org/docs/)
- [CORS 정책 이해하기](https://developer.mozilla.org/ko/docs/Web/HTTP/CORS)
- [TimescaleDB 가이드](https://docs.timescale.com/)

## 명령어 요약

```bash
# Docker 설치
sudo ./stock-trading-system/deployment/install-docker.sh

# 서비스 시작
docker compose up -d

# 서비스 중지
docker compose down

# 로그 확인
docker logs <container_name> --tail 50 -f

# 컨테이너 재시작
docker restart <container_name>

# 데이터베이스 접속
docker exec -it stock-db psql -U admin -d stocktrading

# 백엔드 컨테이너에서 Python 실행
docker exec stock-backend python -c "print('hello')"

# 파일 복사
scp local_file user@server:/remote/path
```

## 배운 교훈

1. **의존성 관리의 중요성**: pandas_ta처럼 서브 의존성까지 고려해야 함
2. **네트워크 이해**: CORS는 브라우저 보안 정책, 서버 간 통신과 무관
3. **Docker 권한**: 볼륨 마운트 시 컨테이너 사용자 UID 확인 필수
4. **Nginx 설정**: location 블록 순서와 proxy_pass 경로 주의
5. **환경 변수**: 하드코딩(localhost) 대신 환경별 설정 파일 사용
6. **로그 활용**: 문제 해결의 90%는 로그에서 답을 찾을 수 있음

---
*마지막 업데이트: 2025-10-08*
*작업자: Claude Code Assistant*
*작업 시간: 약 6시간*
*해결한 주요 이슈: 10개*
