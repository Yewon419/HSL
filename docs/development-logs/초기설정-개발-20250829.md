# 주식 투자 시뮬레이션 및 실시간 모니터링 시스템 개발 문서

**작성일**: 2025-08-29  
**프로젝트명**: Stock Trading System  
**개발자**: Claude Code Assistant  

---

## 📋 프로젝트 개요

### 목표
AI 기반 주식 투자 시뮬레이션과 실시간 모니터링을 제공하는 종합 금융 플랫폼 개발

### 핵심 요구사항
- 실시간 주가 데이터 수집 (하루 1번 종가 기준 업데이트)
- AI 기반 매매 추천 시스템
- 개인 포트폴리오 관리 및 손익 계산
- Grafana를 통한 시각화 모니터링
- 가치 투자 철학과 기술 지표 결합

---

## 🏗️ 시스템 아키텍처

### 전체 아키텍처
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend API   │    │   Database      │
│   (Grafana)     │◄──►│   (FastAPI)     │◄──►│  (PostgreSQL +  │
│                 │    │                 │    │   TimescaleDB)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                       ┌─────────────────┐
                       │   Task Queue    │
                       │   (Celery +     │
                       │    Redis)       │
                       └─────────────────┘
                                │
                    ┌─────────────────────────┐
                    │   Microservices         │
                    ├─────────────────────────┤
                    │ • User Service          │
                    │ • Stock Data Service    │
                    │ • Simulation Service    │
                    │ • AI Service            │
                    └─────────────────────────┘
```

### 마이크로서비스 구성

#### 1. User Service
- JWT 기반 사용자 인증
- 개인 포트폴리오 관리
- 매수/매도 거래 기록
- 실시간 손익 계산

#### 2. Stock Data Service  
- Yahoo Finance API 연동
- 기술적 지표 계산 (RSI, MACD, 스토캐스틱, 볼린저 밴드)
- 시장 스크리닝 (과매수/과매도 종목 탐지)
- 상관관계 분석

#### 3. Simulation Service
- 역사적 데이터 백테스팅
- 다양한 투자 전략 시뮬레이션
- 수익률 및 샤프지수 계산
- 최대 낙폭 분석

#### 4. AI Recommendation Service
- 머신러닝 기반 패턴 인식
- 다중 지표 융합 신호 생성
- 신뢰도 점수 계산
- 새로운 패턴 발견 및 알림

---

## 💾 데이터베이스 설계

### ERD 및 주요 테이블

#### 사용자 관련
```sql
-- 사용자 정보
users (id, username, email, password_hash, initial_capital, current_assets)

-- 포트폴리오
portfolios (id, user_id, ticker, quantity, buy_price, sell_price, status)
```

#### 주식 데이터
```sql
-- 주식 기본 정보
stocks (ticker, company_name, sector, industry, market_cap)

-- 주가 데이터 (TimescaleDB 하이퍼테이블)
stock_prices (ticker, date, open, high, low, close, volume)

-- 기술지표 (TimescaleDB 하이퍼테이블) 
technical_indicators (ticker, date, rsi, macd, stoch_k, stoch_d, ma_20, ma_50, bollinger_*)
```

#### AI 및 분석
```sql
-- 시뮬레이션 결과
simulations (id, user_id, strategy_config, start_date, end_date, roi, sharpe_ratio)

-- AI 추천
ai_recommendations (id, ticker, recommendation_type, confidence_score, reason)

-- 패턴 발견
patterns (id, pattern_type, description, affected_tickers, confidence_level)
```

---

## 🛠️ 기술 스택

### Backend
- **FastAPI**: 고성능 Python API 프레임워크
- **SQLAlchemy**: ORM 및 데이터베이스 연동  
- **Pydantic**: 데이터 검증 및 직렬화
- **Celery**: 비동기 작업 큐 및 스케줄링
- **Redis**: 캐시 및 메시지 브로커

### Database
- **PostgreSQL 15**: 메인 관계형 데이터베이스
- **TimescaleDB**: 시계열 데이터 최적화 확장
- **InfluxDB**: 모니터링 메트릭 저장

### ML/AI Stack
- **scikit-learn**: 기본 머신러닝 알고리즘
- **XGBoost**: 그래디언트 부스팅 분류/회귀
- **TensorFlow**: 딥러닝 (LSTM 시계열 예측)
- **TA-Lib**: 금융 기술지표 계산 라이브러리
- **pandas-ta**: 추가 기술지표
- **statsmodels**: 통계 분석 (상관관계, Granger Causality)

### Data & APIs
- **yfinance**: Yahoo Finance 데이터 수집
- **pandas**: 데이터 처리 및 분석
- **numpy**: 수치 계산

### Monitoring & Visualization  
- **Grafana**: 대시보드 및 실시간 차트
- **Prometheus**: 메트릭 수집 (선택사항)

### DevOps
- **Docker & Docker Compose**: 컨테이너화
- **pytest**: 단위 테스트
- **GitHub Actions**: CI/CD (계획)

---

## 📁 프로젝트 구조

```
stock-trading-system/
├── backend/                      # Backend API 서비스
│   ├── user_service/            # 사용자 관리 서비스
│   │   ├── __init__.py
│   │   ├── auth.py             # JWT 인증 로직
│   │   ├── schemas.py          # Pydantic 모델
│   │   └── router.py           # API 엔드포인트
│   ├── stock_service/          # 주식 데이터 서비스  
│   │   ├── __init__.py
│   │   ├── data_fetcher.py     # 데이터 수집 로직
│   │   ├── indicators.py       # 기술지표 계산
│   │   └── router.py           # API 엔드포인트
│   ├── simulation_service/     # 백테스팅 서비스
│   │   ├── __init__.py
│   │   └── router.py           # 시뮬레이션 API
│   ├── ai_service/            # AI 추천 서비스
│   │   ├── __init__.py
│   │   └── router.py          # AI 추천 API
│   ├── common/                # 공통 유틸리티
│   ├── main.py               # FastAPI 메인 애플리케이션
│   ├── config.py             # 환경설정
│   ├── database.py           # DB 연결 설정
│   ├── models.py             # SQLAlchemy 모델
│   ├── celery_app.py         # Celery 작업 정의
│   ├── requirements.txt      # Python 의존성
│   ├── Dockerfile           # 백엔드 컨테이너 이미지
│   └── test_data_loader.py  # 테스트 데이터 로더
├── database/                 # 데이터베이스 관련
│   └── init.sql             # DB 초기화 스크립트
├── monitoring/              # 모니터링 설정
│   └── grafana/
│       ├── dashboards/      # Grafana 대시보드 정의
│       └── datasources/     # 데이터소스 설정
├── frontend/               # 웹 프론트엔드 (예정)
├── tests/                 # 테스트 코드
├── docker-compose.yml     # 전체 시스템 오케스트레이션
├── demo.py               # 단독 실행 데모
└── README.md            # 프로젝트 문서
```

---

## ⚙️ 주요 구현 내용

### 1. 사용자 인증 시스템 (user_service/)

#### JWT 기반 인증
```python
# auth.py 핵심 기능
- 비밀번호 해싱 (bcrypt)
- JWT 토큰 생성/검증
- 사용자 인증 미들웨어
```

#### 포트폴리오 관리
```python
# router.py 주요 엔드포인트
POST /api/v1/users/register     # 회원가입
POST /api/v1/users/token        # 로그인  
GET  /api/v1/users/dashboard    # 대시보드 데이터
POST /api/v1/users/portfolio    # 매수 기록
POST /api/v1/users/portfolio/sell # 매도 처리
```

### 2. 주식 데이터 수집 시스템 (stock_service/)

#### 기술지표 계산 엔진
```python
# indicators.py 구현된 지표들
- Stochastic Oscillator (%K, %D)
- MACD (Signal, Histogram)  
- RSI (Relative Strength Index)
- Moving Averages (20, 50, 200일)
- Bollinger Bands (상한/하한)
```

#### 신호 생성 로직
```python
# SignalGenerator 클래스
- 다중 지표 교차 신호
- 과매수/과매도 감지
- 강도별 신호 분류 (STRONG_BUY, BUY, HOLD, SELL, STRONG_SELL)
```

#### 데이터 수집 및 저장
```python
# data_fetcher.py 핵심 기능
- Yahoo Finance API 연동
- 실시간 주가 데이터 수집
- TimescaleDB 최적화 저장
- 오류 처리 및 재시도 로직
```

### 3. AI 추천 엔진 (ai_service/)

#### 모멘텀 기반 추천
```python
# 구현된 AI 로직
- 5일 가격 변동률 분석
- 상대적 성과 비교  
- 신뢰도 점수 계산 (0-100)
- 목표가/손절가 제시
```

### 4. 백그라운드 작업 시스템 (celery_app.py)

#### 스케줄링 작업
```python
# Celery Beat 스케줄
- 일일 주가 데이터 업데이트 (16:00 KST)
- AI 추천 생성 (17:00 KST)  
- 테스트용 5분마다 업데이트
```

#### 지원 종목
```python
# 기본 수집 종목
한국: 005930.KS(삼성전자), 000660.KS(SK하이닉스), 035420.KS(네이버)
미국: AAPL(애플), NVDA(엔비디아), TSLA(테슬라), MSFT(마이크로소프트)
```

---

## 📊 API 설계

### RESTful API 구조

#### 사용자 관리
```
POST /api/v1/users/register
POST /api/v1/users/token  
GET  /api/v1/users/me
GET  /api/v1/users/dashboard
POST /api/v1/users/portfolio
PUT  /api/v1/users/portfolio/sell
GET  /api/v1/users/alerts
```

#### 주식 데이터
```
POST /api/v1/stocks/update/{ticker}
POST /api/v1/stocks/update-batch  
GET  /api/v1/stocks/{ticker}/prices
GET  /api/v1/stocks/{ticker}/indicators
GET  /api/v1/stocks/{ticker}/analysis
GET  /api/v1/stocks/screen/oversold
GET  /api/v1/stocks/screen/overbought
GET  /api/v1/stocks/watchlist
```

#### AI 및 시뮬레이션
```
GET  /api/v1/ai/recommendations
GET  /api/v1/ai/patterns
GET  /api/v1/simulations/
POST /api/v1/simulations/run
```

---

## 🎯 핵심 알고리즘

### 1. 기술지표 계산

#### RSI (Relative Strength Index)
```python
delta = prices.diff()
gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
rs = gain / loss
rsi = 100 - (100 / (1 + rs))
```

#### MACD (Moving Average Convergence Divergence)  
```python
exp1 = close.ewm(span=12).mean()
exp2 = close.ewm(span=26).mean()
macd = exp1 - exp2
signal = macd.ewm(span=9).mean()
histogram = macd - signal
```

### 2. 신호 생성 로직

#### 다중 지표 융합
```python
def generate_combined_signals(df):
    stoch_signals = generate_stochastic_signals(df)
    macd_signals = generate_macd_signals(df)  
    rsi_signals = generate_rsi_signals(df)
    
    # 2개 이상 지표가 일치할 때 강한 신호
    buy_count = (signals == 'BUY').sum()
    if buy_count >= 2:
        return 'STRONG_BUY'
```

### 3. 포트폴리오 성과 계산

#### 실시간 손익 계산
```python
current_value = latest_price * quantity  
profit_loss = current_value - (buy_price * quantity)
return_pct = (profit_loss / (buy_price * quantity)) * 100
```

---

## 🔧 설정 및 환경변수

### 환경변수 (.env)
```bash
# Database
DATABASE_URL=postgresql://admin:admin123@localhost:5435/stocktrading

# Redis & Celery  
REDIS_URL=redis://localhost:6380
CELERY_BROKER_URL=redis://localhost:6380/0

# InfluxDB
INFLUXDB_URL=http://localhost:8086
INFLUXDB_TOKEN=my-super-secret-auth-token

# JWT
JWT_SECRET_KEY=your-secret-key-change-this
JWT_ALGORITHM=HS256
```

### Docker Compose 구성
```yaml
services:
  - postgres (TimescaleDB)  
  - redis
  - influxdb
  - grafana
  - backend (FastAPI)
  - celery-worker
  - celery-beat
```

---

## 📈 Grafana 대시보드

### 구현된 패널들

1. **주가 추이 차트**
   - 다중 종목 실시간 가격
   - 시계열 라인 차트

2. **기술지표 게이지**
   - RSI 게이지 (과매수/과매도 임계값)
   - 색상 코딩 (빨강/노랑/초록)

3. **포트폴리오 테이블**
   - 보유 종목별 손익
   - 수익률 색상 표시

4. **자산 배분 파이차트**
   - 종목별 비중
   - 실시간 업데이트

5. **AI 추천 테이블**
   - 매매 신호 목록
   - 신뢰도 점수 정렬

---

## 🧪 테스트 및 검증

### 단위 테스트 (예정)
```python
# pytest 기반 테스트
- API 엔드포인트 테스트
- 기술지표 계산 검증
- 신호 생성 로직 테스트
- 포트폴리오 계산 검증
```

### 성능 테스트 (예정)
```python
# Locust 기반 부하 테스트  
- 동시 사용자 처리 능력
- API 응답 시간 측정
- 데이터베이스 성능 검증
```

---

## 🚀 배포 계획

### 개발 환경
- Docker Compose 로컬 실행
- 개발용 데이터베이스 (SQLite 옵션)

### 프로덕션 환경 (계획)
- **클라우드**: AWS/GCP
- **컨테이너**: Kubernetes 오케스트레이션  
- **데이터베이스**: AWS RDS PostgreSQL + TimescaleDB
- **캐시**: AWS ElastiCache Redis
- **모니터링**: CloudWatch + Grafana Cloud
- **CI/CD**: GitHub Actions

---

## 📝 개발 로그

### 2025-08-29 개발 완료 항목

✅ **프로젝트 구조 설정**
- 마이크로서비스 아키텍처 구성
- Docker Compose 환경 구축

✅ **데이터베이스 설계** 
- PostgreSQL + TimescaleDB 스키마
- 인덱스 최적화 및 트리거 설정

✅ **사용자 관리 서비스**
- JWT 인증 시스템
- 포트폴리오 CRUD 기능
- 실시간 대시보드

✅ **주식 데이터 서비스**
- Yahoo Finance 연동
- 기술지표 계산 엔진
- 시장 스크리닝 기능

✅ **AI 추천 시스템**  
- 모멘텀 기반 알고리즘
- 신뢰도 점수 계산
- 패턴 발견 프레임워크

✅ **백그라운드 작업**
- Celery 스케줄링
- 일일 데이터 수집 자동화

✅ **모니터링 대시보드**
- Grafana 설정
- 실시간 차트 및 지표

✅ **단독 데모 버전**
- Python 데모 스크립트  
- SQLite 기반 경량 버전

---

## 🔄 향후 개발 계획

### Phase 2 (예정)
- [ ] 웹 프론트엔드 (React/Vue.js)
- [ ] 고급 백테스팅 엔진
- [ ] 딥러닝 예측 모델 (LSTM)
- [ ] 리스크 관리 (VaR, 포트폴리오 최적화)

### Phase 3 (예정)  
- [ ] 모바일 앱 개발
- [ ] 소셜 트레이딩 기능
- [ ] 뉴스 감성 분석
- [ ] 고빈도 거래 지원

---

## 💡 기술적 챌린지 및 해결책

### 1. 데이터 수집 안정성
**문제**: Yahoo Finance API 제한 및 오류
**해결**: 재시도 로직, 백업 데이터 소스 계획

### 2. 시계열 데이터 성능  
**문제**: 대량 주가 데이터 처리
**해결**: TimescaleDB 하이퍼테이블 활용

### 3. 실시간 업데이트
**문제**: 다중 사용자 실시간 데이터 동기화
**해결**: Redis 캐시 + WebSocket (계획)

### 4. AI 모델 정확도
**문제**: 단순한 추천 알고리즘
**해결**: 딥러닝 모델 도입 계획

---

## 📚 참고 자료

### 금융 이론
- Efficient Market Hypothesis
- Modern Portfolio Theory  
- Technical Analysis Principles
- Risk Management Strategies

### 기술 문서
- FastAPI Documentation
- TimescaleDB Best Practices
- Grafana Dashboard Design
- Celery Task Queue Patterns

### 오픈소스 라이브러리
- TA-Lib Technical Analysis
- yfinance Yahoo Finance API
- Backtrader Trading Framework
- Zipline Algorithmic Trading

---

## ⚠️ 면책조항

이 시스템은 **교육 및 연구 목적**으로 개발되었습니다. 

- 실제 투자 결정에 사용하기 전에 충분한 검토 필요
- AI 추천은 참고용으로만 활용
- 투자 손실에 대한 책임은 사용자에게 있음
- 금융 규제 준수 확인 필요

---

**문서 작성**: Claude Code Assistant  
**최종 수정**: 2025-08-29  
**버전**: v1.0.0