# Git 저장소 정리, CI/CD 구축 및 환경 설정 개선

**작업일**: 2025-10-09
**작업 구분**: 개발
**관련 Phase**: Phase 3 (Git & CI/CD) + 로컬 환경 설정 개선

---

## 📋 작업 개요

Git 저장소를 정리하고 GitHub Actions 기반 CI/CD 파이프라인을 구축했습니다. 또한 개발/운영 환경 차이로 인한 문제 해결 방법을 문서화하고, 로컬 개발 환경의 Docker 네트워크 설정을 수정했습니다.

### 작업 목표
1. ✅ Git 저장소 정리 (불필요한 파일 제거, .gitignore 업데이트)
2. ✅ Phase 1-2 변경사항 커밋
3. ✅ GitHub Actions CI/CD 파이프라인 구축
4. ✅ 자동 배포 아키텍처 가이드 문서화
5. ✅ 환경별 디버깅 전략 가이드 문서화
6. ✅ CORS 설정 개선
7. ✅ 로컬 환경 Docker 네트워크 설정 수정

---

## 🔧 주요 작업 내용

### 1. Git 저장소 정리 및 Phase 3 완료

#### 1.1 .gitignore 업데이트

**.gitignore 개선 사항**
```gitignore
# 환경 변수 파일
.env
.env.development
.env.production
!.env.example
!.env.*.example

# 데이터베이스 백업
*.sql
stocktrading_backup*.sql

# Celery
celerybeat-schedule
celerybeat-schedule.db

# 배포 파일 (루트만 제외, docs/deployment는 포함)
/deployment/
*.tar.gz

# 임시 파일
1wT/
temp_*.json

# Office 파일
*.pptx
*.xlsx
*.docx
```

**주요 개선**
- 환경 변수 파일 제외 (보안)
- 배포 패키지 제외 (용량)
- docs/deployment는 포함 (문서는 Git 추적)

#### 1.2 문서 재구조화

**삭제된 파일 (30개 이상)**
- 루트의 개별 MD 파일들 (중복 문서)
- stock-trading-system/ 내부의 구 문서들
- 중복된 가이드 및 매뉴얼 파일

**정리된 구조**
```
docs/
├── architecture/          # 아키텍처 문서 (4개)
├── deployment/           # 배포 문서 (3개)
├── development-logs/     # 개발 로그 (12개)
├── guides/              # 가이드 (155개)
│   ├── Git자동배포아키텍처-가이드-20251009.md ⭐
│   └── 환경별디버깅및배포전략-가이드-20251009.md ⭐
├── planning/            # 기획 문서 (5개)
├── strategies/          # 전략 문서 (3개)
├── user-manuals/        # 사용자 매뉴얼 (11개)
└── work-summaries/      # 작업 요약 (4개)
```

**총 문서 수**: 197개

#### 1.3 주요 커밋

**커밋 1: Phase 1-2 환경 분리 및 Docker Compose 구조 개선**
```
커밋 해시: a9fd480
변경 파일: 184 files, +12067/-496 lines
```

**주요 변경사항**
- Pydantic Settings 기반 config.py 전환
- Docker Compose Override 패턴 도입
- 환경별 .env 파일 지원
- 문서 구조화

**커밋 2: GitHub Actions CI/CD 파이프라인 구축**
```
커밋 해시: ee09969
변경 파일: 2 files, +313 lines
```

**주요 변경사항**
- `.github/workflows/deploy.yml` 생성
- `.github/workflows/README.md` 생성
- main 브랜치 Push 시 자동 배포
- 102, 101 서버 순차 배포
- Health Check 자동화

**커밋 3: Phase 3 CI/CD 파이프라인 구축 문서 추가**
```
커밋 해시: a65b765
변경 파일: 4 files, +1792/-2 lines
```

**커밋 4: Git 자동 배포 아키텍처 가이드 추가**
```
커밋 해시: 4fa3f35
변경 파일: 2 files, +1266 lines
```

**커밋 5: 환경별 디버깅 전략 가이드 및 CORS 설정 개선**
```
커밋 해시: 04ea766
변경 파일: 4 files, +894 lines
```

---

### 2. GitHub Actions CI/CD 파이프라인 구축

#### 2.1 워크플로우 파일

**`.github/workflows/deploy.yml`**

**배포 흐름**
```
로컬 개발 → git push → GitHub Actions 트리거
    ↓
Job 1: 102 서버 (Backend/Celery) 배포
    ↓ 성공 시
Job 2: 101 서버 (Scheduler/Grafana) 배포
    ↓ 성공 시
Job 3: Health Check
    ↓
배포 완료 ✅
```

**Job 1: deploy-102-backend**
```yaml
- name: Checkout code
- name: Setup SSH key
- name: Deploy to 102 Server
  - git pull origin main
  - docker-compose down
  - docker-compose build
  - docker-compose up -d
  - 컨테이너 상태 확인
```

**Job 2: deploy-101-scheduler**
```yaml
needs: deploy-102-backend  # 102 서버 성공 후 실행
- name: Deploy to 101 Server
  - 동일한 배포 프로세스
```

**Job 3: health-check**
```yaml
needs: [deploy-102-backend, deploy-101-scheduler]
- name: Check Backend API
  curl http://192.168.219.102:8000/health
- name: Check Grafana
  curl http://192.168.219.101:3000/api/health
```

#### 2.2 필수 설정

**GitHub Secrets**
- `SSH_PRIVATE_KEY`: 서버 SSH 접속용 Private Key

**서버 사전 작업**
1. Git 저장소 Clone
   ```bash
   cd ~
   git clone https://github.com/chohkcloud/happystocklife.git stock-trading-system
   ```

2. .env.production 파일 생성
   ```bash
   cp stock-trading-system/.env.production.example \
      stock-trading-system/.env.production
   nano stock-trading-system/.env.production
   ```

3. SSH Public Key 등록
   ```bash
   ssh-copy-id hansol@192.168.219.102
   ssh-copy-id hansol@192.168.219.101
   ```

---

### 3. Git 자동 배포 아키텍처 가이드 작성

#### 3.1 문서 정보

**파일**: `docs/guides/Git자동배포아키텍처-가이드-20251009.md`
**분량**: 1,266 라인 (약 12,000 단어)

#### 3.2 주요 섹션

**1. 전체 아키텍처**
- 시스템 목적
- 핵심 기술 스택
- 3대 서버 역할
- 아키텍처 다이어그램 (ASCII)

```
로컬 PC → GitHub → GitHub Actions Runner
    ↓ SSH        ↓ SSH
  102 서버    101 서버
    ↓           ↓
  103 서버 (Database)
```

**2. 구성 요소 상세 설명**
- 로컬 개발 환경 (Windows PC)
- GitHub Repository
- GitHub Actions Runner
- 운영 서버 (101, 102)

**3. 배포 흐름 상세**
- 전체 타임라인 (T+0s ~ T+5m30s)
- Step-by-Step 가이드 (6단계)
  1. Git Push (로컬 → GitHub)
  2. GitHub Actions 시작
  3. SSH 설정
  4. 102 서버 배포
  5. 101 서버 배포
  6. Health Check

**4. 환경 설정**
- 환경 변수 관리 전략
- config.py 구조
- Docker Compose 오버라이드

**5. 보안 및 인증**
- SSH Key 관리
- 환경 변수 보안
- 네트워크 보안

**6. 문제 해결**
- SSH 연결 실패
- Docker Build 실패
- Health Check 실패
- 배포 롤백 방법

**7. 베스트 프랙티스**
- 배포 전 체크리스트
- Feature Branch 전략
- 모니터링 및 알림
- 성능 최적화
- 보안 강화

---

### 4. 환경별 디버깅 및 배포 전략 가이드 작성

#### 4.1 문서 정보

**파일**: `docs/guides/환경별디버깅및배포전략-가이드-20251009.md`
**분량**: 894 라인
**작성 동기**: 사용자의 2가지 질문에 대한 완벽한 답변

#### 4.2 질문 1: 운영 환경 직접 수정 문제

**문제 시나리오**
```
개발 PC에서 정상 → 운영 배포 후 에러 발생
→ 운영 서버에서 직접 코드 수정으로 해결
→ 개발 PC에서 git push → 자동 배포
→ 운영 서버의 직접 수정 내용 덮어씀 → 다시 에러 발생!
```

**해결 방법**

**방법 1: 운영 수정 내용을 Git으로 가져오기 (권장)**
```bash
# 운영 서버에서
git diff > /tmp/hotfix.patch

# 로컬 PC에서
scp hansol@192.168.219.102:/tmp/hotfix.patch .
git apply hotfix.patch
git commit -m "fix: 운영 핫픽스 반영"
git push origin main
```

**방법 2: 운영 서버에서 직접 커밋 & Push (긴급)**
```bash
# 운영 서버에서
git add .
git commit -m "hotfix: 긴급 수정"
git push origin main

# 로컬 PC에서 반드시
git pull origin main
```

**방법 3: Staging 환경 구축 (근본 해결)**
```
개발 → Staging (운영과 동일 설정) → 운영
```

#### 4.3 질문 2: 운영에서만 발생하는 CORS 에러

**원인 분석**

이미 구현된 CORS 설정 (config.py):
```python
@property
def CORS_ORIGINS(self) -> list:
    if self.ENVIRONMENT == "production":
        return [
            self.FRONTEND_URL,    # http://192.168.219.101:3000
            self.GRAFANA_URL,     # http://192.168.219.101:3000
            self.AIRFLOW_URL,     # http://192.168.219.101:8080
        ]
    else:
        return ["*"]  # 개발: 모든 Origin 허용
```

**문제 발생 이유**
1. `.env.production`의 URL이 정확하지 않음 (포트 누락 등)
2. 실제 요청 Origin과 설정된 Origin이 다름

**해결 방법**

1. **실제 요청 Origin 확인**
   - 브라우저 개발자 도구 → Network → Headers → Origin

2. **서버 .env.production 수정**
   ```env
   FRONTEND_URL=http://192.168.219.101:3000
   GRAFANA_URL=http://192.168.219.101:3000
   AIRFLOW_URL=http://192.168.219.101:8080
   ```

3. **추가 Origin 필요 시 (새로 구현!)**
   ```env
   EXTRA_CORS_ORIGINS=http://example.com,https://app.com
   ```

4. **컨테이너 재시작**
   ```bash
   docker-compose restart backend
   ```

#### 4.4 기타 섹션

- 올바른 배포 워크플로우
- 환경별 디버깅 전략
- 긴급 핫픽스 프로세스
- 배포 전 체크리스트

---

### 5. CORS 설정 개선

#### 5.1 config.py 개선

**변경 전**
```python
@property
def CORS_ORIGINS(self) -> list:
    if self.ENVIRONMENT == "production":
        return [
            self.FRONTEND_URL,
            self.GRAFANA_URL,
            self.AIRFLOW_URL,
        ]
    return ["*"]
```

**변경 후**
```python
# 환경 변수 추가
EXTRA_CORS_ORIGINS: Optional[str] = None

@property
def CORS_ORIGINS(self) -> list:
    if self.ENVIRONMENT == "production":
        origins = [
            self.FRONTEND_URL,
            self.GRAFANA_URL,
            self.AIRFLOW_URL,
        ]

        # 추가 CORS Origin 지원
        if self.EXTRA_CORS_ORIGINS:
            extra = [origin.strip() for origin in self.EXTRA_CORS_ORIGINS.split(',')]
            origins.extend(extra)

        return origins
    return ["*"]
```

#### 5.2 .env.production.example 업데이트

**추가된 섹션**
```env
# ========================================
# CORS (추가 Origin이 필요한 경우)
# ========================================
# 쉼표로 구분하여 추가 Origin 설정 (선택 사항)
# 예: EXTRA_CORS_ORIGINS=http://example.com:3000,https://app.example.com
EXTRA_CORS_ORIGINS=
```

**장점**
- 코드 수정 없이 환경 변수로 CORS Origin 추가 가능
- 운영 환경에서 유연한 설정 가능

---

### 6. 로컬 환경 Docker 네트워크 설정 수정

#### 6.1 문제 발견

**로그인 시도 시 에러 발생**
```
POST http://localhost:8000/api/v1/users/token 500 (Internal Server Error)
SyntaxError: Unexpected token 'I', "Internal S"... is not valid JSON
```

**Backend 로그 확인**
```
sqlalchemy.exc.OperationalError: connection to server at "localhost" (::1),
port 5435 failed: Connection refused
```

**원인**: Backend 컨테이너가 `localhost:5435`로 DB 연결 시도
- ❌ Docker 컨테이너 내부에서 `localhost`는 자기 자신을 의미
- ✅ PostgreSQL은 `stock-db` 컨테이너에 있음
- ✅ Docker 네트워크에서는 서비스명을 사용해야 함

#### 6.2 .env.development 수정

**변경 전**
```env
# ❌ 잘못된 설정
DB_HOST=localhost
DB_PORT=5435       # 호스트 포트 매핑
REDIS_HOST=localhost
REDIS_PORT=6380
INFLUXDB_URL=http://localhost:8086
```

**변경 후**
```env
# ✅ 올바른 설정
DB_HOST=postgres   # Docker Compose 서비스명
DB_PORT=5432       # 컨테이너 내부 포트
REDIS_HOST=redis
REDIS_PORT=6379
INFLUXDB_URL=http://influxdb:8086
```

#### 6.3 Docker 네트워크 이해

**호스트 포트 매핑 vs 컨테이너 내부 포트**

```yaml
services:
  postgres:
    ports:
      - "5435:5432"  # 호스트:컨테이너
```

**외부(호스트 PC)에서 접속**:
- `localhost:5435` ✅

**컨테이너 내부에서 접속**:
- `postgres:5432` ✅ (서비스명:내부포트)
- `localhost:5435` ❌ (틀림!)

#### 6.4 문제 해결 과정

1. **Backend 로그 확인**
   ```bash
   docker-compose logs backend --tail=50
   ```

2. **.env.development 수정**
   - DB_HOST, REDIS_HOST, INFLUXDB_URL 변경

3. **컨테이너 재시작**
   ```bash
   docker-compose down
   docker-compose up -d
   ```
   - ⚠️ `docker-compose restart`는 환경 변수를 재로드하지 않음!
   - ✅ `down` 후 `up`으로 완전히 재시작 필요

4. **Health Check**
   ```bash
   curl http://localhost:8000/health
   # {"status":"healthy"} ✅
   ```

#### 6.5 결과

**✅ 모든 서비스 정상 작동**
- Database 연결: ✅
- Backend API: ✅
- 로그인 기능: ✅
- Health Check: ✅

---

## 📊 작업 결과

### Git 커밋 이력

```
04ea766 feat: 환경별 디버깅 전략 가이드 및 CORS 설정 개선
4fa3f35 docs: Git 자동 배포 아키텍처 가이드 추가 및 INDEX 업데이트
a65b765 docs: Phase 3 CI/CD 파이프라인 구축 문서 추가
ee09969 feat: GitHub Actions CI/CD 파이프라인 구축
a9fd480 feat: Phase 1-2 환경 분리 및 Docker Compose 구조 개선
```

### 생성/수정된 파일

**CI/CD 관련**
- `.github/workflows/deploy.yml` (신규)
- `.github/workflows/README.md` (신규)

**문서**
- `docs/guides/Git자동배포아키텍처-가이드-20251009.md` (신규, 1,266 라인)
- `docs/guides/환경별디버깅및배포전략-가이드-20251009.md` (신규, 894 라인)
- `docs/deployment/CICD파이프라인구축-개발-20251009.md` (신규)
- `docs/INDEX.md` (업데이트)

**코드 개선**
- `stock-trading-system/backend/config.py` (CORS 개선)
- `stock-trading-system/.env.production.example` (CORS 예시 추가)
- `stock-trading-system/.env.development` (Docker 네트워크 설정 수정)

**Git 관리**
- `.gitignore` (개선)

### 문서 통계

**총 문서 수**: 197개
- 아키텍처: 4개
- 배포 문서: 3개
- 개발 로그: 13개 (이 문서 포함)
- 가이드: 155개
- 사용자 매뉴얼: 11개
- 작업 요약: 4개
- 계획 문서: 5개
- 전략 문서: 3개

---

## 🎯 달성한 목표

### Phase 3 완료 ✅

- [x] Git 저장소 정리
  - [x] .gitignore 업데이트
  - [x] 불필요한 파일 제거 (30개 이상)
  - [x] 문서 재구조화

- [x] 변경사항 커밋
  - [x] Phase 1-2 변경사항 커밋
  - [x] 의미 있는 커밋 메시지 작성
  - [x] Co-Authored-By 추가

- [x] GitHub 연동
  - [x] 기존 저장소 확인
  - [x] Push 성공 (5회)

- [x] CI/CD 파이프라인 구축
  - [x] GitHub Actions 워크플로우 작성
  - [x] 자동 배포 설정
  - [x] Health Check 자동화
  - [x] 설정 가이드 문서화

### 추가 달성 목표 ✅

- [x] 환경별 디버깅 전략 수립
  - [x] 운영 직접 수정 문제 해결 방법 3가지
  - [x] CORS 에러 해결 방법
  - [x] 올바른 배포 워크플로우 정립

- [x] CORS 설정 개선
  - [x] EXTRA_CORS_ORIGINS 지원 추가
  - [x] 환경 변수로 유연한 설정 가능

- [x] 로컬 환경 문제 해결
  - [x] Docker 네트워크 설정 수정
  - [x] 데이터베이스 연결 복구
  - [x] 로그인 기능 정상화

---

## 📝 배운 점 및 주의사항

### Docker 네트워크

**핵심 교훈**
```
호스트에서 접속: localhost:5435
컨테이너에서 접속: postgres:5432
```

**왜 다른가?**
- `5435:5432`는 **포트 매핑** (호스트:컨테이너)
- 호스트 PC에서는 `localhost:5435`로 접속
- 컨테이너 내부에서는 `서비스명:내부포트` 사용

**실수하기 쉬운 경우**
```env
# ❌ 개발 환경에서 흔한 실수
DB_HOST=localhost
DB_PORT=5435

# ✅ 올바른 설정 (Docker Compose 사용 시)
DB_HOST=postgres
DB_PORT=5432
```

### Git 워크플로우

**올바른 흐름**
```
1. 개발 PC에서 개발
2. git commit
3. git push origin main
4. GitHub Actions 자동 배포
5. 운영 서버 업데이트
```

**절대 하지 말아야 할 것**
```
❌ 운영 서버에서 직접 코드 수정만 하고 끝
❌ Git에 반영하지 않은 상태로 방치
```

**긴급 상황 대응**
```
1. 운영 서버에서 긴급 수정
2. 즉시 Git에 반영 (2가지 방법)
   - 방법 1: 로컬로 패치 가져와서 커밋
   - 방법 2: 운영 서버에서 직접 커밋 & Push
3. 로컬 PC에서 git pull
```

### CORS 설정

**환경별 차이**
```python
# 개발 환경
CORS_ORIGINS = ["*"]  # 모든 Origin 허용

# 운영 환경
CORS_ORIGINS = [
    "http://192.168.219.101:3000",  # 정확한 URL (포트까지!)
    "http://192.168.219.101:8080",
]
```

**주의사항**
- ⚠️ 프로토콜 일치 (http vs https)
- ⚠️ 포트 정확히 명시
- ⚠️ 도메인 스펠링 정확히

---

## 🚀 다음 단계

### Phase 4: 실제 서버 배포 테스트

**준비 작업**
1. GitHub Secrets 설정
   - SSH_PRIVATE_KEY 등록

2. 서버 사전 작업
   - Git 저장소 Clone
   - .env.production 파일 생성
   - SSH Key 등록

3. 첫 번째 자동 배포 테스트
   - 간단한 변경사항 Push
   - GitHub Actions 로그 확인
   - 서버 배포 결과 확인

### 추가 개선 사항

- [ ] Staging 환경 구축
- [ ] 롤백 자동화
- [ ] Slack/Discord 알림 연동
- [ ] 배포 전 테스트 자동화 (Unit Test, Integration Test)
- [ ] Blue-Green 배포 전략 검토
- [ ] 로그 수집 및 모니터링 강화

---

## 📚 관련 문서

### 가이드 문서
- [Git자동배포아키텍처-가이드-20251009.md](../guides/Git자동배포아키텍처-가이드-20251009.md) - ⭐ 전체 아키텍처 완벽 가이드
- [환경별디버깅및배포전략-가이드-20251009.md](../guides/환경별디버깅및배포전략-가이드-20251009.md) - ⭐ 환경 차이 해결 전략

### 배포 문서
- [CICD환경분리전략-가이드-20251009.md](../deployment/CICD환경분리전략-가이드-20251009.md) - Phase 1-2 환경 분리
- [CICD파이프라인구축-개발-20251009.md](../deployment/CICD파이프라인구축-개발-20251009.md) - Phase 3 작업 상세

### 기타
- [3서버Docker분산배포-개발-20251008.md](./3서버Docker분산배포-개발-20251008.md) - 3서버 분산 아키텍처
- [3서버분산배포DB마이그레이션-개발-20251009.md](./3서버분산배포DB마이그레이션-개발-20251009.md) - DB 마이그레이션

---

## 🔍 문제 해결 이력

### 문제 1: 로그인 시 500 에러

**증상**
```
POST http://localhost:8000/api/v1/users/token 500 (Internal Server Error)
SyntaxError: Unexpected token 'I', "Internal S"... is not valid JSON
```

**원인**
```
Backend 컨테이너가 localhost:5435로 DB 연결 시도
→ 컨테이너 내부에서 localhost는 자기 자신
→ PostgreSQL 컨테이너를 찾지 못함
```

**해결**
```
.env.development 수정:
DB_HOST=localhost → postgres
DB_PORT=5435 → 5432
```

**교훈**
- Docker Compose 네트워크에서는 서비스명 사용
- 호스트 포트 매핑 ≠ 컨테이너 내부 포트
- `docker-compose restart`는 환경 변수 재로드 안 함 → `down` 후 `up` 필요

### 문제 2: 환경 변수 재로드 안 됨

**증상**
```
.env.development 수정 후 docker-compose restart 했는데도
같은 에러 계속 발생
```

**원인**
```
docker-compose restart는 기존 컨테이너를 재시작만 함
환경 변수는 컨테이너 생성 시점에 로드됨
```

**해결**
```bash
# ❌ 환경 변수 재로드 안 됨
docker-compose restart

# ✅ 환경 변수 재로드
docker-compose down
docker-compose up -d
```

**교훈**
- 환경 변수 변경 시 반드시 `down` 후 `up`
- `restart`는 프로세스만 재시작

---

## 요약

### 핵심 성과

1. **CI/CD 자동화 구축** ✅
   - Git Push만으로 운영 서버 자동 배포
   - 5~7분 내 배포 완료
   - Health Check 자동화

2. **완벽한 가이드 문서화** ✅
   - Git 자동 배포 아키텍처 (1,266 라인)
   - 환경별 디버깅 전략 (894 라인)
   - 실무 적용 가능한 구체적 예시

3. **로컬 환경 안정화** ✅
   - Docker 네트워크 설정 수정
   - 데이터베이스 연결 복구
   - 로그인 기능 정상화

### 코드 품질 향상

- 환경 변수 분리 (개발/운영)
- CORS 설정 유연성 증가
- Git 이력 정리 및 표준화
- 문서 구조화 (197개 문서 체계 정립)

### 배포 프로세스 개선

**Before**
```
수동 배포: 서버 접속 → 파일 전송 → 재시작 → 검증
소요 시간: 15~30분
에러 가능성: 높음
```

**After**
```
자동 배포: git push → GitHub Actions → 자동 배포 → Health Check
소요 시간: 5~7분
에러 가능성: 낮음 (자동화된 프로세스)
```

---

**작성일**: 2025-10-09
**작성자**: HSL Trading System + Claude Code
**문서 버전**: 1.0
**GitHub 저장소**: https://github.com/chohkcloud/happystocklife
**최신 커밋**: 04ea766
