# Stock Trading System Dashboard Fixes Log

## 작업 개요
날짜: 2025-09-21
목적: Grafana 대시보드들의 데이터 표시 문제 및 종목 선택 문제 해결

## 해결된 문제들

### 1. Korean Stock Analysis Dashboard 데이터 표시 문제

**문제**: 메인 가격차트는 표시되지만 기술지표 차트들이 전혀 표시되지 않음

**원인 분석**:
- 복잡한 CTE 쿼리로 인한 SQL 에러
- 하드코딩된 datasource UID 사용
- 잘못된 Grafana 시간 매크로 문법 (`'$__timeFrom()'` 대신 `$__timeFrom()` 사용해야 함)
- 기술지표 데이터가 여러 `indicator_id`에 분리 저장되어 통합 조회 불가

**해결 방안**:

#### 1.1 Datasource 설정 수정
```json
// 이전 (하드코딩)
"uid": "PCC52D03280B7034C"

// 수정후 (동적 참조)
"uid": "${DS_POSTGRESQL}"
```

#### 1.2 시간 매크로 문법 수정
```sql
-- 이전 (잘못된 문법)
WHERE date >= '$__timeFrom()' AND date <= '$__timeTo()'

-- 수정후 (올바른 문법)
WHERE date >= $__timeFrom() AND date <= $__timeTo()
```

#### 1.3 기술지표 쿼리 간소화
복잡한 CTE 계산식을 기존 계산된 데이터 활용으로 변경:

**Moving Averages**:
```sql
-- 이전: 복잡한 Window 함수 계산
WITH price_ma AS (
  SELECT date, close_price,
    AVG(close_price) OVER (ORDER BY date ROWS BETWEEN 19 PRECEDING AND CURRENT ROW) AS ma20,
    AVG(close_price) OVER (ORDER BY date ROWS BETWEEN 49 PRECEDING AND CURRENT ROW) AS ma50
  FROM stock_prices...
)

-- 수정후: 기존 계산된 데이터 활용
SELECT
  sp.date AS time,
  sp.close_price AS "Close",
  (iv.value::json->>'sma_20')::float AS "SMA 20",
  (iv.value::json->>'sma_50')::float AS "SMA 50"
FROM stock_prices sp
LEFT JOIN indicator_values iv ON sp.ticker = iv.ticker AND sp.date = iv.date
```

**RSI**:
```sql
-- 이전: 복잡한 RSI 계산 로직 (30줄+ CTE)
-- 수정후: 단순 조회
SELECT
  iv.date AS time,
  (iv.value::json->>'rsi')::float AS "RSI"
FROM indicator_values iv
WHERE iv.ticker = '$ticker'
  AND (iv.value::json->>'rsi') IS NOT NULL
```

#### 1.4 통합 지표 데이터 생성
`indicator_id = 1`에 모든 기본 지표를 통합 저장:

```python
# fix_combined_indicators.py 스크립트 생성
def calculate_all_basic_indicators(df):
    indicators = {}
    # SMA, RSI, MACD, Bollinger Bands 모두 계산
    indicators['sma_20'] = talib.SMA(df['close'], timeperiod=20).iloc[-1]
    indicators['rsi'] = talib.RSI(df['close'], timeperiod=14).iloc[-1]
    macd, signal, hist = talib.MACD(df['close'])
    indicators['macd'] = macd.iloc[-1]
    # ... 모든 지표 통합
    return indicators
```

**최종 데이터 구조**:
```json
{
  "sma_5": 78860.0, "sma_10": 75730.0, "sma_20": 72755.0, "sma_50": 70344.0,
  "rsi": 72.01,
  "macd": 2675.77, "macd_signal": 1791.90, "macd_hist": 883.87,
  "bb_upper": 79234.56, "bb_middle": 72755.0, "bb_lower": 66275.44
}
```

### 2. Enhanced Stock Analysis Dashboard 종목 선택 문제

**문제**: 종목코드가 5개밖에 선택할 수 없음

**원인**: ORDER BY 절에서 특정 종목들만 우선순위 부여

**해결**:
```sql
-- 이전: 5개 종목만 우선 표시
ORDER BY CASE
  WHEN ticker = '005930' THEN 1
  WHEN ticker = '000660' THEN 2
  WHEN ticker = '035420' THEN 3
  ELSE 4
END, company_name

-- 수정후: 모든 종목 표시
ORDER BY company_name
```

### 3. Technical Indicators Dashboard 동적 종목 선택

**문제**: 삼성전자만 하드코딩되어 표시

**해결**: 종목 선택 변수 추가 및 모든 쿼리에 동적 종목 적용

```json
// templating 섹션에 ticker 변수 추가
{
  "name": "ticker",
  "type": "query",
  "definition": "SELECT ticker AS __value, ticker || ' - ' || company_name AS __text FROM stocks...",
  "current": {"text": "005930 - 삼성전자", "value": "005930"}
}
```

## 수정된 파일 목록

### 1. Dashboard 설정 파일
- `F:\hhstock\stock-trading-system\monitoring\grafana\dashboards\korean-stock-candlestick.json`
  - 모든 기술지표 쿼리 간소화
  - Datasource UID 동적 참조로 변경
  - 시간 매크로 문법 수정

- `F:\hhstock\stock-trading-system\monitoring\grafana\dashboards\korean-stock-simple.json`
  - Datasource UID 수정
  - 시간 매크로 문법 수정

- `F:\hhstock\stock-trading-system\monitoring\grafana\dashboards\enhanced-dashboard.json`
  - 종목 선택 쿼리 ORDER BY 절 수정
  - 모든 datasource 참조를 동적으로 변경

- `F:\hhstock\stock-trading-system\updated-technical-indicators-dashboard.json`
  - 동적 종목 선택 기능 추가

### 2. 백엔드 스크립트
- `F:\hhstock\stock-trading-system\backend\simple_indicator_update.py`
  - 모든 기본 지표를 하나의 레코드에 통합 저장하도록 수정

- `F:\hhstock\stock-trading-system\backend\fix_combined_indicators.py` (신규 생성)
  - 삼성전자 통합 지표 데이터 수동 생성 스크립트

## 기술 세부사항

### Grafana 설정
- **Datasource 변수**: `${DS_POSTGRESQL}` 사용으로 환경별 동적 연결
- **시간 매크로**: `$__timeFrom()`, `$__timeTo()` 올바른 문법 적용
- **Template Variables**: 동적 종목 선택을 위한 query 타입 변수 활용

### 데이터베이스 최적화
- **indicator_values 테이블**: `indicator_id = 1`에 모든 기본 지표 통합
- **JSON 필드 활용**: 여러 지표 값을 하나의 JSON 객체로 저장
- **인덱스 활용**: ticker, date, indicator_id 복합 인덱스로 빠른 조회

### 성능 개선
- **복잡한 CTE 제거**: 실시간 계산 대신 사전 계산된 데이터 활용
- **JOIN 최소화**: LEFT JOIN으로 필요한 데이터만 조회
- **쿼리 단순화**: Window 함수 계산을 JSON 필드 추출로 변경

## 테스트 결과

### 1. Korean Stock Analysis Dashboard
✅ Candlestick Chart: 정상 표시
✅ Moving Averages: SMA 20, 50 정상 표시
✅ RSI: 0-100 범위 정상 표시
✅ MACD: MACD, Signal, Histogram 정상 표시
✅ Stochastic Oscillator: %K 값 정상 표시
✅ Bollinger Bands: Upper, Middle, Lower bands 정상 표시

### 2. Enhanced Stock Analysis Dashboard
✅ 전체 종목 선택 가능 (2,766개 종목)
✅ 종목명과 함께 표시 (예: "005930 - 삼성전자")
✅ 알파벳순 정렬로 검색 용이

### 3. Technical Indicators Dashboard
✅ 동적 종목 선택 기능
✅ 선택한 종목에 따른 차트 변경

## 향후 개선 사항

1. **자동화된 지표 계산**: 모든 종목에 대해 통합 지표 자동 생성
2. **실시간 업데이트**: 주가 데이터 입력 시 자동 지표 계산
3. **추가 기술지표**: Stochastic, Williams %R, CCI 등 추가
4. **성능 모니터링**: 대시보드 로딩 시간 최적화
5. **에러 핸들링**: 데이터 부족 시 graceful degradation

## 명령어 기록

```bash
# Grafana 재시작
docker-compose restart grafana

# 데이터베이스 조회 테스트
docker exec stock-db psql -U admin -d stocktrading -c "SELECT value FROM indicator_values WHERE ticker = '005930' AND indicator_id = 1"

# 통합 지표 데이터 생성
python backend/fix_combined_indicators.py
```

## 트러블슈팅 가이드

### 대시보드가 "No data" 표시하는 경우
1. Datasource 연결 확인: `${DS_POSTGRESQL}` 변수 설정
2. 시간 범위 확인: 데이터 존재 기간과 대시보드 시간 범위 일치
3. 종목 데이터 확인: 선택한 종목의 indicator_values 데이터 존재 여부

### 종목 선택이 제한되는 경우
1. ORDER BY 절 확인: 특정 종목 우선순위 제거
2. WHERE 절 확인: is_active = true 조건
3. JOIN 조건 확인: stock_prices 테이블과의 연관성

### 성능이 느린 경우
1. 복잡한 CTE 쿼리를 단순 JOIN으로 변경
2. 필요한 컬럼만 SELECT
3. 적절한 인덱스 활용

---
*마지막 업데이트: 2025-09-21*
*작업자: Claude Code Assistant*