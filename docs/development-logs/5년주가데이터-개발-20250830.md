# 작업 보고서: 한국 주식시장 5년 데이터 수집 시스템 구축
작성일: 2025-08-30

## 작업 개요
한국 증권거래소(KOSPI, KOSDAQ)에 상장된 모든 주식의 5년치 과거 데이터를 수집하고 데이터베이스에 저장하는 시스템을 구축했습니다.

## 시스템 아키텍처

### 데이터 수집 흐름
```
[KRX API (pykrx)] → [Data Fetcher] → [PostgreSQL/SQLite DB] → [FastAPI] → [Grafana]
```

## 구현 내용

### 1. 데이터 수집 모듈 (korea_stock_fetcher.py)

#### 주요 기능
- **전체 종목 수집**: KOSPI 약 900개, KOSDAQ 약 1,600개 종목
- **히스토리 데이터**: 5년간 일별 OHLCV (Open, High, Low, Close, Volume)
- **시장 구분**: KOSPI/KOSDAQ 자동 분류
- **기본 정보**: 시가총액, PER, PBR, 배당수익률

#### 핵심 메서드
```python
class KoreaStockFetcher:
    - get_all_tickers(): 전체 종목 리스트 수집
    - get_stock_info(): 종목 상세 정보 조회
    - fetch_historical_prices(): 과거 가격 데이터 수집
    - save_stock_to_db(): 종목 정보 DB 저장
    - save_prices_to_db(): 가격 데이터 DB 저장
    - fetch_and_save_all_stocks(): 전체 프로세스 실행
```

### 2. 데이터베이스 스키마 확장

#### 기존 모델 확장 (models.py)
```python
Stock 테이블:
- market_type: VARCHAR(20) # KOSPI/KOSDAQ 구분
- isin_code: VARCHAR(20) # 국제증권식별번호
- updated_at: TIMESTAMP # 업데이트 시간
```

#### 새로운 SQL 스키마 (korea_stock_schema.sql)
- 인덱스 최적화: ticker, date, market_type
- 뷰 생성: kospi_stocks, kosdaq_stocks
- Materialized View: daily_market_summary
- 함수: get_latest_prices(), calculate_moving_averages()

### 3. 실행 스크립트

#### fetch_korea_stocks.py
- 커맨드라인 인터페이스
- 인자 옵션:
  - `--years`: 수집할 연도 수 (기본: 5)
  - `--update-only`: 최근 데이터만 업데이트
  - `--days`: 업데이트 일수 (기본: 30)

#### fetch_korea_stocks.bat
- Windows 환경 원클릭 실행
- 가상환경 자동 설정
- 패키지 자동 설치

### 4. 라이브러리 의존성

#### 추가된 주요 패키지
```
pykrx==1.0.45       # 한국거래소 공식 데이터
beautifulsoup4      # HTML 파싱
lxml               # XML 처리
tqdm               # 진행상황 표시
```

## 데이터 규모

### 수집 대상
- **KOSPI**: 약 900개 종목
- **KOSDAQ**: 약 1,600개 종목
- **총 종목 수**: 약 2,500개

### 데이터 볼륨
- **기간**: 5년 (약 1,250 거래일)
- **레코드 수**: 약 3,125,000개 (2,500 × 1,250)
- **데이터 크기**: 약 500MB ~ 1GB

### 수집 시간
- **전체 수집**: 4-8시간 (네트워크 속도 의존)
- **일일 업데이트**: 10-30분
- **Rate Limiting**: 0.1초/요청

## 성능 최적화

### 1. 데이터베이스 최적화
- 복합 인덱스: (ticker, date)
- 파티셔닝 가능 구조
- Materialized View로 집계 성능 향상

### 2. 수집 프로세스 최적화
- ThreadPoolExecutor 활용 (max_workers=10)
- 배치 처리로 DB 트랜잭션 최소화
- 중복 체크로 불필요한 저장 방지

### 3. 에러 처리
- 개별 종목 실패 시 계속 진행
- 상세 로그 기록
- 재시도 메커니즘

## API 엔드포인트

### 새로운 엔드포인트
```
GET /api/stocks/list?market=KOSPI
GET /api/stocks/list?market=KOSDAQ
GET /api/stocks/{ticker}/prices?start_date=2020-01-01&end_date=2025-12-31
GET /api/stocks/{ticker}/indicators
```

## 모니터링 및 로깅

### 로그 파일
- 위치: `korea_stock_fetch_YYYYMMDD_HHMMSS.log`
- 레벨: INFO, WARNING, ERROR
- 실시간 콘솔 출력

### 진행 상황
- tqdm 프로그레스 바
- 처리된 종목 수 표시
- 예상 완료 시간

## 트러블슈팅

### 해결된 이슈
1. **pykrx API 제한**
   - 해결: Rate limiting (0.1초 딜레이)

2. **대용량 데이터 처리**
   - 해결: 배치 처리 및 트랜잭션 최적화

3. **중복 데이터 방지**
   - 해결: Upsert 패턴 구현

### 알려진 제한사항
1. 실시간 데이터는 별도 구현 필요
2. 거래 정지 종목 데이터 누락 가능
3. 상장폐지 종목 이력 미포함

## 사용 방법

### 초기 전체 수집
```bash
# Windows
fetch_korea_stocks.bat

# Python 직접 실행
python backend/fetch_korea_stocks.py --years 5
```

### 일일 업데이트
```bash
python backend/fetch_korea_stocks.py --update-only --days 1
```

### 스케줄링 설정
```bash
# Windows Task Scheduler
schtasks /create /tn "KoreaStockUpdate" /tr "F:\hhstock\stock-trading-system\fetch_korea_stocks.bat --update-only" /sc daily /st 18:00
```

## 데이터 검증

### 품질 체크
- NULL 값 확인
- 가격 범위 검증 (음수 방지)
- 거래량 검증
- 날짜 연속성 확인

### 통계 요약
```sql
-- 시장별 종목 수
SELECT market_type, COUNT(*) FROM stocks GROUP BY market_type;

-- 데이터 완성도
SELECT ticker, COUNT(*) as days FROM stock_prices GROUP BY ticker;
```

## 향후 개선 계획

### 단기 (1-2주)
- [ ] 실시간 데이터 WebSocket 연동
- [ ] 분봉 데이터 수집
- [ ] 테마/섹터 분류 추가

### 중기 (1-2개월)
- [ ] 재무제표 데이터 수집
- [ ] 외국인/기관 매매 데이터
- [ ] 공시 정보 연동

### 장기 (3-6개월)
- [ ] 옵션/선물 데이터
- [ ] 해외 시장 연동
- [ ] AI 기반 예측 모델

## 보안 고려사항

1. **API 키 관리**
   - .env 파일로 분리
   - 버전 관리 제외

2. **데이터 접근 제어**
   - 읽기 전용 계정 분리
   - API 레이트 리미팅

3. **백업 정책**
   - 일일 증분 백업
   - 주간 전체 백업

## 참고 자료

- [pykrx 공식 문서](https://github.com/sharebook-kr/pykrx)
- [한국거래소 정보데이터시스템](http://data.krx.co.kr)
- [SQLAlchemy ORM 문서](https://docs.sqlalchemy.org)

## 작업 완료 체크리스트

- [x] pykrx 기반 데이터 수집 모듈 구현
- [x] 데이터베이스 스키마 확장
- [x] KOSPI/KOSDAQ 분류 기능
- [x] 5년치 히스토리 데이터 수집
- [x] 배치 실행 스크립트
- [x] 에러 처리 및 로깅
- [x] 성능 최적화
- [x] 문서화

---
작성자: Stock Trading System Development Team
버전: 1.0.0