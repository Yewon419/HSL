# 주식 거래 시스템 사용자 매뉴얼
*Stock Trading System User Manual*

**작성일**: 2025-08-31  
**버전**: 1.0  

---

## 목차 (Table of Contents)

1. [시스템 개요](#시스템-개요)
2. [시스템 구성 요소](#시스템-구성-요소)
3. [시스템 시작하기](#시스템-시작하기)
4. [웹 애플리케이션 사용법](#웹-애플리케이션-사용법)
5. [Grafana 대시보드 사용법](#grafana-대시보드-사용법)
6. [PostgreSQL 데이터베이스 접속](#postgresql-데이터베이스-접속)
7. [기술적 지표 (Technical Indicators)](#기술적-지표-technical-indicators)
8. [주요 쿼리 예제](#주요-쿼리-예제)
9. [문제 해결 (Troubleshooting)](#문제-해결-troubleshooting)

---

## 시스템 개요

주식 거래 시스템은 한국 주식 시장의 기술적 분석을 위한 종합 플랫폼입니다. 1,981개 상장 종목의 5년간 주가 데이터와 36종류의 기술적 지표를 제공하며, 웹 인터페이스와 Grafana 대시보드를 통해 시각화됩니다.

### 주요 기능
- **주가 데이터 수집**: 1,981개 종목의 일일 주가 데이터 (OHLCV)
- **기술적 지표 계산**: 36종류 지표를 5개 카테고리로 분류
- **웹 애플리케이션**: Chart.js 기반 인터랙티브 차트
- **Grafana 대시보드**: 실시간 모니터링 및 분석
- **PostgreSQL 데이터베이스**: TimescaleDB 확장으로 최적화된 시계열 데이터

---

## 시스템 구성 요소

| 구성 요소 | 포트 | 설명 |
|-----------|------|------|
| FastAPI Backend | 8000 | REST API 서버 |
| Web Application | 8000 | 프론트엔드 (정적 파일) |
| Grafana | 3000 | 대시보드 및 시각화 |
| PostgreSQL | 5432 | 데이터베이스 |

### Docker 서비스
```yaml
services:
  - stock-backend: FastAPI 애플리케이션
  - stock-db: PostgreSQL 데이터베이스
  - grafana: Grafana 대시보드
  - stock-redis: 캐시 서버 (선택적)
```

---

## 시스템 시작하기

### 1. Docker 컨테이너 시작
```bash
# 프로젝트 디렉토리로 이동
cd F:\hhstock\stock-trading-system

# 모든 서비스 시작
docker-compose up -d

# 서비스 상태 확인
docker-compose ps
```

### 2. 서비스 확인
- **Backend API**: http://localhost:8000/health
- **Web Application**: http://localhost:8000/
- **Grafana**: http://localhost:3000/
- **API 문서**: http://localhost:8000/docs

### 3. 초기 설정 확인
```bash
# 데이터베이스 연결 확인
docker exec -it stock-db psql -U admin -d stocktrading -c "SELECT COUNT(*) FROM stocks;"

# 백엔드 로그 확인
docker logs stock-backend
```

---

## 웹 애플리케이션 사용법

### 접속 정보
- **URL**: http://localhost:8000/
- **테스트 계정**:
  - 사용자명: `testuser2`
  - 비밀번호: `password123`

### 주요 기능

#### 1. 종목 관리 탭
- **종목 추가**: 6자리 종목 코드 입력 (예: 005930)
- **종목 목록**: 등록된 종목의 현재 주가 및 기본 정보
- **새로고침**: 최신 데이터로 업데이트

#### 2. 기술적 지표 차트 탭
- **종목 선택**: 드롭다운에서 분석할 종목 선택
- **차트 로드**: 주가 차트와 이동평균선 표시
- **인터랙티브**: 차트 확대/축소, 데이터 포인트 확인

#### 3. 지표 분석 탭
- **지표 요약**: 주요 기술적 지표의 현재 값
- **카테고리별 분류**:
  - 이동평균 (SMA, EMA)
  - MACD 지표
  - 오실레이터 (RSI, Stochastic)
  - 변동성 지표 (Bollinger Bands, ATR)
  - 추세 지표 (ADX)

#### 4. 매매 신호 탭
- **신호 분석**: 각 지표별 매수/매도/중립 신호
- **종합 판단**: 전체 지표 기반 투자 의견
- **신호 강도**: 추세 강도 및 신뢰도 표시

### 사용 예제
```javascript
// 종목 코드 005930 (삼성전자) 추가
1. "종목 관리" 탭에서 "005930" 입력
2. "추가" 버튼 클릭
3. 종목 목록에서 삼성전자 확인

// 기술적 지표 차트 보기
1. "기술적 지표 차트" 탭 선택
2. 종목 선택에서 "005930 - 삼성전자" 선택
3. "차트 로드" 버튼 클릭
4. 주가 차트와 이동평균선 확인
```

---

## Grafana 대시보드 사용법

### 접속 정보
- **URL**: http://localhost:3000/
- **로그인 정보**:
  - 사용자명: `admin`
  - 비밀번호: `admin`

### 데이터소스 설정 (이미 구성됨)
```
Host: stock-db:5432
Database: stocktrading
User: admin
Password: your_password_here
SSL Mode: disable
```

### 주요 대시보드

#### 1. 주식 개요 대시보드 (Stock Overview)
- **패널 구성**:
  - 총 종목 수
  - 데이터 수집 현황
  - 최근 업데이트 시간
  - 상위 거래량 종목

#### 2. 기술적 지표 대시보드 (Technical Indicators)
- **RSI 히트맵**: 전 종목의 RSI 값을 색상으로 표시
- **MACD 신호**: MACD 크로스오버 신호 현황
- **볼린저 밴드**: 가격 대비 밴드 위치 분석

#### 3. 시장 분석 대시보드 (Market Analysis)
- **섹터별 성과**: 업종별 수익률 비교
- **거래량 분석**: 비정상적 거래량 탐지
- **변동성 모니터**: 높은 변동성 종목 식별

### 대시보드 사용법
```
1. 좌측 메뉴에서 "Dashboards" 클릭
2. 원하는 대시보드 선택
3. 시간 범위 설정 (우측 상단)
4. 변수 설정으로 특정 종목 필터링
5. 패널 클릭하여 상세 정보 확인
```

---

## PostgreSQL 데이터베이스 접속

### 연결 정보
- **호스트**: localhost (Docker 외부에서)
- **포트**: 5432
- **데이터베이스**: stocktrading
- **사용자**: admin
- **비밀번호**: (환경변수에서 확인)

### 명령줄 접속
```bash
# Docker 컨테이너 직접 접속
docker exec -it stock-db psql -U admin -d stocktrading

# 외부에서 psql 접속 (psql 클라이언트 설치 필요)
psql -h localhost -p 5432 -U admin -d stocktrading
```

### GUI 도구 설정 (DBeaver, pgAdmin)
```
Connection Type: PostgreSQL
Server: localhost
Port: 5432
Database: stocktrading
Username: admin
Password: [환경변수에서 확인]
```

### 주요 테이블 구조

#### 1. stocks (종목 정보)
```sql
CREATE TABLE stocks (
    ticker VARCHAR(10) PRIMARY KEY,
    company_name VARCHAR(100),
    sector VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. stock_prices (주가 데이터)
```sql
CREATE TABLE stock_prices (
    ticker VARCHAR(10),
    date DATE,
    open DECIMAL(10,2),
    high DECIMAL(10,2),
    low DECIMAL(10,2),
    close DECIMAL(10,2),
    volume BIGINT,
    PRIMARY KEY (ticker, date)
);
```

#### 3. indicator_values (기술적 지표)
```sql
CREATE TABLE indicator_values (
    ticker VARCHAR(10),
    date DATE,
    indicator_id INTEGER,
    timeframe VARCHAR(10) DEFAULT 'daily',
    value JSONB NOT NULL,
    parameters JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ticker, date, indicator_id, timeframe)
);
```

---

## 기술적 지표 (Technical Indicators)

### 지표 카테고리

#### 1. 추세 지표 (Trend Indicators)
| 지표명 | 코드 | 설명 | 매개변수 |
|--------|------|------|----------|
| 단순이동평균 | SMA | Simple Moving Average | 기간 (5,10,20,50,100,200) |
| 지수이동평균 | EMA | Exponential Moving Average | 기간 (5,10,20,50,100,200) |
| MACD | MACD | Moving Average Convergence Divergence | 12,26,9 |
| 평균방향성지수 | ADX | Average Directional Index | 기간 14 |

#### 2. 오실레이터 (Oscillators)
| 지표명 | 코드 | 설명 | 매개변수 |
|--------|------|------|----------|
| RSI | RSI | Relative Strength Index | 기간 14 |
| 스토캐스틱 | STOCH | Stochastic Oscillator | %K=14, %D=3 |
| 윌리엄스 %R | WILLR | Williams %R | 기간 14 |
| CCI | CCI | Commodity Channel Index | 기간 20 |

#### 3. 변동성 지표 (Volatility Indicators)
| 지표명 | 코드 | 설명 | 매개변수 |
|--------|------|------|----------|
| 볼린저 밴드 | BBANDS | Bollinger Bands | 기간 20, 표준편차 2 |
| ATR | ATR | Average True Range | 기간 14 |
| 표준편차 | STDDEV | Standard Deviation | 기간 20 |

#### 4. 거래량 지표 (Volume Indicators)
| 지표명 | 코드 | 설명 | 매개변수 |
|--------|------|------|----------|
| OBV | OBV | On Balance Volume | - |
| 거래량 이동평균 | VOLSMA | Volume Simple Moving Average | 기간 20 |

#### 5. 모멘텀 지표 (Momentum Indicators)
| 지표명 | 코드 | 설명 | 매개변수 |
|--------|------|------|----------|
| ROC | ROC | Rate of Change | 기간 12 |
| 모멘텀 | MOM | Momentum | 기간 10 |

### 지표 해석

#### RSI (Relative Strength Index)
- **범위**: 0-100
- **과매수**: 70 이상
- **과매도**: 30 이하
- **중립**: 30-70
- **사용법**: 과매수/과매도 구간에서 반전 신호 포착

#### MACD (Moving Average Convergence Divergence)
- **구성**: MACD Line, Signal Line, Histogram
- **골든크로스**: MACD > Signal (매수 신호)
- **데드크로스**: MACD < Signal (매도 신호)
- **다이버전스**: 주가와 MACD 방향성 차이

#### 스토캐스틱 (Stochastic)
- **%K**: 빠른 스토캐스틱
- **%D**: 느린 스토캐스틱 (%K의 이동평균)
- **과매수**: 80 이상
- **과매도**: 20 이하

#### 볼린저 밴드 (Bollinger Bands)
- **상단 밴드**: 이동평균 + (표준편차 × 2)
- **하단 밴드**: 이동평균 - (표준편차 × 2)
- **밴드 터치**: 반전 신호 가능성
- **밴드 확장**: 변동성 증가

---

## 주요 쿼리 예제

### 1. 기본 주가 데이터 조회
```sql
-- 삼성전자 최근 30일 주가
SELECT date, open, high, low, close, volume
FROM stock_prices 
WHERE ticker = '005930' 
ORDER BY date DESC 
LIMIT 30;
```

### 2. 기술적 지표 조회
```sql
-- 삼성전자 RSI 최근 값
SELECT 
    iv.date,
    iv.value->>'rsi' as rsi_value
FROM indicator_values iv
JOIN indicator_definitions id ON iv.indicator_id = id.id
WHERE iv.ticker = '005930' 
  AND id.code = 'RSI'
ORDER BY iv.date DESC
LIMIT 10;
```

### 3. 지표 요약 뷰 활용
```sql
-- 지표 요약 정보
SELECT 
    ticker,
    company_name,
    current_price,
    sma_20,
    sma_50,
    rsi,
    macd,
    macd_signal
FROM v_indicator_summary 
WHERE ticker = '005930';
```

### 4. 매매 신호 분석
```sql
-- 매수 신호 종목 찾기
SELECT 
    ticker,
    company_name,
    rsi_signal,
    macd_signal_type,
    trend_signal
FROM v_trading_signals
WHERE rsi_signal = 'Buy' 
   OR macd_signal_type = 'Bullish'
ORDER BY ticker;
```

### 5. 섹터별 RSI 평균
```sql
SELECT 
    s.sector,
    AVG(CAST(iv.value->>'rsi' AS FLOAT)) as avg_rsi,
    COUNT(*) as stock_count
FROM indicator_values iv
JOIN indicator_definitions id ON iv.indicator_id = id.id
JOIN stocks s ON iv.ticker = s.ticker
WHERE id.code = 'RSI'
  AND iv.date = (SELECT MAX(date) FROM indicator_values WHERE ticker = iv.ticker)
GROUP BY s.sector
ORDER BY avg_rsi DESC;
```

### 6. 성능 모니터링
```sql
-- 테이블 크기 및 성능
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 7. 데이터 품질 확인
```sql
-- 지표 계산 완료 현황
SELECT 
    id.name,
    COUNT(DISTINCT iv.ticker) as calculated_stocks,
    (SELECT COUNT(*) FROM stocks) as total_stocks
FROM indicator_definitions id
LEFT JOIN indicator_values iv ON id.id = iv.indicator_id
WHERE id.is_active = true
GROUP BY id.id, id.name
ORDER BY calculated_stocks DESC;
```

---

## API 엔드포인트

### 1. 인증
```http
POST /api/v1/users/login
Content-Type: application/json

{
  "username": "testuser2",
  "password": "password123"
}
```

### 2. 종목 관리
```http
# 종목 목록 조회
GET /api/v1/stocks/

# 종목 추가
POST /api/v1/stocks/
Content-Type: application/json

{
  "ticker": "005930"
}

# 주가 데이터 조회
GET /api/v1/stocks/005930/prices?limit=100
```

### 3. 기술적 지표
```http
# 지표 카테고리 조회
GET /api/v1/indicators/categories

# 지표 정의 조회
GET /api/v1/indicators/definitions

# 지표 요약
GET /api/v1/indicators/summary/005930

# 지표 시계열 데이터
GET /api/v1/indicators/timeseries/005930?indicators=RSI,MACD&limit=50

# 매매 신호
GET /api/v1/indicators/signals/005930
```

---

## 문제 해결 (Troubleshooting)

### 1. 컨테이너 시작 실패
```bash
# 모든 컨테이너 중지 및 재시작
docker-compose down
docker-compose up -d

# 로그 확인
docker-compose logs stock-backend
docker-compose logs stock-db
```

### 2. 데이터베이스 연결 오류
```bash
# 데이터베이스 상태 확인
docker exec stock-db pg_isready -U admin

# 연결 테스트
docker exec -it stock-db psql -U admin -d stocktrading -c "SELECT 1;"
```

### 3. Grafana 대시보드 문제
```bash
# Grafana 재시작
docker restart grafana

# 데이터소스 연결 확인
curl -u admin:admin http://localhost:3000/api/datasources
```

### 4. 웹 애플리케이션 오류
```bash
# 백엔드 API 상태 확인
curl http://localhost:8000/health

# 정적 파일 서빙 확인
curl http://localhost:8000/app.js
```

### 5. 지표 계산 오류
```sql
-- 지표 계산 상태 확인
SELECT 
    COUNT(*) as total_calculations,
    COUNT(DISTINCT ticker) as unique_tickers,
    MAX(created_at) as last_calculation
FROM indicator_values;

-- 오류 로그 확인
SELECT * FROM calculation_logs WHERE status = 'error' ORDER BY created_at DESC LIMIT 10;
```

### 6. 성능 최적화
```sql
-- 인덱스 사용률 확인
SELECT * FROM pg_stat_user_indexes WHERE schemaname = 'public';

-- 쿼리 성능 분석
EXPLAIN ANALYZE SELECT * FROM v_indicator_summary WHERE ticker = '005930';
```

### 7. 일반적인 오류 및 해결책

#### "Dashboard title cannot be empty"
- **원인**: Grafana 대시보드 JSON 형식 오류
- **해결**: API를 통해 대시보드 재생성

#### "input array type is not double"
- **원인**: TA-Lib 입력 데이터 타입 오류
- **해결**: NumPy array 타입 변환 확인

#### "Connection refused"
- **원인**: 서비스 간 네트워크 연결 오류
- **해결**: Docker 네트워크 및 서비스 이름 확인

---

## 추가 정보

### 개발 환경
- **Python**: 3.11
- **FastAPI**: 0.104+
- **PostgreSQL**: 15
- **TimescaleDB**: 2.12+
- **Grafana**: 10.0+
- **Chart.js**: 4.0+

### 데이터 업데이트 스케줄
- **주가 데이터**: 일일 오후 6시 (한국시간)
- **기술적 지표**: 주가 업데이트 후 자동 계산
- **백업**: 매일 자정 데이터베이스 백업

### 연락처 및 지원
- **프로젝트 위치**: F:\hhstock\stock-trading-system\
- **문서 위치**: 프로젝트 루트 디렉토리
- **로그 위치**: logs/ 디렉토리

---

**※ 본 매뉴얼은 2025년 8월 31일 기준으로 작성되었으며, 시스템 업데이트에 따라 내용이 변경될 수 있습니다.**