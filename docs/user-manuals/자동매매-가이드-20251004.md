# RSI 기반 자동매매 시스템 가이드
**작성일**: 2025년 10월 4일
**버전**: 1.0

## 📋 목차
1. [시스템 개요](#시스템-개요)
2. [매매 전략](#매매-전략)
3. [설치 및 설정](#설치-및-설정)
4. [사용 방법](#사용-방법)
5. [API 사용법](#api-사용법)
6. [알림 설정](#알림-설정)
7. [모니터링](#모니터링)

---

## 🎯 시스템 개요

RSI 지표와 이동평균선을 활용한 자동매매 시그널 감지 및 알림 시스템입니다.

### 핵심 기능
- ✅ **자동 시그널 감지**: RSI, MA 기반 매수/매도/손절 시그널
- ✅ **실시간 알림**: 카카오톡 & 이메일 자동 발송
- ✅ **포지션 관리**: 매수/매도 이력 및 수익률 추적
- ✅ **백테스팅**: 전략 성과 분석
- ✅ **REST API**: 프로그래밍 방식 접근

---

## 📈 매매 전략

### 매수 조건
```
RSI < 30 (과매도)
AND
MA20 > MA50 (상승 추세)
AND
주가 > 1,000원
AND
거래량 > 10,000주
```

**목표가**: 매수가 + 10%
**손절가**: 매수가 - 5%

### 매도 조건
```
보유 포지션 존재
AND
RSI > 70 (과매수)
```

### 손절 조건
```
현재가 <= 손절가 (5% 손실)
```

---

## 🛠️ 설치 및 설정

### 1. 데이터베이스 테이블 생성

```bash
# PostgreSQL 접속
docker exec -it stock-db psql -U admin -d stocktrading

# 테이블 생성 SQL 실행
\i /docker-entrypoint-initdb.d/trading_tables.sql

# 또는 파일로 실행
docker exec -i stock-db psql -U admin -d stocktrading < database/trading_tables.sql

# 확인
\dt trading*
```

**생성된 테이블**:
- `trading_signals`: 매매 시그널
- `trading_positions`: 보유 포지션
- `notification_logs`: 알림 로그

### 2. 백엔드 설정

#### 2-1. main.py에 라우터 등록

`backend/main.py` 파일에 추가:

```python
from trading_service.router import router as trading_router

app.include_router(trading_router)
```

#### 2-2. 환경 변수 설정

`.env` 파일 생성:

```bash
# 이메일 설정
SMTP_EMAIL=your-email@gmail.com
SMTP_PASSWORD=your-app-password

# 카카오톡 설정 (선택)
KAKAO_REST_API_KEY=your-kakao-api-key
KAKAO_ACCESS_TOKEN=your-kakao-access-token

# 알림 수신자
NOTIFICATION_EMAIL=recipient@example.com
NOTIFICATION_KAKAO_ID=kakao-user-id
```

**Gmail 앱 비밀번호 생성**:
1. Google 계정 → 보안
2. 2단계 인증 활성화
3. 앱 비밀번호 생성
4. 생성된 비밀번호를 `SMTP_PASSWORD`에 입력

### 3. Airflow DAG 활성화

```bash
# Airflow UI 접속
http://localhost:8080

# DAG 활성화
1. 'trading_signal_monitoring' DAG 찾기
2. 토글 버튼 ON으로 변경
```

### 4. 백엔드 재시작

```bash
docker-compose restart backend
```

---

## 🚀 사용 방법

### 1. 시그널 확인 (웹 UI)

**Airflow에서 확인**:
```
http://localhost:8080
→ DAGs → trading_signal_monitoring
→ Graph 또는 Logs 확인
```

**API로 확인**:
```
http://localhost:8000/docs
→ /api/trading/signals/all 실행
```

### 2. 수동 시그널 감지

Python 스크립트 실행:

```python
# backend/test_trading_signals.py
import sys
sys.path.append('/app')

from trading_service.signal_detector import SignalDetector

detector = SignalDetector("postgresql://admin:admin123@localhost:5435/stocktrading")

# 시그널 감지
signals = detector.detect_all_signals()

print(f"매수 시그널: {len(signals['buy'])}개")
print(f"매도 시그널: {len(signals['sell'])}개")
print(f"손절 시그널: {len(signals['stop_loss'])}개")

# 매수 시그널 출력
for signal in signals['buy'][:5]:
    print(f"\n종목: {signal['ticker']} ({signal['company_name']})")
    print(f"현재가: {signal['current_price']:,.0f}원")
    print(f"RSI: {signal['rsi']:.2f}")
    print(f"이유: {signal['reason']}")
```

실행:
```bash
docker exec stock-backend python test_trading_signals.py
```

### 3. 포지션 관리

#### 매수 (포지션 오픈)

```python
from trading_service.position_manager import PositionManager

manager = PositionManager("postgresql://admin:admin123@postgres:5432/stocktrading")

# 매수
position_id = manager.open_position(
    ticker='005930',  # 삼성전자
    buy_price=70000,
    quantity=10,
    target_price=77000,  # +10%
    stop_loss_price=66500,  # -5%
    notes='RSI 과매도 매수'
)

print(f"포지션 ID: {position_id}")
```

#### 매도 (포지션 클로즈)

```python
# 매도
success = manager.close_position(
    position_id=1,
    sell_price=75000,
    notes='목표가 달성'
)

if success:
    print("매도 완료")
```

#### 보유 포지션 조회

```python
# 보유 포지션
positions = manager.get_open_positions()

for pos in positions:
    print(f"\n종목: {pos['ticker']} ({pos['company_name']})")
    print(f"매수가: {pos['buy_price']:,.0f}원")
    print(f"현재가: {pos['current_price']:,.0f}원")
    print(f"수익률: {pos['profit_rate']:.2f}%")
    print(f"평가손익: {pos['profit_loss']:,.0f}원")
```

---

## 📡 API 사용법

### 1. 매수 시그널 조회

```bash
curl http://localhost:8000/api/trading/signals/buy
```

**응답 예시**:
```json
{
  "status": "success",
  "count": 15,
  "signals": [
    {
      "ticker": "005930",
      "company_name": "삼성전자",
      "signal_type": "BUY",
      "current_price": 68000,
      "target_price": 74800,
      "stop_loss_price": 64600,
      "rsi": 28.5,
      "ma_20": 69000,
      "ma_50": 67000,
      "reason": "RSI=28.50 < 30 AND MA20=69000.00 > MA50=67000.00"
    }
  ]
}
```

### 2. 매수 실행

```bash
curl -X POST http://localhost:8000/api/trading/positions/buy \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "005930",
    "buy_price": 68000,
    "quantity": 10,
    "notes": "RSI 과매도 신호"
  }'
```

### 3. 보유 포지션 조회

```bash
curl http://localhost:8000/api/trading/positions/open
```

### 4. 수익률 요약

```bash
curl http://localhost:8000/api/trading/performance/summary
```

**응답 예시**:
```json
{
  "status": "success",
  "summary": {
    "total_trades": 25,
    "winning_trades": 18,
    "losing_trades": 7,
    "win_rate": 72.0,
    "total_profit_loss": 1250000,
    "avg_profit_rate": 5.8,
    "max_profit_rate": 15.2,
    "max_loss_rate": -4.8
  }
}
```

---

## 📧 알림 설정

### 1. 이메일 알림

#### Gmail 설정

1. **2단계 인증 활성화**
   - Google 계정 → 보안 → 2단계 인증

2. **앱 비밀번호 생성**
   - Google 계정 → 보안 → 앱 비밀번호
   - 앱 선택: 메일
   - 기기 선택: 기타 (커스텀 이름)
   - 생성된 16자리 비밀번호 복사

3. **환경 변수 설정**
```bash
export SMTP_EMAIL="your-email@gmail.com"
export SMTP_PASSWORD="abcd efgh ijkl mnop"  # 앱 비밀번호
```

### 2. 카카오톡 알림

#### 카카오 개발자 설정

1. **앱 생성**
   - https://developers.kakao.com/
   - 내 애플리케이션 → 애플리케이션 추가하기

2. **플랫폼 추가**
   - 앱 설정 → 플랫폼 → Web 플랫폼 등록
   - 사이트 도메인: http://localhost:3000

3. **REST API 키 발급**
   - 앱 설정 → 요약 정보 → REST API 키 복사

4. **사용자 토큰 발급**
```python
# 토큰 발급 스크립트
import requests

REST_API_KEY = "your-rest-api-key"
REDIRECT_URI = "http://localhost:3000"

# 1. 인가 코드 받기 (브라우저에서 실행)
auth_url = f"https://kauth.kakao.com/oauth/authorize?client_id={REST_API_KEY}&redirect_uri={REDIRECT_URI}&response_type=code"
print(f"브라우저에서 열기: {auth_url}")

# 2. 콜백 URL에서 code 파라미터 복사
code = input("인가 코드 입력: ")

# 3. 액세스 토큰 발급
token_url = "https://kauth.kakao.com/oauth/token"
data = {
    "grant_type": "authorization_code",
    "client_id": REST_API_KEY,
    "redirect_uri": REDIRECT_URI,
    "code": code
}

response = requests.post(token_url, data=data)
tokens = response.json()
access_token = tokens['access_token']

print(f"Access Token: {access_token}")
```

5. **환경 변수 설정**
```bash
export KAKAO_REST_API_KEY="your-rest-api-key"
export KAKAO_ACCESS_TOKEN="your-access-token"
```

### 3. 알림 테스트

```bash
curl -X POST http://localhost:8000/api/trading/notifications/test \
  -H "Content-Type: application/json" \
  -d '{
    "email": "your-email@example.com",
    "channels": ["email"]
  }'
```

---

## 📊 모니터링

### 1. Grafana 대시보드

**Trading Signals Dashboard** 생성:

```json
{
  "title": "Trading Signals",
  "panels": [
    {
      "title": "Recent Buy Signals",
      "targets": [{
        "rawSql": "SELECT signal_date, ticker, current_price, rsi FROM trading_signals WHERE signal_type = 'BUY' ORDER BY signal_date DESC LIMIT 10"
      }]
    },
    {
      "title": "Open Positions",
      "targets": [{
        "rawSql": "SELECT * FROM v_open_positions_summary"
      }]
    }
  ]
}
```

### 2. 데이터베이스 쿼리

#### 오늘 발생한 시그널

```sql
SELECT
    signal_type,
    COUNT(*) as count
FROM trading_signals
WHERE DATE(signal_date) = CURRENT_DATE
GROUP BY signal_type;
```

#### 보유 포지션 요약

```sql
SELECT * FROM v_open_positions_summary;
```

#### 매매 성과

```sql
SELECT * FROM v_trading_performance;
```

---

## 🔄 자동화 워크플로우

```
09:00 - 15:00 (30분마다)
├─ 1. 시그널 감지
│  ├─ 매수 조건 검사
│  ├─ 매도 조건 검사
│  └─ 손절 조건 검사
│
├─ 2. 시그널 저장
│  └─ trading_signals 테이블
│
├─ 3. 알림 발송
│  ├─ 이메일 발송
│  └─ 카카오톡 발송
│
└─ 4. 로그 기록
   └─ notification_logs 테이블
```

---

## 📝 예제 시나리오

### 시나리오 1: 매수 시그널 수신 및 매수

1. **시그널 수신** (09:30)
   ```
   [이메일]
   제목: [매수] 005930 매수 시그널
   내용:
   - 종목: 005930 (삼성전자)
   - 현재가: 68,000원
   - 목표가: 74,800원 (+10%)
   - 손절가: 64,600원 (-5%)
   - RSI: 28.5
   ```

2. **매수 실행**
   ```bash
   curl -X POST http://localhost:8000/api/trading/positions/buy \
     -H "Content-Type: application/json" \
     -d '{
       "ticker": "005930",
       "buy_price": 68000,
       "quantity": 10
     }'
   ```

3. **포지션 확인**
   ```bash
   curl http://localhost:8000/api/trading/positions/open
   ```

### 시나리오 2: 목표가 도달 매도

1. **매도 시그널 수신** (10:30)
   ```
   [이메일]
   제목: [매도] 005930 매도 시그널
   내용:
   - RSI: 72.3 (> 70, 과매수)
   - 수익률: +9.8%
   ```

2. **매도 실행**
   ```bash
   curl -X POST http://localhost:8000/api/trading/positions/sell \
     -H "Content-Type: application/json" \
     -d '{
       "position_id": 1,
       "sell_price": 74600
     }'
   ```

### 시나리오 3: 손절 시그널

1. **손절 시그널 수신** (11:00)
   ```
   [이메일]
   제목: [손절] 000660 손절 시그널
   ⚠️ 즉시 매도 검토 필요!

   - 현재가: 64,000원
   - 손절가: 64,600원
   - 손실률: -4.8%
   ```

2. **손절 매도 실행**

---

## ⚠️ 주의사항

1. **실전 투자 전 충분한 백테스팅 필요**
2. **시그널은 참고용, 최종 판단은 투자자 책임**
3. **손절 규칙 엄수 권장**
4. **API 키 및 비밀번호 보안 유지**
5. **과도한 매매 자제**

---

## 🆘 문제 해결

### 알림이 오지 않음

1. **이메일 설정 확인**
```bash
docker exec stock-backend env | grep SMTP
```

2. **Airflow DAG 상태 확인**
```bash
http://localhost:8080
→ trading_signal_monitoring
```

3. **로그 확인**
```bash
docker logs stock-airflow-scheduler | grep trading
```

### 시그널이 감지되지 않음

1. **데이터 확인**
```sql
SELECT COUNT(*) FROM stock_prices WHERE date = CURRENT_DATE;
SELECT COUNT(*) FROM technical_indicators WHERE date = CURRENT_DATE;
```

2. **조건 완화**
   - RSI 임계값 조정 (25 → 35)
   - 거래량 조건 낮추기

---

## 📚 참고 자료

- **RSI 지표**: https://www.investopedia.com/terms/r/rsi.asp
- **이동평균선**: https://www.investopedia.com/terms/m/movingaverage.asp
- **카카오 API**: https://developers.kakao.com/docs/latest/ko/message/rest-api
- **Gmail SMTP**: https://support.google.com/mail/answer/7126229

---

**작성자**: Auto Trading System Team
**최종 수정**: 2025년 10월 4일
