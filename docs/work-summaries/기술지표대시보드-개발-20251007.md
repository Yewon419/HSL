# Technical Indicators Dashboard Development Summary

## 프로젝트 개요
Grafana를 사용한 주식 기술분석 대시보드 개발 프로젝트입니다. 이동평균선, 일목균형표, 볼린저 밴드 등 다양한 기술지표를 통합하여 전문적인 주식 분석 환경을 구축했습니다.

## 주요 작업 내용

### 1. 이동평균선 및 일목균형표 추가
**목표**: Candlestick Chart에 이동평균선과 일목균형표 추가

**작업 과정**:
- 초기에는 SQL에서 직접 계산하는 방식으로 구현 시도
- PostgreSQL INTERVAL 구문 오류 발생: `pq: invalid input syntax for type interval: "2025-06-27T23:06:42.668Z"`
- Grafana 시간 변수가 ISO 타임스탬프 형태로 반환되어 PostgreSQL INTERVAL과 호환되지 않는 문제 발견

**해결 방안**:
- Airflow에서 사전 계산된 지표 값을 사용하는 방식으로 변경
- `($__timeFrom()::date - INTERVAL '60 days')` 형태로 구문 수정
- 성능 최적화 및 안정성 향상

### 2. Airflow 기술지표 계산 시스템 구현

**파일**: `F:\hhstock\stock-trading-system\airflow\dags\comprehensive_indicators.py`

**개선 사항**:
```python
# EMA 계산 개선 (12, 26 등 MACD용 지수 추가)
ema_values = {}
for period in [5, 10, 12, 20, 26, 50, 100, 200]:
    if len(df) >= period:
        ema = close.ewm(span=period, adjust=False).mean()
        ema_values[f'ema_{period}'] = float(ema.iloc[-1])

# 일목균형표 완전 구현
indicators['ICHIMOKU'] = {
    'tenkan_sen': float(tenkan_sen.iloc[-1]),        # 전환선
    'kijun_sen': float(kijun_sen.iloc[-1]),          # 기준선
    'senkou_span_a': float(senkou_span_a.iloc[-1]),  # 선행스팬 A
    'senkou_span_b': float(senkou_span_b.iloc[-1]),  # 선행스팬 B
    'chikou_span': float(chikou_span.iloc[-1]),      # 후행스팬
    'cloud_trend': 1 if senkou_span_a.iloc[-1] > senkou_span_b.iloc[-1] else 0,
    'price_cloud_position': 1 if close.iloc[-1] > max(senkou_span_a.iloc[-1], senkou_span_b.iloc[-1]) else -1
}
```

**계산 범위**: 2025-09-20 ~ 2025-09-26 (5일간) 데이터 생성

### 3. 볼린저 밴드 차트 통합 개선

**목표**: 모든 기술지표를 하나의 차트에서 분석 가능하도록 통합

**구현된 기능**:
- **캔들스틱 차트**: 순수한 OHLC 데이터와 기본 지표들
- **통합 차트**: "캔들차트 + 볼린저 밴드 + 이동평균선 + 일목균형표"

**표시되는 지표들**:
- **주가**: 빨간색 굵은 선 (close price)
- **EMA 12**: 라임색 점선
- **EMA 26**: 금색 점선
- **볼린저 밴드**: 상한(빨강), 중간(보라), 하한(파랑) 점선
- **일목균형표**: 전환선(청록), 기준선(마젠타), 후행스팬(주황 점선)

### 4. 일목균형표 구름대 시각화 개선

**문제**: 선행스팬 A와 B가 단순히 개별 선으로만 표시됨

**해결책**: 상황별 구름대 색상 표시
```sql
-- 구름대 (상승): 선행스팬 A가 위에 있을 때
CASE WHEN senkou_span_a >= senkou_span_b
THEN senkou_span_a END AS "구름대 상단(상승)",

-- 구름대 (하락): 선행스팬 B가 위에 있을 때
CASE WHEN senkou_span_b > senkou_span_a
THEN senkou_span_b END AS "구름대 상단(하락)"
```

**시각적 효과**:
- **상승 추세**: 녹색 구름대 (선행스팬 A ≥ 선행스팬 B)
- **하락 추세**: 빨간색 구름대 (선행스팬 B > 선행스팬 A)
- **fillBelowTo** 기능으로 두 선 사이 영역만 색칠
- 투명도 30%로 적절한 시각적 강조

### 5. 볼린저 밴드 표시 로직 개선

**변경 전**: Yes 선택 시 볼린저 밴드 표시
**변경 후**: No 선택 시 볼린저 밴드 표시

```sql
-- 볼린저 밴드 (NO 선택시에만 표시)
CASE WHEN '$show_bb' = '0' THEN
(SELECT (value->>'bb_upper')::numeric ...) END AS "Upper Band"
```

**사용자 경험 개선**: 더 직관적인 제어 방식

### 6. MACD 차트 시각화 개선

**문제점**:
- 0과 MACD 사이 영역이 불필요하게 색칠됨
- Signal 선이 노란색으로 잘 보이지 않음

**해결책**:
```json
{
  "fillOpacity": 0,  // 영역 색칠 제거
  "overrides": [
    {
      "matcher": {"id": "byName", "options": "Signal"},
      "properties": [
        {"id": "color", "value": {"fixedColor": "orange", "mode": "fixed"}},
        {"id": "custom.lineWidth", "value": 2}
      ]
    }
  ]
}
```

**결과**: 깔끔한 선형 차트, 뚜렷한 Signal 선

### 7. 대시보드 시간 범위 최적화

**변경 사항**: `now-1w` → `now-6M`

**효과**:
- 중장기 투자 관점에서의 분석 가능
- 이동평균선과 일목균형표의 장기 트렌드 파악
- 포괄적인 기술분석 환경 제공

## 기술적 성과

### 1. 데이터베이스 최적화
- **SQL 복잡도 감소**: 실시간 계산 → 사전 계산된 값 조회
- **성능 향상**: 복잡한 window function 제거
- **안정성 증대**: PostgreSQL 시간 변수 호환성 문제 해결

### 2. 시각화 품질 향상
- **색상 체계**: 각 지표별 구별되는 색상 및 스타일
- **가독성**: 적절한 투명도와 선 굵기 설정
- **전문성**: 금융 분석 도구 수준의 차트 구성

### 3. 사용자 경험 개선
- **직관적 제어**: 볼린저 밴드 표시/숨김 로직 개선
- **포괄적 분석**: 단일 차트에서 다중 지표 분석 가능
- **유연한 시간 범위**: 단기/장기 분석 모두 지원

## 최종 결과물

### 대시보드 구성
**URL**: http://localhost:3000/d/tech-indicators-002

**주요 패널**:
1. **Candlestick Chart**: 순수 OHLC + 기본 지표
2. **MACD**: 깔끔한 선형 차트
3. **RSI**: 과매수/과매도 구간 시각화
4. **Stochastic Oscillator**: %K, %D 선
5. **통합 차트**: 모든 기술지표 + 주가
6. **실시간 지표**: 현재가, RSI, MACD, ADX, ATR
7. **Trading Signals**: AI 기반 매매 신호
8. **Market Sentiment**: 시장 심리 게이지

### 구현된 기술지표
- **이동평균선**: SMA 20/50/200, EMA 12/26
- **일목균형표**: 전환선, 기준선, 선행스팬 A/B, 후행스팬, 구름대
- **볼린저 밴드**: 상한/중간/하한선
- **MACD**: MACD, Signal, Histogram
- **RSI**: 상대강도지수
- **Stochastic**: %K, %D 오실레이터

## 데이터 커버리지

### 성공적으로 처리된 종목
- **005930 (삼성전자)**: 32개 지표 모두 계산 완료
- **000660 (SK하이닉스)**: 전체 지표 계산 완료
- **035420 (NAVER)**: 전체 지표 계산 완료

### 제한사항
- **048430 (유라테크)**: 데이터 부족 (26일치)으로 지표 계산 불가
- **최소 요구사항**: 50일 이상의 주가 데이터 필요

## 파일 구조

```
F:\hhstock\stock-trading-system\
├── technical_indicators_dashboard_ver2.json    # 메인 대시보드 설정
├── import_dashboard.py                          # 대시보드 임포트 스크립트
├── airflow\dags\comprehensive_indicators.py    # 기술지표 계산 로직
└── improved-enhanced-dashboard.json            # 백업 대시보드 설정
```

## 향후 개선 방안

### 1. 데이터 확장
- 더 많은 종목의 장기 데이터 수집
- 실시간 데이터 피드 연동
- 분봉/시간봉 데이터 지원

### 2. 기능 개선
- 사용자 정의 지표 추가
- 알림 및 신호 시스템 구축
- 포트폴리오 관리 기능

### 3. 성능 최적화
- 캐싱 시스템 도입
- 대용량 데이터 처리 최적화
- 실시간 업데이트 효율성 개선

## 결론

본 프로젝트를 통해 Grafana 기반의 전문적인 주식 기술분석 대시보드를 성공적으로 구축했습니다. SQL 기반 실시간 계산에서 Airflow 기반 사전 계산 방식으로 전환하여 성능과 안정성을 크게 향상시켰으며, 일목균형표의 구름대 시각화와 다양한 기술지표의 통합 분석 환경을 제공합니다.

특히 PostgreSQL과 Grafana 시간 변수 간의 호환성 문제를 해결하고, 사용자 친화적인 인터페이스와 전문적인 시각화를 구현한 것이 주요 성과입니다.

---
**개발 기간**: 2025년 9월 28일
**개발 환경**: Grafana, PostgreSQL, Airflow, Docker
**주요 기술**: SQL, Python, JSON, 기술분석