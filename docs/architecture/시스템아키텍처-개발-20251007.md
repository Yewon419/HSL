# Stock Trading System Architecture

## 시스템 개요

한국 주식시장 데이터를 기반으로 기술적 지표 분석, 자동매매 시그널 감지, 백테스팅, 포트폴리오 관리를 제공하는 마이크로서비스 기반 주식 트레이딩 시스템입니다.

## 기술 스택

### Backend
- **Framework**: FastAPI (Python 3.10+)
- **ORM**: SQLAlchemy
- **Authentication**: JWT (JSON Web Tokens)
- **Task Queue**: Celery with Redis broker
- **API Documentation**: Swagger/OpenAPI (자동 생성)

### Databases
- **PostgreSQL + TimescaleDB**: 시계열 주가 데이터 및 지표 저장
  - Port: 5435 (host) → 5432 (container)
  - 시계열 데이터 최적화
- **Redis**: Celery 브로커, 캐싱
  - Port: 6380 (host) → 6379 (container)
- **InfluxDB**: 메트릭 및 성능 모니터링 데이터
  - Port: 8086

### Monitoring & Visualization
- **Grafana**: 대시보드 및 실시간 모니터링
  - Port: 3000
  - 주가 차트, 기술적 지표, 시그널 시각화

### Workflow Orchestration
- **Apache Airflow**: 데이터 수집 및 ETL 파이프라인 자동화
  - Webserver Port: 8080
  - DAG 기반 워크플로우 관리

### Infrastructure
- **Docker & Docker Compose**: 컨테이너 기반 배포
- **Network**: Bridge network (stock-network)

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client Layer                            │
│                     (Web Browser / API Client)                  │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTP/REST
┌────────────────────────────┴────────────────────────────────────┐
│                    FastAPI Backend (Port 8000)                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                  7 Microservices                         │  │
│  │  1. User Service      - 사용자 인증/관리                 │  │
│  │  2. Stock Service     - 주가 데이터 수집/조회           │  │
│  │  3. Indicators Service - 기술적 지표 계산               │  │
│  │  4. Trading Service   - 매매 시그널 감지/실행           │  │
│  │  5. Screening Service - 종목 스크리닝/백테스팅          │  │
│  │  6. Simulation Service - 시뮬레이션                     │  │
│  │  7. AI Service        - AI 기반 분석/예측               │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────┬─────────────┬─────────────┬─────────────┬──────────────┘
         │             │             │             │
    ┌────┴───┐   ┌────┴────┐   ┌────┴────┐   ┌────┴────┐
    │Postgres│   │  Redis  │   │ InfluxDB│   │ Grafana │
    │TimeScale│   │         │   │         │   │         │
    │  :5435 │   │  :6380  │   │  :8086  │   │  :3000  │
    └────────┘   └────┬────┘   └─────────┘   └─────────┘
                      │
         ┌────────────┴────────────┐
         │   Celery Workers        │
         │   (Background Tasks)    │
         └─────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│              Apache Airflow (Port 8080)                         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Scheduled DAGs:                                         │  │
│  │  - 일별 주가 데이터 수집                                │  │
│  │  - 기술적 지표 계산                                      │  │
│  │  - 매매 시그널 모니터링                                 │  │
│  │  - 데이터베이스 정리/최적화                             │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 마이크로서비스 상세

### 1. User Service (`/api/v1/users`)
**역할**: 사용자 인증, 권한 관리, 포트폴리오 관리

**주요 기능**:
- 사용자 등록/로그인 (JWT 인증)
- 포트폴리오 CRUD (매수/매도 관리)
- 대시보드 데이터 (총 자산, 수익률, 보유 종목)
- 사용자 알림 조회/관리

**주요 엔드포인트**:
- `POST /register` - 사용자 등록
- `POST /token` - 로그인 (JWT 토큰 발급)
- `GET /me` - 현재 사용자 정보
- `GET /dashboard` - 포트폴리오 대시보드
- `POST /portfolio` - 종목 매수
- `POST /portfolio/sell` - 종목 매도
- `GET /alerts` - 알림 조회

**데이터 모델**:
- `User`: 사용자 계정 (username, email, password_hash, initial_capital, current_assets)
- `Portfolio`: 보유/매도 포지션 (ticker, quantity, buy_price, sell_price, status)
- `UserAlert`: 사용자 알림 (alert_type, title, message, priority)

### 2. Stock Service (`/api/stocks`)
**역할**: 주가 데이터 수집 및 제공

**주요 기능**:
- 주가 데이터 수집 (yfinance, pykrx)
- 한국 주식 데이터 수집 (KOSPI/KOSDAQ)
- 주식 정보 조회 (회사명, 섹터, 산업, 시가총액)
- 과매도/과매수 종목 스크리닝 (RSI 기반)
- MACD 크로스오버 감지

**데이터 클래스**:
- `StockDataFetcher`: 주가 데이터 수집 및 저장
- `MarketScreener`: 기술적 지표 기반 종목 스크리닝

**데이터 모델**:
- `Stock`: 주식 기본 정보 (ticker, company_name, sector, industry, market_type)
- `StockPrice`: 일별 주가 (open, high, low, close, volume)
- `StockFundamental`: 재무 지표 (PER, PBR, EPS, ROE, 부채비율)
- `InvestorTrade`: 투자자별 매매 동향 (외국인, 기관, 개인)

### 3. Indicators Service (`/api/v1/indicators`)
**역할**: 기술적 지표 계산

**주요 기능**:
- 이동평균선 (MA 20/50/200)
- 상대강도지수 (RSI)
- 스토캐스틱 (Stochastic K, D)
- MACD (MACD, Signal, Histogram)
- 볼린저 밴드 (Upper, Middle, Lower)
- 일목균형표 (Ichimoku Cloud)

**데이터 모델**:
- `TechnicalIndicator`: 모든 기술적 지표 저장
  - ticker, date, rsi, macd, stoch_k, stoch_d
  - ma_20, ma_50, ma_200
  - bollinger_upper, bollinger_middle, bollinger_lower
  - ichimoku_tenkan, ichimoku_kijun, ichimoku_senkou_a/b

### 4. Trading Service (`/api/trading`)
**역할**: 자동매매 시그널 감지 및 포지션 관리

**주요 기능**:
- **매수 시그널**: RSI < 30 AND MA20 > MA50 (과매도 + 상승추세)
- **매도 시그널**: RSI > 70 (과매수)
- **손절 시그널**: 현재가 <= 손절가 (5% 손실)
- 포지션 관리 (매수/매도 실행)
- 수익률 분석
- 알림 전송 (이메일, 카카오톡, Slack)

**주요 엔드포인트**:
- `GET /signals/buy` - 매수 시그널 조회
- `GET /signals/sell` - 매도 시그널 조회
- `GET /signals/stop-loss` - 손절 시그널 조회
- `GET /signals/all` - 모든 시그널 조회
- `POST /positions/buy` - 매수 실행
- `POST /positions/sell` - 매도 실행
- `GET /positions/open` - 보유 포지션 조회
- `GET /performance/summary` - 수익률 요약
- `POST /notifications/send-signals` - 시그널 알림 전송

**핵심 클래스**:
- `SignalDetector`: 매매 시그널 감지 로직
- `PositionManager`: 포지션 관리 (매수/매도)
- `NotificationService`: 멀티채널 알림 전송

### 5. Screening Service (`/api/v1/screening`)
**역할**: 다중 조건 종목 스크리닝 및 백테스팅

**주요 기능**:
- 다중 지표 조건 스크리닝
- 전략 템플릿 저장/실행
- 백테스팅 엔진
- 기본 전략 제공:
  - 모멘텀 돌파 전략 (RSI/MACD/ADX 골든크로스)
  - 과매도 반등 전략 (RSI/MFI/CCI < 임계값)
  - 안정적 추세 전략 (RSI 중립 + ADX + MACD)

**주요 엔드포인트**:
- `GET /indicators` - 사용 가능한 지표 목록
- `POST /screen` - 스크리닝 실행
- `POST /backtest` - 백테스팅 실행
- `GET /strategies` - 저장된 전략 조회
- `POST /strategies` - 전략 저장
- `POST /strategies/{name}/execute` - 전략 실행

**핵심 클래스**:
- `StockScreener`: 다중 조건 스크리닝
- `BacktestEngine`: 백테스팅 실행

### 6. Simulation Service (`/api/v1/simulations`)
**역할**: 매매 전략 시뮬레이션

**주요 기능**:
- 과거 데이터 기반 시뮬레이션
- 전략 성과 분석
- 리스크/수익률 계산

**데이터 모델**:
- `Simulation`: 시뮬레이션 결과 저장

### 7. AI Service (`/api/v1/ai`)
**역할**: AI/ML 기반 주가 예측 및 분석

**주요 기능**:
- 머신러닝 기반 주가 예측
- 패턴 인식
- 감성 분석 (뉴스/소셜미디어)

## 데이터베이스 스키마

### Core Tables

#### users
- id (PK)
- username, email (unique)
- password_hash
- initial_capital, current_assets
- created_at, updated_at

#### stocks
- ticker (PK)
- company_name, market_type (KOSPI/KOSDAQ)
- sector, industry
- isin_code, listing_date
- is_active

#### stock_prices (TimescaleDB Hypertable)
- ticker (PK, FK)
- date (PK) - 시계열 인덱스
- open_price, high_price, low_price, close_price
- volume

#### technical_indicators (TimescaleDB Hypertable)
- ticker (PK, FK)
- date (PK)
- rsi, macd, macd_signal, macd_histogram
- stoch_k, stoch_d
- ma_20, ma_50, ma_200
- bollinger_upper, bollinger_middle, bollinger_lower
- ichimoku_tenkan, ichimoku_kijun, ichimoku_senkou_a, ichimoku_senkou_b

#### stock_fundamentals
- ticker (PK, FK)
- date (PK)
- per, pbr, eps, bps
- dividend_yield, roe, roa
- debt_ratio, current_ratio

#### portfolios
- id (PK)
- user_id (FK)
- ticker (FK)
- quantity, buy_price, sell_price
- buy_date, sell_date
- status (holding/sold)

#### user_alerts
- id (PK)
- user_id (FK)
- alert_type, title, message, priority
- is_read, created_at

### Trading Service Tables

#### trading_positions
- id (PK)
- ticker
- buy_price, sell_price
- quantity
- target_price, stop_loss_price
- status (open/closed)
- buy_date, sell_date
- profit_loss, profit_loss_pct

#### trading_signals
- id (PK)
- ticker, signal_type (BUY/SELL/STOP_LOSS)
- signal_date, current_price
- rsi, ma_20, ma_50
- reason, is_processed

## 데이터 플로우

### 1. 데이터 수집 파이프라인

```
Airflow DAG (스케줄링)
    ↓
한국거래소 API / yfinance
    ↓
Stock Service (data_fetcher.py)
    ↓
PostgreSQL (stock_prices 테이블)
    ↓
Indicators Service (지표 계산)
    ↓
PostgreSQL (technical_indicators 테이블)
    ↓
InfluxDB (메트릭 저장)
    ↓
Grafana (시각화)
```

### 2. 매매 시그널 생성 플로우

```
Trading Service (signal_detector.py)
    ↓
SQL 쿼리 (기술적 지표 분석)
    ↓
시그널 생성 (BUY/SELL/STOP_LOSS)
    ↓
PostgreSQL (trading_signals 저장)
    ↓
Notification Service
    ↓
이메일/카카오톡/Slack 전송
```

### 3. 사용자 매매 플로우

```
User Request → FastAPI Router
    ↓
JWT Authentication (user_service/auth.py)
    ↓
Portfolio Manager (매수/매도)
    ↓
PostgreSQL (portfolios 업데이트)
    ↓
User Dashboard 갱신
```

## 배포 환경

### Docker Compose Services

1. **postgres** (TimescaleDB)
   - Image: timescale/timescaledb:latest-pg14
   - Volumes: postgres_data
   - Environment: POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD

2. **redis**
   - Image: redis:alpine
   - Volumes: redis_data

3. **influxdb**
   - Image: influxdb:2.7
   - Volumes: influxdb_data

4. **grafana**
   - Image: grafana/grafana:latest
   - Volumes: grafana_data
   - Depends: postgres, influxdb

5. **backend** (FastAPI)
   - Build: ./backend
   - Depends: postgres, redis, influxdb
   - Volumes: ./backend (개발 모드)

6. **celery-worker**
   - Build: ./backend
   - Command: celery worker
   - Depends: redis, postgres

7. **celery-beat**
   - Build: ./backend
   - Command: celery beat (스케줄러)
   - Depends: redis, postgres

8. **airflow-webserver**
   - Image: apache/airflow:2.7.0
   - Depends: postgres, redis

9. **airflow-scheduler**
   - Image: apache/airflow:2.7.0
   - Depends: airflow-init

### 네트워크 구성
- Network: stock-network (bridge)
- Internal DNS: 서비스명으로 통신 (예: postgres:5432)

### 볼륨 구성
- postgres_data: PostgreSQL 데이터
- influxdb_data: InfluxDB 데이터
- grafana_data: Grafana 대시보드 설정

## API 엔드포인트 요약

| Service | Prefix | 주요 기능 |
|---------|--------|----------|
| User Service | `/api/v1/users` | 인증, 포트폴리오 관리 |
| Stock Service | `/api/stocks` | 주가 데이터 조회 |
| Indicators Service | `/api/v1/indicators` | 기술적 지표 조회 |
| Trading Service | `/api/trading` | 매매 시그널, 포지션 관리 |
| Screening Service | `/api/v1/screening` | 스크리닝, 백테스팅 |
| Simulation Service | `/api/v1/simulations` | 시뮬레이션 |
| AI Service | `/api/v1/ai` | AI 분석/예측 |

## 보안

- **인증**: JWT (JSON Web Tokens)
  - Secret Key: 환경변수 관리
  - Token Expiration: 24시간
  - Algorithm: HS256

- **비밀번호**: bcrypt 해싱

- **CORS**: 설정된 오리진만 허용
  - http://localhost:3000 (Grafana)
  - http://localhost:8080 (Airflow)

- **환경변수**: .env 파일로 관리 (git 제외)

## 모니터링 & 로깅

- **Grafana 대시보드**:
  - 주가 차트 (Candlestick)
  - 기술적 지표 오버레이
  - 매매 시그널 표시
  - 포트폴리오 수익률

- **InfluxDB 메트릭**:
  - API 응답 시간
  - 데이터 수집 주기
  - 시그널 생성 빈도

- **로깅**:
  - Python logging 모듈
  - Log Level: INFO
  - 주요 이벤트: 데이터 수집, 시그널 생성, 매매 실행

## 확장성 고려사항

1. **수평 확장**:
   - FastAPI는 stateless → 로드밸런서 추가 가능
   - Celery Worker 증설 가능
   - PostgreSQL Read Replica 구성 가능

2. **캐싱**:
   - Redis를 통한 자주 조회되는 데이터 캐싱
   - API 응답 캐싱

3. **데이터 파티셔닝**:
   - TimescaleDB의 자동 파티셔닝 (시계열 데이터)
   - 종목별 샤딩 고려

4. **비동기 처리**:
   - Celery를 통한 무거운 작업 비동기 처리
   - 백테스팅, 대량 데이터 수집

## 시작하기

### 필수 요구사항
- Docker & Docker Compose
- Python 3.10+
- PostgreSQL 14+ (TimescaleDB 확장)

### 실행 방법

```bash
# 1. 환경변수 설정
cp .env.example .env
# .env 파일 편집 (DB 비밀번호, JWT Secret 등)

# 2. Docker Compose 시작
docker-compose up -d

# 3. 데이터베이스 초기화
docker-compose exec backend python -m alembic upgrade head

# 4. 초기 데이터 수집 (선택)
docker-compose exec backend python backend/fetch_korea_stocks.py

# 5. 서비스 접근
# - FastAPI Docs: http://localhost:8000/docs
# - Grafana: http://localhost:3000
# - Airflow: http://localhost:8080
```

### 개발 모드

```bash
# Backend 개발 서버 (hot reload)
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

## 프로젝트 구조

```
stock-trading-system/
├── backend/
│   ├── main.py                    # FastAPI 앱 엔트리포인트
│   ├── config.py                  # 설정 관리
│   ├── database.py                # DB 연결
│   ├── models.py                  # SQLAlchemy 모델
│   ├── user_service/              # 사용자 서비스
│   │   ├── router.py
│   │   ├── auth.py                # JWT 인증
│   │   └── schemas.py
│   ├── stock_service/             # 주식 서비스
│   │   ├── data_fetcher.py        # 데이터 수집
│   │   ├── indicators.py          # 지표 계산
│   │   └── korea_stock_fetcher.py # 한국 주식 수집
│   ├── indicators_service/
│   ├── trading_service/           # 트레이딩 서비스
│   │   ├── router.py
│   │   ├── signal_detector.py     # 시그널 감지
│   │   ├── position_manager.py    # 포지션 관리
│   │   └── notification_service.py # 알림
│   ├── screening_service/         # 스크리닝 서비스
│   │   ├── router.py
│   │   └── screener.py            # 스크리닝 로직
│   ├── simulation_service/
│   ├── ai_service/
│   └── celery_app.py              # Celery 설정
├── airflow/
│   └── dags/                      # Airflow DAG 정의
│       ├── daily_stock_data_pipeline.py
│       ├── market_indicators_pipeline.py
│       └── trading_signal_monitoring.py
├── docker-compose.yml             # 전체 인프라 정의
├── .env                           # 환경변수 (git 제외)
└── README.md

claude-code-expert-guide/         # Claude Code 사용 가이드
├── README.md
├── QUICK-START.md
└── 01-111.md                     # 111개 베스트 프랙티스
```

## 라이선스

MIT License

## 기여

이슈 및 PR 환영합니다.

## 연락처

GitHub: https://github.com/chohkcloud/happystocklife
