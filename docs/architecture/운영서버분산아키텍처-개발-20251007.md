# HSL Stock Trading System - 운영서버 분산 아키텍처

## 1. 개요

### 1.1 목적
- 단일 서버에서 운영 중인 시스템을 3대의 Rocky Linux 서버로 분산 배포
- 서비스별 역할 분리를 통한 안정성 및 확장성 향상
- 장애 격리 및 Failover 지원 구조 구현

### 1.2 현재 구조 (AS-IS)
```
개발 PC (Windows)
├── PostgreSQL (TimescaleDB)
├── Redis
├── InfluxDB
├── Backend (FastAPI)
├── Celery Worker/Beat
├── Airflow Scheduler/Webserver
└── Grafana
```

### 1.3 목표 구조 (TO-BE)
```
┌─────────────────────────────────────────────────────────────┐
│                    개발자 PC (192.168.219.100)              │
│                         (관리/모니터링)                      │
└─────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│   Scheduler     │   │    Backend      │   │    Database     │
│     Server      │   │     Server      │   │     Server      │
│ 192.168.219.101 │   │ 192.168.219.102 │   │ 192.168.219.103 │
├─────────────────┤   ├─────────────────┤   ├─────────────────┤
│ • Airflow       │   │ • Backend API   │   │ • PostgreSQL    │
│   - Webserver   │   │   (FastAPI)     │   │   (TimescaleDB) │
│   - Scheduler   │   │ • Celery Worker │   │ • Redis         │
│ • Grafana       │   │ • Celery Beat   │   │ • InfluxDB      │
│ • Nginx         │   │ • Nginx         │   │ • Nginx         │
└─────────────────┘   └─────────────────┘   └─────────────────┘
```

## 2. 서버별 상세 구성

### 2.1 Scheduler Server (192.168.219.101)
**역할**: 작업 스케줄링 및 시각화

**구성 요소**:
- **Airflow Webserver** (Port 8080)
  - DAG 관리 UI
  - 작업 스케줄 모니터링
- **Airflow Scheduler**
  - DAG 실행 스케줄링
  - 작업 큐 관리
- **Grafana** (Port 3000)
  - 실시간 모니터링 대시보드
  - 성능 지표 시각화
- **Nginx** (Port 80/443)
  - 리버스 프록시
  - SSL 종료점

**리소스 요구사항**:
- CPU: 4 Core
- Memory: 8GB
- Storage: 100GB

### 2.2 Backend Server (192.168.219.102)
**역할**: 비즈니스 로직 처리 및 작업 실행

**구성 요소**:
- **Backend API** (Port 8000)
  - FastAPI 애플리케이션
  - RESTful API 서비스
- **Celery Worker**
  - 비동기 작업 처리
  - 주가 데이터 수집
  - 지표 계산
- **Celery Beat**
  - 정기 작업 스케줄러
  - 크론 작업 관리
- **Nginx** (Port 80/443)
  - 정적 파일 서비스
  - API 리버스 프록시

**리소스 요구사항**:
- CPU: 8 Core
- Memory: 16GB
- Storage: 200GB

### 2.3 Database Server (192.168.219.103)
**역할**: 데이터 저장 및 관리

**구성 요소**:
- **PostgreSQL (TimescaleDB)** (Port 5432)
  - 주가 시계열 데이터
  - 애플리케이션 메타데이터
  - Airflow 메타데이터
- **Redis** (Port 6379)
  - 캐시 서버
  - Celery 브로커
  - 세션 스토리지
- **InfluxDB** (Port 8086)
  - 메트릭 데이터
  - 성능 지표
- **Nginx** (Port 80/443)
  - 관리 UI 프록시

**리소스 요구사항**:
- CPU: 8 Core
- Memory: 32GB
- Storage: 500GB (SSD 권장)

## 3. 네트워크 구성

### 3.1 네트워크 토폴로지
```
┌────────────────────────────────────────┐
│        192.168.219.0/24 Network        │
├────────────────────────────────────────┤
│                                        │
│  .100 (개발PC)                         │
│    │                                   │
│    ├── .101 (Scheduler)               │
│    ├── .102 (Backend)                 │
│    └── .103 (Database)                │
│                                        │
│  Internal Docker Network: 172.20.0.0/16│
└────────────────────────────────────────┘
```

### 3.2 포트 매핑

| 서버 | 서비스 | 내부 포트 | 외부 포트 | 용도 |
|------|--------|-----------|-----------|------|
| Scheduler | Nginx | 80/443 | 80/443 | HTTP/HTTPS |
| | Grafana | 3000 | 3000 | 모니터링 UI |
| | Airflow | 8080 | 8080 | 작업 관리 UI |
| Backend | Nginx | 80/443 | 80/443 | HTTP/HTTPS |
| | FastAPI | 8000 | 8000 | API 서비스 |
| Database | PostgreSQL | 5432 | 5432 | DB 연결 |
| | Redis | 6379 | 6379 | 캐시/브로커 |
| | InfluxDB | 8086 | 8086 | 메트릭 DB |

### 3.3 방화벽 규칙

```bash
# Scheduler Server (101)
firewall-cmd --add-port=80/tcp --permanent
firewall-cmd --add-port=443/tcp --permanent
firewall-cmd --add-port=3000/tcp --permanent
firewall-cmd --add-port=8080/tcp --permanent

# Backend Server (102)
firewall-cmd --add-port=80/tcp --permanent
firewall-cmd --add-port=443/tcp --permanent
firewall-cmd --add-port=8000/tcp --permanent

# Database Server (103)
firewall-cmd --add-port=5432/tcp --permanent
firewall-cmd --add-port=6379/tcp --permanent
firewall-cmd --add-port=8086/tcp --permanent
```

## 4. Failover 및 고가용성 구성

### 4.1 데이터베이스 레플리케이션
```
Primary DB (103) ──────► Standby DB (추후 구성)
     │                         │
     └── Streaming ────────────┘
         Replication
```

**PostgreSQL Streaming Replication**:
- Primary: 192.168.219.103
- Standby: 추후 구성 (192.168.219.104)
- 자동 failover: Patroni 또는 Repmgr 사용

### 4.2 Redis Sentinel 구성
```
Redis Master (103)
     │
     ├── Redis Sentinel 1 (101)
     ├── Redis Sentinel 2 (102)
     └── Redis Sentinel 3 (103)
```

### 4.3 Load Balancing
```
        Nginx (101)
            │
     ┌──────┴──────┐
     │             │
Backend-1     Backend-2
  (102)      (추후 구성)
```

### 4.4 서비스 모니터링
- **Health Check Endpoints**:
  - Backend: `http://192.168.219.102:8000/health`
  - Database: `pg_isready -h 192.168.219.103`
  - Redis: `redis-cli -h 192.168.219.103 ping`

## 5. 백업 전략

### 5.1 데이터베이스 백업
```bash
# PostgreSQL 일일 백업
0 2 * * * pg_dump -h localhost -U admin stocktrading | gzip > /backup/postgres/stocktrading_$(date +\%Y\%m\%d).sql.gz

# Redis 스냅샷
0 */6 * * * redis-cli BGSAVE

# InfluxDB 백업
0 3 * * * influx backup /backup/influxdb/$(date +\%Y\%m\%d)
```

### 5.2 백업 정책
- **일일 백업**: PostgreSQL 전체 백업
- **6시간 백업**: Redis 스냅샷
- **주간 백업**: 전체 시스템 백업
- **보관 기간**: 30일 (일일), 90일 (주간)

## 6. 보안 구성

### 6.1 네트워크 보안
- 서버 간 통신: Private Network (192.168.219.0/24)
- 외부 접근: Nginx 리버스 프록시를 통한 접근
- SSL/TLS: Let's Encrypt 인증서 사용

### 6.2 접근 제어
```nginx
# Nginx 설정 예시
location /api {
    proxy_pass http://192.168.219.102:8000;

    # IP 제한
    allow 192.168.219.0/24;
    deny all;

    # Rate Limiting
    limit_req zone=api burst=20 nodelay;
}
```

### 6.3 인증 및 권한
- API: JWT 토큰 기반 인증
- Grafana: LDAP/OAuth 연동
- Airflow: RBAC (Role-Based Access Control)
- Database: 서비스별 전용 계정

## 7. 환경 변수 관리

### 7.1 환경별 설정 파일
```
/etc/stock-trading/
├── .env.common        # 공통 설정
├── .env.scheduler     # Scheduler 서버
├── .env.backend       # Backend 서버
└── .env.database      # Database 서버
```

### 7.2 주요 환경 변수
```bash
# .env.common
TZ=Asia/Seoul
LOG_LEVEL=INFO

# .env.backend
DATABASE_URL=postgresql://app_user:password@192.168.219.103:5432/stocktrading
REDIS_URL=redis://192.168.219.103:6379
CELERY_BROKER_URL=redis://192.168.219.103:6379/0
INFLUXDB_URL=http://192.168.219.103:8086

# .env.scheduler
AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql://airflow:password@192.168.219.103:5432/airflow
GRAFANA_DATABASE_URL=postgresql://grafana:password@192.168.219.103:5432/grafana
```

## 8. 모니터링 및 알림

### 8.1 모니터링 스택
```
Prometheus (추후 구성)
     │
     ├── Node Exporter (각 서버)
     ├── PostgreSQL Exporter
     ├── Redis Exporter
     └── Custom Metrics
            │
            └──► Grafana (101)
                     │
                     └──► AlertManager
```

### 8.2 주요 모니터링 지표
- **시스템 리소스**: CPU, Memory, Disk, Network
- **애플리케이션**: API 응답시간, 에러율, 처리량
- **데이터베이스**: 연결 수, 쿼리 성능, 레플리케이션 지연
- **작업 큐**: Celery 작업 대기열, 처리 속도

### 8.3 알림 규칙
- CPU 사용률 > 80% (5분 지속)
- Memory 사용률 > 90%
- Disk 사용률 > 85%
- API 응답시간 > 2초
- Database 연결 실패
- Celery Worker 다운

## 9. 확장 계획

### 9.1 수평 확장
- Backend 서버 추가 (192.168.219.104+)
- Database Read Replica 추가
- Redis Cluster 구성

### 9.2 수직 확장
- Database 서버 리소스 증설
- NVMe SSD 추가
- Memory 증설

## 10. 재해 복구 (DR) 계획

### 10.1 RTO/RPO 목표
- RTO (Recovery Time Objective): 4시간
- RPO (Recovery Point Objective): 1시간

### 10.2 복구 시나리오
1. **Database 장애**: Standby DB로 자동 전환
2. **Backend 장애**: 로드밸런서를 통한 자동 제외
3. **전체 시스템 장애**: 백업에서 복구

### 10.3 복구 절차서
- 서버별 복구 스크립트 준비
- 데이터 복구 자동화 스크립트
- 서비스 상태 검증 스크립트

## 11. 배포 자동화

### 11.1 CI/CD 파이프라인
```
Git Repository ──► GitHub CI ──► Docker Registry
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
                Scheduler           Backend            Database
                 (101)              (102)               (103)
```

### 11.2 배포 전략
- Blue-Green Deployment (Backend)
- Rolling Update (Scheduler)
- Database Migration 자동화

## 12. 문서화

### 12.1 운영 문서
- 서버별 설치 가이드
- 운영 매뉴얼
- 트러블슈팅 가이드
- API 문서

### 12.2 장애 대응 매뉴얼
- 서비스별 장애 시나리오
- 복구 절차
- 연락처 및 에스컬레이션

## 부록 A: 네트워크 다이어그램

```mermaid
graph TB
    subgraph "External Network"
        User[사용자]
        Dev[개발자 PC]
    end

    subgraph "Internal Network 192.168.219.0/24"
        subgraph "Scheduler Server .101"
            Nginx1[Nginx]
            Airflow[Airflow]
            Grafana[Grafana]
        end

        subgraph "Backend Server .102"
            Nginx2[Nginx]
            API[FastAPI]
            Celery[Celery]
        end

        subgraph "Database Server .103"
            PG[PostgreSQL]
            Redis[Redis]
            Influx[InfluxDB]
        end
    end

    User --> Nginx1
    User --> Nginx2
    Dev --> Nginx1
    Dev --> Nginx2

    Nginx1 --> Airflow
    Nginx1 --> Grafana
    Nginx2 --> API

    API --> PG
    API --> Redis
    API --> Influx

    Celery --> PG
    Celery --> Redis

    Airflow --> PG
    Grafana --> PG
    Grafana --> Influx
```

## 부록 B: 서버 사양 권장사항

| 구분 | 최소 사양 | 권장 사양 | 비고 |
|------|-----------|-----------|------|
| **Scheduler Server** | | | |
| CPU | 2 Core | 4 Core | |
| Memory | 4GB | 8GB | |
| Storage | 50GB | 100GB SSD | |
| **Backend Server** | | | |
| CPU | 4 Core | 8 Core | |
| Memory | 8GB | 16GB | |
| Storage | 100GB | 200GB SSD | |
| **Database Server** | | | |
| CPU | 4 Core | 8 Core | |
| Memory | 16GB | 32GB | |
| Storage | 200GB | 500GB NVMe | 높은 IOPS 필요 |

## 부록 C: 체크리스트

### 설치 전 체크리스트
- [ ] Rocky Linux 9 설치 완료
- [ ] 네트워크 설정 완료
- [ ] 방화벽 규칙 설정
- [ ] Docker/Docker Compose 설치
- [ ] Nginx 설치 및 설정
- [ ] 시간 동기화 (NTP)

### 배포 체크리스트
- [ ] 환경 변수 파일 생성
- [ ] Docker 이미지 빌드/풀
- [ ] 데이터베이스 초기화
- [ ] 서비스 시작
- [ ] Health Check 확인
- [ ] 로그 확인

### 운영 체크리스트
- [ ] 백업 스케줄 설정
- [ ] 모니터링 대시보드 구성
- [ ] 알림 설정
- [ ] 로그 로테이션 설정
- [ ] 보안 업데이트 확인