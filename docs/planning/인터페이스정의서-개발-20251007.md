# API 인터페이스 정의서

## 문서 정보
- **프로젝트명**: Stock Trading System (HSL)
- **API 버전**: v1
- **Base URL**: `http://localhost:8000`
- **작성일**: 2025-10-06
- **문서 목적**: API 버전 통일 및 명확한 인터페이스 스펙 정의

---

## 목차
1. [API 버전 정책](#1-api-버전-정책)
2. [현재 버전 불일치 문제](#2-현재-버전-불일치-문제)
3. [통일된 API 구조 (제안)](#3-통일된-api-구조-제안)
4. [인증 API](#4-인증-api)
5. [사용자 API](#5-사용자-api)
6. [주식 데이터 API](#6-주식-데이터-api)
7. [기술적 지표 API](#7-기술적-지표-api)
8. [매매 시그널 API](#8-매매-시그널-api)
9. [종목 스크리닝 API](#9-종목-스크리닝-api)
10. [시뮬레이션 API](#10-시뮬레이션-api)
11. [AI 분석 API](#11-ai-분석-api)
12. [공통 규격](#12-공통-규격)

---

## 1. API 버전 정책

### 1.1 버전 관리 원칙

```
통일된 API Prefix: /api/v1/{resource}

규칙:
- 모든 API는 /api/v1 접두사를 사용
- 버전 없는 경로는 deprecated 처리
- 메이저 버전 변경 시 /api/v2 생성 (하위 호환성 유지)
```

### 1.2 버전 변경 정책

| 변경 유형 | 버전 변경 | 예시 |
|----------|----------|------|
| 필드 추가 (선택) | Minor | v1.1 (URL 동일) |
| 필드 추가 (필수) | Major | v2 (새 URL) |
| 필드 제거 | Major | v2 (새 URL) |
| 엔드포인트 추가 | Minor | v1.1 (URL 동일) |
| 엔드포인트 제거 | Major | v2 (새 URL) |

---

## 2. 현재 버전 불일치 문제

### 2.1 현재 상태 (main.py)

```python
# ❌ 문제: 버전 접두사 불일치
app.include_router(user_router, prefix="/api/v1/users", tags=["users"])
app.include_router(stock_router, prefix="/api/stocks", tags=["stocks"])  # v1 없음
app.include_router(simulation_router, prefix="/api/v1/simulations", tags=["simulations"])
app.include_router(ai_router, prefix="/api/v1/ai", tags=["ai"])
app.include_router(indicators_router, prefix="/api/v1/indicators", tags=["indicators"])
app.include_router(screening_router, prefix="/api/v1/screening", tags=["screening"])
app.include_router(trading_router, tags=["trading"])  # prefix가 router 내부에 정의됨
```

### 2.2 문제점 분석

| 서비스 | 현재 경로 | 문제 | 영향 |
|--------|-----------|------|------|
| User Service | `/api/v1/users` | ✅ 정상 | - |
| **Stock Service** | `/api/stocks` | ❌ v1 누락 | 클라이언트 혼란 |
| Simulation Service | `/api/v1/simulations` | ✅ 정상 | - |
| AI Service | `/api/v1/ai` | ✅ 정상 | - |
| Indicators Service | `/api/v1/indicators` | ✅ 정상 | - |
| Screening Service | `/api/v1/screening` | ✅ 정상 | - |
| **Trading Service** | `/api/trading/*` | ❌ v1 누락 | 클라이언트 혼란 |

### 2.3 영향 받는 프론트엔드 코드

```javascript
// ❌ 현재 혼재된 코드
fetch('/api/v1/users/dashboard')      // ✅ v1 있음
fetch('/api/stocks/005930/prices')     // ❌ v1 없음
fetch('/api/trading/signals/buy')      // ❌ v1 없음
fetch('/api/v1/screening/screen')      // ✅ v1 있음
```

---

## 3. 통일된 API 구조 (제안)

### 3.1 수정 방안

```python
# ✅ 수정 후: 모든 API에 /api/v1 적용
app.include_router(user_router, prefix="/api/v1/users", tags=["users"])
app.include_router(stock_router, prefix="/api/v1/stocks", tags=["stocks"])  # 수정
app.include_router(simulation_router, prefix="/api/v1/simulations", tags=["simulations"])
app.include_router(ai_router, prefix="/api/v1/ai", tags=["ai"])
app.include_router(indicators_router, prefix="/api/v1/indicators", tags=["indicators"])
app.include_router(screening_router, prefix="/api/v1/screening", tags=["screening"])
app.include_router(trading_router, prefix="/api/v1/trading", tags=["trading"])  # 수정
```

### 3.2 마이그레이션 계획

**Phase 1: 하위 호환성 유지 (Deprecation)**
```python
# 새 엔드포인트와 구 엔드포인트 동시 운영
app.include_router(stock_router, prefix="/api/v1/stocks", tags=["stocks v1"])
app.include_router(stock_router_legacy, prefix="/api/stocks", tags=["stocks (deprecated)"])
```

**Phase 2: 클라이언트 마이그레이션 (3개월)**
- 모든 프론트엔드 코드를 `/api/v1/*` 로 수정
- API 문서에 deprecation 경고 추가

**Phase 3: 구 엔드포인트 제거**
- `/api/stocks`, `/api/trading` 경로 제거

---

## 4. 인증 API

### 4.1 회원가입

```
POST /api/v1/auth/register
```

**Request Body:**
```json
{
  "username": "string (required, 3-50자)",
  "email": "string (required, 이메일 형식)",
  "password": "string (required, 8자 이상)"
}
```

**Response (201 Created):**
```json
{
  "status": "success",
  "data": {
    "id": 1,
    "username": "john_doe",
    "email": "john@example.com",
    "created_at": "2025-10-06T10:00:00Z"
  }
}
```

**Error Response (400 Bad Request):**
```json
{
  "status": "error",
  "error_code": "USER_ALREADY_EXISTS",
  "message": "Username or email already registered",
  "details": {
    "field": "username",
    "value": "john_doe"
  }
}
```

---

### 4.2 로그인

```
POST /api/v1/auth/login
```

**Request Body:**
```json
{
  "username": "string (required)",
  "password": "string (required)"
}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "expires_in": 86400,
    "user": {
      "id": 1,
      "username": "john_doe",
      "email": "john@example.com"
    }
  }
}
```

**Error Response (401 Unauthorized):**
```json
{
  "status": "error",
  "error_code": "INVALID_CREDENTIALS",
  "message": "Incorrect username or password"
}
```

---

### 4.3 로그아웃

```
POST /api/v1/auth/logout
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "message": "Logged out successfully"
}
```

---

### 4.4 토큰 갱신

```
POST /api/v1/auth/refresh
Authorization: Bearer {refresh_token}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 86400
  }
}
```

---

## 5. 사용자 API

### 5.1 현재 사용자 정보 조회

```
GET /api/v1/users/me
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "id": 1,
    "username": "john_doe",
    "email": "john@example.com",
    "initial_capital": 10000000.00,
    "current_assets": 12500000.00,
    "total_profit_loss": 2500000.00,
    "total_profit_loss_pct": 25.00,
    "created_at": "2025-01-01T00:00:00Z"
  }
}
```

---

### 5.2 대시보드 조회

```
GET /api/v1/users/dashboard
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "total_assets": 12500000.00,
    "total_profit_loss": 2500000.00,
    "total_profit_loss_pct": 25.00,
    "portfolio_count": 5,
    "active_positions": 3,
    "best_performer": {
      "ticker": "005930",
      "profit_loss_pct": 45.5
    },
    "worst_performer": {
      "ticker": "035720",
      "profit_loss_pct": -5.2
    },
    "portfolios": [
      {
        "id": 1,
        "ticker": "005930",
        "company_name": "삼성전자",
        "quantity": 10,
        "buy_price": 70000.00,
        "current_price": 72000.00,
        "profit_loss": 20000.00,
        "profit_loss_pct": 2.86,
        "status": "holding",
        "buy_date": "2025-09-01"
      }
    ]
  }
}
```

---

### 5.3 포트폴리오 추가 (매수)

```
POST /api/v1/users/portfolio
Authorization: Bearer {token}
```

**Request Body:**
```json
{
  "ticker": "005930",
  "quantity": 10,
  "buy_price": 70000.00
}
```

**Response (201 Created):**
```json
{
  "status": "success",
  "data": {
    "id": 123,
    "user_id": 1,
    "ticker": "005930",
    "quantity": 10,
    "buy_price": 70000.00,
    "buy_date": "2025-10-06",
    "status": "holding"
  }
}
```

---

### 5.4 포트폴리오 매도

```
POST /api/v1/users/portfolio/sell
Authorization: Bearer {token}
```

**Request Body:**
```json
{
  "portfolio_id": 123,
  "sell_price": 72000.00
}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "id": 123,
    "ticker": "005930",
    "quantity": 10,
    "buy_price": 70000.00,
    "sell_price": 72000.00,
    "profit_loss": 20000.00,
    "profit_loss_pct": 2.86,
    "status": "sold",
    "sell_date": "2025-10-06"
  }
}
```

---

### 5.5 알림 조회

```
GET /api/v1/users/alerts
Authorization: Bearer {token}
Query Parameters:
  - is_read: boolean (optional, default: false)
  - limit: integer (optional, default: 20)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "total": 5,
    "unread": 3,
    "alerts": [
      {
        "id": 1,
        "type": "trading_signal",
        "title": "매수 시그널 발생",
        "message": "005930 삼성전자: RSI 과매도 구간 진입",
        "priority": "high",
        "is_read": false,
        "created_at": "2025-10-06T09:30:00Z"
      }
    ]
  }
}
```

---

### 5.6 알림 읽음 처리

```
PUT /api/v1/users/alerts/{alert_id}/read
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "message": "Alert marked as read"
}
```

---

## 6. 주식 데이터 API

### 6.1 종목 목록 조회

```
GET /api/v1/stocks
Query Parameters:
  - market_type: string (optional, "KOSPI" | "KOSDAQ" | "ALL", default: "ALL")
  - sector: string (optional)
  - limit: integer (optional, default: 100)
  - offset: integer (optional, default: 0)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "total": 3000,
    "limit": 100,
    "offset": 0,
    "stocks": [
      {
        "ticker": "005930",
        "company_name": "삼성전자",
        "sector": "IT",
        "industry": "반도체",
        "market_type": "KOSPI",
        "market_cap": 500000000000000,
        "is_active": true
      }
    ]
  }
}
```

---

### 6.2 종목 상세 정보

```
GET /api/v1/stocks/{ticker}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "company_name": "삼성전자",
    "sector": "IT",
    "industry": "반도체",
    "market_type": "KOSPI",
    "market_cap": 500000000000000,
    "listing_date": "1975-06-11",
    "isin_code": "KR7005930003",
    "is_active": true,
    "updated_at": "2025-10-06T15:30:00Z"
  }
}
```

---

### 6.3 주가 데이터 조회

```
GET /api/v1/stocks/{ticker}/prices
Query Parameters:
  - start_date: string (optional, YYYY-MM-DD, default: 30일 전)
  - end_date: string (optional, YYYY-MM-DD, default: today)
  - interval: string (optional, "1d" | "1w" | "1m", default: "1d")
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "interval": "1d",
    "count": 30,
    "prices": [
      {
        "date": "2025-10-06",
        "open": 71000.00,
        "high": 72500.00,
        "low": 70500.00,
        "close": 72000.00,
        "volume": 15000000
      },
      {
        "date": "2025-10-05",
        "open": 70000.00,
        "high": 71200.00,
        "low": 69800.00,
        "close": 71000.00,
        "volume": 12000000
      }
    ]
  }
}
```

---

### 6.4 기본적 분석 데이터

```
GET /api/v1/stocks/{ticker}/fundamentals
Query Parameters:
  - date: string (optional, YYYY-MM-DD, default: latest)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "date": "2025-09-30",
    "market_cap": 500000000000000,
    "per": 15.5,
    "pbr": 1.8,
    "eps": 4500,
    "bps": 40000,
    "dividend_yield": 2.5,
    "roe": 12.5,
    "roa": 8.3,
    "debt_ratio": 45.2,
    "current_ratio": 150.5
  }
}
```

---

### 6.5 투자자별 매매 동향

```
GET /api/v1/stocks/{ticker}/investor-trades
Query Parameters:
  - start_date: string (optional, YYYY-MM-DD, default: 30일 전)
  - end_date: string (optional, YYYY-MM-DD, default: today)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "trades": [
      {
        "date": "2025-10-06",
        "foreign_buy": 1000000,
        "foreign_sell": 800000,
        "foreign_net": 200000,
        "institution_buy": 500000,
        "institution_sell": 600000,
        "institution_net": -100000,
        "individual_buy": 300000,
        "individual_sell": 400000,
        "individual_net": -100000
      }
    ]
  }
}
```

---

### 6.6 종목 통합 분석

```
GET /api/v1/stocks/{ticker}/analysis
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "company_name": "삼성전자",
    "current_price": 72000.00,
    "change": 1000.00,
    "change_pct": 1.41,
    "volume": 15000000,
    "technical_indicators": {
      "rsi": 65.5,
      "macd": 120.5,
      "macd_signal": 110.3,
      "stoch_k": 70.2,
      "stoch_d": 68.5,
      "ma_20": 71000.00,
      "ma_50": 69000.00,
      "ma_200": 65000.00,
      "bollinger_upper": 74000.00,
      "bollinger_middle": 71000.00,
      "bollinger_lower": 68000.00
    },
    "fundamentals": {
      "per": 15.5,
      "pbr": 1.8,
      "roe": 12.5
    },
    "signal": "neutral",
    "recommendation": "HOLD"
  }
}
```

---

### 6.7 종목 등록

```
POST /api/v1/stocks
Authorization: Bearer {token} (Admin only)
```

**Request Body:**
```json
{
  "ticker": "005930",
  "company_name": "삼성전자",
  "sector": "IT",
  "industry": "반도체",
  "market_type": "KOSPI"
}
```

**Response (201 Created):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "company_name": "삼성전자",
    "sector": "IT",
    "industry": "반도체",
    "market_type": "KOSPI",
    "created_at": "2025-10-06T10:00:00Z"
  }
}
```

---

### 6.8 데이터 업데이트 (단일 종목)

```
POST /api/v1/stocks/{ticker}/update
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "message": "Data updated successfully",
  "data": {
    "ticker": "005930",
    "updated_records": {
      "prices": 1,
      "indicators": 1
    }
  }
}
```

---

### 6.9 데이터 업데이트 (배치)

```
POST /api/v1/stocks/batch-update
Authorization: Bearer {token}
```

**Request Body:**
```json
{
  "tickers": ["005930", "035720", "051910"]
}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "total": 3,
    "success": 3,
    "failed": 0,
    "results": [
      {
        "ticker": "005930",
        "status": "success",
        "updated_records": 1
      }
    ]
  }
}
```

---

### 6.10 과매도 종목 스크리닝

```
GET /api/v1/stocks/screen/oversold
Query Parameters:
  - rsi_threshold: float (optional, default: 30)
  - limit: integer (optional, default: 20)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "threshold": 30,
    "count": 15,
    "stocks": [
      {
        "ticker": "005930",
        "company_name": "삼성전자",
        "current_price": 72000.00,
        "rsi": 25.5,
        "change_pct": -5.2
      }
    ]
  }
}
```

---

### 6.11 과매수 종목 스크리닝

```
GET /api/v1/stocks/screen/overbought
Query Parameters:
  - rsi_threshold: float (optional, default: 70)
  - limit: integer (optional, default: 20)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "threshold": 70,
    "count": 12,
    "stocks": [
      {
        "ticker": "035720",
        "company_name": "카카오",
        "current_price": 55000.00,
        "rsi": 75.8,
        "change_pct": 8.5
      }
    ]
  }
}
```

---

### 6.12 MACD 크로스오버 검색

```
GET /api/v1/stocks/screen/macd-crossover
Query Parameters:
  - type: string (optional, "golden" | "death" | "all", default: "all")
  - limit: integer (optional, default: 20)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "count": 8,
    "crossovers": [
      {
        "ticker": "005930",
        "company_name": "삼성전자",
        "type": "golden",
        "macd": 120.5,
        "macd_signal": 110.3,
        "current_price": 72000.00,
        "crossover_date": "2025-10-06"
      }
    ]
  }
}
```

---

## 7. 기술적 지표 API

### 7.1 지표 카테고리 조회

```
GET /api/v1/indicators/categories
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "categories": [
      {
        "name": "trend",
        "display_name": "추세 지표",
        "indicators": ["MA", "MACD", "Ichimoku"]
      },
      {
        "name": "momentum",
        "display_name": "모멘텀 지표",
        "indicators": ["RSI", "Stochastic"]
      },
      {
        "name": "volatility",
        "display_name": "변동성 지표",
        "indicators": ["BollingerBands", "ATR"]
      }
    ]
  }
}
```

---

### 7.2 지표 정의 조회

```
GET /api/v1/indicators/definitions
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "indicators": [
      {
        "code": "RSI",
        "name": "Relative Strength Index",
        "display_name": "상대강도지수",
        "category": "momentum",
        "description": "과매수/과매도 구간 판단 지표",
        "formula": "RSI = 100 - (100 / (1 + RS))",
        "parameters": {
          "period": 14
        },
        "range": {
          "min": 0,
          "max": 100
        },
        "interpretation": {
          "overbought": 70,
          "oversold": 30
        }
      }
    ]
  }
}
```

---

### 7.3 종목별 지표 요약

```
GET /api/v1/indicators/summary/{ticker}
Query Parameters:
  - date: string (optional, YYYY-MM-DD, default: latest)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "date": "2025-10-06",
    "indicators": {
      "trend": {
        "ma_20": 71000.00,
        "ma_50": 69000.00,
        "ma_200": 65000.00,
        "macd": 120.5,
        "macd_signal": 110.3,
        "macd_histogram": 10.2,
        "trend_direction": "up",
        "ma_alignment": "golden_cross"
      },
      "momentum": {
        "rsi": 65.5,
        "rsi_signal": "neutral",
        "stoch_k": 70.2,
        "stoch_d": 68.5,
        "stoch_signal": "overbought"
      },
      "volatility": {
        "bollinger_upper": 74000.00,
        "bollinger_middle": 71000.00,
        "bollinger_lower": 68000.00,
        "bollinger_position": "middle",
        "atr": 1500.00
      }
    },
    "overall_signal": "bullish"
  }
}
```

---

### 7.4 지표 시계열 데이터

```
GET /api/v1/indicators/timeseries/{ticker}
Query Parameters:
  - indicator: string (required, "RSI" | "MACD" | "MA" | ...)
  - start_date: string (optional, YYYY-MM-DD, default: 30일 전)
  - end_date: string (optional, YYYY-MM-DD, default: today)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "indicator": "RSI",
    "count": 30,
    "timeseries": [
      {
        "date": "2025-10-06",
        "value": 65.5
      },
      {
        "date": "2025-10-05",
        "value": 62.3
      }
    ]
  }
}
```

---

### 7.5 전체 종목 지표 그리드

```
GET /api/v1/indicators/grid
Query Parameters:
  - indicators: string (optional, comma-separated, default: "RSI,MACD,MA20,MA50")
  - market_type: string (optional, "KOSPI" | "KOSDAQ" | "ALL", default: "ALL")
  - limit: integer (optional, default: 100)
  - offset: integer (optional, default: 0)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "total": 3000,
    "limit": 100,
    "offset": 0,
    "columns": ["ticker", "company_name", "current_price", "rsi", "macd", "ma_20", "ma_50"],
    "rows": [
      {
        "ticker": "005930",
        "company_name": "삼성전자",
        "current_price": 72000.00,
        "rsi": 65.5,
        "macd": 120.5,
        "ma_20": 71000.00,
        "ma_50": 69000.00
      }
    ]
  }
}
```

---

### 7.6 시그널 분석

```
GET /api/v1/indicators/signals/{ticker}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "date": "2025-10-06",
    "signals": [
      {
        "indicator": "RSI",
        "signal": "neutral",
        "strength": "medium",
        "description": "RSI 65.5 - 중립 구간"
      },
      {
        "indicator": "MACD",
        "signal": "buy",
        "strength": "strong",
        "description": "MACD 골든크로스 발생"
      },
      {
        "indicator": "MA",
        "signal": "buy",
        "strength": "medium",
        "description": "MA20 > MA50 > MA200 정배열"
      }
    ],
    "overall": {
      "signal": "buy",
      "confidence": 0.75,
      "recommendation": "매수 고려"
    }
  }
}
```

---

### 7.7 복수 종목 비교

```
GET /api/v1/indicators/comparison
Query Parameters:
  - tickers: string (required, comma-separated)
  - indicators: string (optional, comma-separated, default: "RSI,MACD")
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "tickers": ["005930", "035720", "051910"],
    "indicators": ["RSI", "MACD"],
    "date": "2025-10-06",
    "comparison": [
      {
        "ticker": "005930",
        "company_name": "삼성전자",
        "rsi": 65.5,
        "macd": 120.5
      },
      {
        "ticker": "035720",
        "company_name": "카카오",
        "rsi": 75.8,
        "macd": 85.2
      }
    ]
  }
}
```

---

## 8. 매매 시그널 API

### 8.1 매수 시그널 조회

```
GET /api/v1/trading/signals/buy
Query Parameters:
  - target_date: string (optional, YYYY-MM-DD, default: today)
  - strategy: string (optional, "rsi_ma" | "macd" | "all", default: "rsi_ma")
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "strategy": "rsi_ma",
    "description": "RSI < 30 AND MA20 > MA50",
    "target_date": "2025-10-06",
    "count": 15,
    "signals": [
      {
        "ticker": "005930",
        "company_name": "삼성전자",
        "signal_type": "BUY",
        "current_price": 72000.00,
        "target_price": 79200.00,
        "stop_loss_price": 68400.00,
        "rsi": 28.5,
        "ma_20": 71000.00,
        "ma_50": 69000.00,
        "reason": "RSI 과매도 구간 + 상승 추세 진입",
        "confidence": 0.85,
        "signal_date": "2025-10-06T09:00:00Z"
      }
    ]
  }
}
```

---

### 8.2 매도 시그널 조회

```
GET /api/v1/trading/signals/sell
Query Parameters:
  - target_date: string (optional, YYYY-MM-DD, default: today)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "target_date": "2025-10-06",
    "count": 8,
    "signals": [
      {
        "ticker": "035720",
        "company_name": "카카오",
        "signal_type": "SELL",
        "current_price": 55000.00,
        "rsi": 75.8,
        "reason": "RSI 과매수 구간 진입",
        "confidence": 0.70,
        "signal_date": "2025-10-06T10:30:00Z"
      }
    ]
  }
}
```

---

### 8.3 손절 시그널 조회

```
GET /api/v1/trading/signals/stop-loss
Query Parameters:
  - target_date: string (optional, YYYY-MM-DD, default: today)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "target_date": "2025-10-06",
    "count": 2,
    "signals": [
      {
        "position_id": 123,
        "ticker": "051910",
        "company_name": "LG화학",
        "signal_type": "STOP_LOSS",
        "buy_price": 500000.00,
        "current_price": 475000.00,
        "stop_loss_price": 475000.00,
        "loss_amount": -25000.00,
        "loss_pct": -5.0,
        "reason": "손절가 도달",
        "signal_date": "2025-10-06T11:00:00Z"
      }
    ]
  }
}
```

---

### 8.4 전체 시그널 조회

```
GET /api/v1/trading/signals/all
Query Parameters:
  - target_date: string (optional, YYYY-MM-DD, default: today)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "target_date": "2025-10-06",
    "summary": {
      "buy_count": 15,
      "sell_count": 8,
      "stop_loss_count": 2
    },
    "signals": {
      "buy": [...],
      "sell": [...],
      "stop_loss": [...]
    }
  }
}
```

---

### 8.5 포지션 매수 실행

```
POST /api/v1/trading/positions/buy
Authorization: Bearer {token}
```

**Request Body:**
```json
{
  "ticker": "005930",
  "buy_price": 72000.00,
  "quantity": 10,
  "target_price": 79200.00,
  "stop_loss_price": 68400.00,
  "notes": "RSI+MA 상승전략 시그널"
}
```

**Response (201 Created):**
```json
{
  "status": "success",
  "data": {
    "position_id": 456,
    "ticker": "005930",
    "buy_price": 72000.00,
    "quantity": 10,
    "total_amount": 720000.00,
    "target_price": 79200.00,
    "stop_loss_price": 68400.00,
    "status": "open",
    "buy_date": "2025-10-06T14:30:00Z"
  }
}
```

---

### 8.6 포지션 매도 실행

```
POST /api/v1/trading/positions/sell
Authorization: Bearer {token}
```

**Request Body:**
```json
{
  "position_id": 456,
  "sell_price": 75000.00,
  "notes": "목표가 근접 - 익절"
}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "position_id": 456,
    "ticker": "005930",
    "buy_price": 72000.00,
    "sell_price": 75000.00,
    "quantity": 10,
    "profit_loss": 30000.00,
    "profit_loss_pct": 4.17,
    "status": "closed",
    "sell_date": "2025-10-08T10:00:00Z"
  }
}
```

---

### 8.7 보유 포지션 조회

```
GET /api/v1/trading/positions/open
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "count": 3,
    "positions": [
      {
        "position_id": 456,
        "ticker": "005930",
        "company_name": "삼성전자",
        "quantity": 10,
        "buy_price": 72000.00,
        "current_price": 73500.00,
        "unrealized_profit": 15000.00,
        "unrealized_profit_pct": 2.08,
        "target_price": 79200.00,
        "stop_loss_price": 68400.00,
        "days_held": 2,
        "buy_date": "2025-10-06"
      }
    ]
  }
}
```

---

### 8.8 포지션 히스토리

```
GET /api/v1/trading/positions/history
Authorization: Bearer {token}
Query Parameters:
  - limit: integer (optional, default: 100)
  - offset: integer (optional, default: 0)
  - status: string (optional, "open" | "closed" | "all", default: "all")
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "total": 50,
    "limit": 100,
    "offset": 0,
    "positions": [
      {
        "position_id": 123,
        "ticker": "005930",
        "company_name": "삼성전자",
        "buy_price": 70000.00,
        "sell_price": 72000.00,
        "quantity": 10,
        "profit_loss": 20000.00,
        "profit_loss_pct": 2.86,
        "status": "closed",
        "buy_date": "2025-09-01",
        "sell_date": "2025-09-15",
        "holding_period_days": 14
      }
    ]
  }
}
```

---

### 8.9 수익률 요약

```
GET /api/v1/trading/performance/summary
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "total_positions": 50,
    "open_positions": 3,
    "closed_positions": 47,
    "total_profit_loss": 2500000.00,
    "total_profit_loss_pct": 25.0,
    "win_rate": 68.0,
    "wins": 32,
    "losses": 15,
    "average_profit": 78125.00,
    "average_holding_days": 12.5,
    "best_trade": {
      "ticker": "035720",
      "profit_loss_pct": 45.5
    },
    "worst_trade": {
      "ticker": "051910",
      "profit_loss_pct": -8.2
    }
  }
}
```

---

### 8.10 알림 전송

```
POST /api/v1/trading/notifications/send-signals
Authorization: Bearer {token}
```

**Request Body:**
```json
{
  "target_date": "2025-10-06",
  "channels": ["email", "kakao", "slack"],
  "email": "user@example.com",
  "kakao_access_token": "your_kakao_token",
  "slack_webhook": "https://hooks.slack.com/services/..."
}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "signal_count": 15,
    "sent_count": 3,
    "channels": ["email", "kakao", "slack"],
    "message": "3/3개 채널로 알림 전송 완료"
  }
}
```

---

## 9. 종목 스크리닝 API

### 9.1 사용 가능한 지표 조회

```
GET /api/v1/screening/indicators
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "indicators": [
      {
        "code": "RSI",
        "name": "Relative Strength Index",
        "display_name": "상대강도지수",
        "supported_conditions": ["above", "below", "between", "golden_cross", "death_cross"]
      },
      {
        "code": "MACD",
        "name": "MACD",
        "display_name": "MACD",
        "supported_conditions": ["golden_cross", "death_cross"]
      }
    ]
  }
}
```

---

### 9.2 스크리닝 실행

```
POST /api/v1/screening/screen
```

**Request Body:**
```json
{
  "conditions": [
    {
      "indicator": "RSI",
      "condition": "below",
      "value": 30,
      "lookback_days": 1
    },
    {
      "indicator": "MACD",
      "condition": "golden_cross",
      "lookback_days": 5
    }
  ],
  "start_date": "2025-09-01",
  "end_date": "2025-10-06"
}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "total": 15,
    "conditions": [
      {
        "indicator": "RSI",
        "condition": "below",
        "value": 30
      }
    ],
    "results": [
      {
        "ticker": "005930",
        "company_name": "삼성전자",
        "match_date": "2025-10-06",
        "current_price": 72000.00,
        "rsi": 28.5,
        "macd": 120.5,
        "macd_signal": 110.3
      }
    ]
  }
}
```

---

### 9.3 백테스팅 실행

```
POST /api/v1/screening/backtest
```

**Request Body:**
```json
{
  "tickers": ["005930", "035720", "051910"],
  "start_date": "2024-01-01",
  "end_date": "2025-10-06",
  "initial_capital": 10000000.00,
  "position_size": 0.1,
  "transaction_cost": 0.003
}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "initial_capital": 10000000.00,
    "final_capital": 12500000.00,
    "total_return": 2500000.00,
    "total_return_pct": 25.0,
    "max_drawdown": -8.5,
    "sharpe_ratio": 1.85,
    "win_rate": 68.0,
    "total_trades": 50,
    "wins": 34,
    "losses": 16,
    "average_profit_per_trade": 50000.00,
    "trades": [
      {
        "ticker": "005930",
        "entry_date": "2024-01-15",
        "exit_date": "2024-01-30",
        "entry_price": 70000.00,
        "exit_price": 72000.00,
        "quantity": 10,
        "profit_loss": 20000.00,
        "profit_loss_pct": 2.86
      }
    ]
  }
}
```

---

### 9.4 전략 목록 조회

```
GET /api/v1/screening/strategies
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "strategies": [
      {
        "name": "모멘텀 돌파 전략",
        "description": "강한 상승 모멘텀을 보이는 종목 선별",
        "conditions": [
          {
            "indicator": "RSI",
            "condition": "golden_cross",
            "lookback_days": 5
          }
        ],
        "created_at": "2025-09-24"
      }
    ],
    "default_strategies": [
      {
        "name": "과매도 반등 전략",
        "description": "과도하게 하락한 종목의 반등 기회 포착",
        "conditions": [...]
      }
    ]
  }
}
```

---

### 9.5 전략 저장

```
POST /api/v1/screening/strategies
```

**Request Body:**
```json
{
  "name": "나만의 전략",
  "description": "RSI + MACD 조합 전략",
  "conditions": [
    {
      "indicator": "RSI",
      "condition": "below",
      "value": 30,
      "lookback_days": 1
    },
    {
      "indicator": "MACD",
      "condition": "golden_cross",
      "lookback_days": 5
    }
  ]
}
```

**Response (201 Created):**
```json
{
  "status": "success",
  "message": "전략이 성공적으로 저장되었습니다",
  "data": {
    "name": "나만의 전략",
    "description": "RSI + MACD 조합 전략",
    "conditions": [...],
    "created_at": "2025-10-06T10:00:00Z"
  }
}
```

---

### 9.6 전략 삭제

```
DELETE /api/v1/screening/strategies/{strategy_name}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "message": "전략 '나만의 전략'이 삭제되었습니다"
}
```

---

### 9.7 전략 실행

```
POST /api/v1/screening/strategies/{strategy_name}/execute
Query Parameters:
  - start_date: string (required, YYYY-MM-DD)
  - end_date: string (required, YYYY-MM-DD)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "strategy_name": "모멘텀 돌파 전략",
    "strategy_description": "강한 상승 모멘텀을 보이는 종목 선별",
    "execution_date": "2025-10-06T10:00:00Z",
    "results": {
      "total": 12,
      "stocks": [...]
    }
  }
}
```

---

## 10. 시뮬레이션 API

### 10.1 시뮬레이션 목록 조회

```
GET /api/v1/simulations
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "simulations": [
      {
        "id": 1,
        "name": "2024년 RSI 전략",
        "strategy": "rsi_ma",
        "start_date": "2024-01-01",
        "end_date": "2024-12-31",
        "initial_capital": 10000000.00,
        "final_capital": 12500000.00,
        "return_pct": 25.0,
        "created_at": "2025-01-15T10:00:00Z"
      }
    ]
  }
}
```

---

### 10.2 시뮬레이션 실행

```
POST /api/v1/simulations/run
Authorization: Bearer {token}
```

**Request Body:**
```json
{
  "name": "2025 Q3 모멘텀 전략",
  "strategy": "momentum",
  "tickers": ["005930", "035720", "051910"],
  "start_date": "2025-07-01",
  "end_date": "2025-09-30",
  "initial_capital": 10000000.00,
  "position_size": 0.2,
  "rebalance_frequency": "monthly"
}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "simulation_id": 123,
    "name": "2025 Q3 모멘텀 전략",
    "summary": {
      "initial_capital": 10000000.00,
      "final_capital": 11200000.00,
      "total_return": 1200000.00,
      "total_return_pct": 12.0,
      "max_drawdown": -5.2,
      "sharpe_ratio": 1.65,
      "total_trades": 25
    },
    "trades": [...],
    "daily_values": [...]
  }
}
```

---

## 11. AI 분석 API

### 11.1 AI 추천 종목

```
GET /api/v1/ai/recommendations
Authorization: Bearer {token}
Query Parameters:
  - risk_level: string (optional, "low" | "medium" | "high", default: "medium")
  - count: integer (optional, default: 10)
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "risk_level": "medium",
    "recommendations": [
      {
        "ticker": "005930",
        "company_name": "삼성전자",
        "current_price": 72000.00,
        "target_price": 85000.00,
        "confidence": 0.85,
        "expected_return_pct": 18.0,
        "risk_score": 0.45,
        "reason": "AI 모델이 강한 상승 패턴 감지 + 펀더멘털 우수",
        "analysis": {
          "technical_score": 0.88,
          "fundamental_score": 0.82,
          "sentiment_score": 0.75
        }
      }
    ]
  }
}
```

---

### 11.2 패턴 인식

```
GET /api/v1/ai/patterns
Query Parameters:
  - ticker: string (required)
  - pattern_type: string (optional, "all" | "head_shoulders" | "cup_handle" | ..., default: "all")
```

**Response (200 OK):**
```json
{
  "status": "success",
  "data": {
    "ticker": "005930",
    "patterns": [
      {
        "type": "cup_and_handle",
        "name": "컵 앤 핸들",
        "confidence": 0.78,
        "start_date": "2025-08-01",
        "end_date": "2025-10-06",
        "breakout_price": 75000.00,
        "target_price": 85000.00,
        "description": "컵 형성 후 핸들 패턴 진행 중, 돌파 임박"
      }
    ]
  }
}
```

---

## 12. 공통 규격

### 12.1 HTTP 상태 코드

| 코드 | 의미 | 사용 시나리오 |
|------|------|---------------|
| 200 | OK | 성공 (조회, 수정, 삭제) |
| 201 | Created | 리소스 생성 성공 |
| 204 | No Content | 성공 (응답 본문 없음) |
| 400 | Bad Request | 잘못된 요청 파라미터 |
| 401 | Unauthorized | 인증 실패 (토큰 없음/만료) |
| 403 | Forbidden | 권한 없음 |
| 404 | Not Found | 리소스 없음 |
| 409 | Conflict | 리소스 충돌 (중복 등록) |
| 422 | Unprocessable Entity | 검증 실패 |
| 500 | Internal Server Error | 서버 오류 |
| 503 | Service Unavailable | 서비스 일시 중단 |

---

### 12.2 표준 응답 형식

#### 성공 응답

```json
{
  "status": "success",
  "data": {
    // 실제 데이터
  },
  "message": "Optional success message",
  "meta": {
    "request_id": "uuid",
    "timestamp": "2025-10-06T10:00:00Z"
  }
}
```

#### 에러 응답

```json
{
  "status": "error",
  "error_code": "SPECIFIC_ERROR_CODE",
  "message": "Human-readable error message",
  "details": {
    // 추가 에러 정보
  },
  "meta": {
    "request_id": "uuid",
    "timestamp": "2025-10-06T10:00:00Z"
  }
}
```

---

### 12.3 페이지네이션

모든 목록 조회 API는 페이지네이션을 지원합니다.

**Query Parameters:**
- `limit`: 한 페이지당 결과 수 (default: 100, max: 1000)
- `offset`: 시작 위치 (default: 0)

**Response:**
```json
{
  "status": "success",
  "data": {
    "total": 3000,
    "limit": 100,
    "offset": 0,
    "items": [...]
  },
  "pagination": {
    "current_page": 1,
    "total_pages": 30,
    "has_next": true,
    "has_prev": false,
    "next_url": "/api/v1/stocks?limit=100&offset=100",
    "prev_url": null
  }
}
```

---

### 12.4 필터링 및 정렬

**Query Parameters:**
- `sort_by`: 정렬 필드 (예: `ticker`, `rsi`, `price`)
- `order`: 정렬 순서 (`asc` | `desc`, default: `asc`)
- `filter[field]`: 필터 조건 (예: `filter[market_type]=KOSPI`)

**예시:**
```
GET /api/v1/stocks?sort_by=rsi&order=asc&filter[market_type]=KOSPI
```

---

### 12.5 인증 헤더

모든 보호된 엔드포인트는 JWT 토큰이 필요합니다.

**Header:**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Token Expiration:**
- Access Token: 24시간
- Refresh Token: 30일 (향후 구현)

---

### 12.6 Rate Limiting (향후 구현)

**Headers:**
```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1696598400
```

**초과 시 응답 (429 Too Many Requests):**
```json
{
  "status": "error",
  "error_code": "RATE_LIMIT_EXCEEDED",
  "message": "Rate limit exceeded. Please try again in 60 seconds.",
  "details": {
    "retry_after": 60,
    "limit": 100,
    "window": "1 minute"
  }
}
```

---

### 12.7 에러 코드 목록

| 에러 코드 | HTTP 상태 | 설명 |
|----------|----------|------|
| `INVALID_CREDENTIALS` | 401 | 로그인 실패 |
| `TOKEN_EXPIRED` | 401 | JWT 토큰 만료 |
| `TOKEN_INVALID` | 401 | 유효하지 않은 토큰 |
| `INSUFFICIENT_PERMISSIONS` | 403 | 권한 부족 |
| `USER_ALREADY_EXISTS` | 409 | 사용자 중복 |
| `STOCK_NOT_FOUND` | 404 | 종목 없음 |
| `PORTFOLIO_NOT_FOUND` | 404 | 포트폴리오 없음 |
| `INVALID_TICKER` | 400 | 잘못된 티커 |
| `INVALID_DATE_RANGE` | 400 | 잘못된 날짜 범위 |
| `VALIDATION_ERROR` | 422 | 검증 실패 |
| `DATABASE_ERROR` | 500 | 데이터베이스 오류 |
| `EXTERNAL_API_ERROR` | 503 | 외부 API 오류 |
| `RATE_LIMIT_EXCEEDED` | 429 | Rate Limit 초과 |

---

## 부록 A: API 변경 로그

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2025-10-06 | v1.0 | 초기 API 정의 |
| TBD | v1.1 | `/api/stocks` → `/api/v1/stocks` 통일 |
| TBD | v1.1 | `/api/trading` → `/api/v1/trading` 통일 |
| TBD | v1.2 | Refresh Token 구현 |
| TBD | v1.3 | Rate Limiting 구현 |

---

## 부록 B: 마이그레이션 가이드

### 클라이언트 코드 수정 예시

**Before (현재):**
```javascript
// ❌ 비일관적인 API 경로
const userData = await fetch('/api/v1/users/me');
const stockData = await fetch('/api/stocks/005930/prices');  // v1 누락
const signals = await fetch('/api/trading/signals/buy');      // v1 누락
```

**After (수정 후):**
```javascript
// ✅ 통일된 API 경로
const userData = await fetch('/api/v1/users/me');
const stockData = await fetch('/api/v1/stocks/005930/prices');
const signals = await fetch('/api/v1/trading/signals/buy');
```

---

## 부록 C: Swagger/OpenAPI 문서

프로덕션 환경에서는 자동 생성된 Swagger UI를 통해 API를 테스트할 수 있습니다.

**URL:** `http://localhost:8000/docs`

---

**문서 끝**
