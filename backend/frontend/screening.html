<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ˆ ì£¼ì‹ ìŠ¤í¬ë¦¬ë‹ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            background-color: #0052cc !important;
        }
        .navbar-brand {
            font-weight: 600;
        }
        .card {
            border: none;
            box-shadow: 0 0 10px rgba(0,0,0,.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 2px solid #f0f0f0;
            font-weight: 600;
            padding: 15px;
        }
        .card-header h6 {
            font-size: 0.95rem;
        }
        .condition-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .active-condition-header {
            background-color: #1db854;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .condition-item {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .condition-item-label {
            font-weight: 500;
            color: #333;
        }
        .condition-item-value {
            color: #666;
            font-size: 0.85rem;
        }
        .strategy-item {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        .strategy-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .badge-condition {
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            display: inline-block;
        }
        .screening-button {
            background-color: #1db854;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .screening-button:hover {
            background-color: #159c3f;
        }
        .date-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .date-section {
            margin: 15px 0;
        }
        .date-section label {
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
        }
        .date-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .condition-list-section {
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,.1);
        }
        .section-header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-content {
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line"></i> HSL ì£¼ì‹ ì‹œìŠ¤í…œ
            </a>
            <span class="navbar-text text-white">
                ìŠ¤í¬ë¦¬ë‹ & ë°±í…ŒìŠ¤íŒ…
            </span>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ì™¼ìª½: ì¡°ê±´ ì¶”ê°€ ë° ì§„í–‰ ì¤‘ ì¡°ê±´ -->
            <div class="col-md-4">
                <!-- ì¡°ê±´ ì¶”ê°€ ì¹´ë“œ -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-plus"></i> ì¡°ê±´ ì¶”ê°€</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="condition-field" class="form-label">ì¡°ê±´ëª…</label>
                            <input type="text" class="form-control" id="condition-field" placeholder="ì˜ˆ: ëª¨ë©˜í…€ ëŒíŒŒ ì „ëµ">
                        </div>
                        <div class="mb-3">
                            <label for="condition-description" class="form-label">ì„¤ëª…</label>
                            <textarea class="form-control" id="condition-description" rows="2" placeholder="ì¡°ê±´ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">ìŠ¤í¬ë¦¬ë‹ ì¡°ê±´</label>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addConditionBlock()">
                                    <i class="fas fa-plus"></i> ì¡°ê±´ ì¶”ê°€
                                </button>
                            </div>
                            <div id="conditions-container"></div>
                        </div>

                        <button type="button" class="btn w-100 screening-button" onclick="submitCondition()">
                            <i class="fas fa-save"></i> ì¡°ê±´ ì¶”ê°€
                        </button>
                    </div>
                </div>

                <!-- ì§„í–‰ ì¤‘ ì¡°ê±´ ì¹´ë“œ -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-tasks"></i> ì§„í–‰ ì¤‘ ì¡°ê±´</h6>
                    </div>
                    <div class="card-body" id="active-conditions-container">
                        <div class="text-muted text-center py-3">
                            <small>ì¶”ê°€ëœ ì¡°ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì¡°ê±´ ëª©ë¡ ë° ì„¤ì • -->
            <div class="col-md-8 right-panel">
                <!-- ì¡°ê±´ ëª©ë¡ ì„¹ì…˜ -->
                <div class="condition-list-section">
                    <div class="section-header">
                        <i class="fas fa-list"></i> ì¡°ê±´ ëª©ë¡
                    </div>
                    <div class="section-content">
                        <div class="badge-condition mb-3" id="condition-count-badge">ì¡°ê±´ 3ê°œ</div>

                        <!-- ëª¨ë©˜í…€ ëŒíŒŒ ì „ëµ -->
                        <div style="margin-bottom: 25px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 style="font-weight: 600; margin: 0;">ëª¨ë©˜í…€ ëŒíŒŒ ì „ëµ</h6>
                                <button class="btn btn-sm btn-outline-secondary" onclick="editCondition('momentum')">ìˆ˜ì •</button>
                            </div>
                            <small class="text-muted d-block mb-2">ê°•í•œ ìƒìŠ¹ ëª¨ë©˜í…€ì„ ë³´ì´ëŠ” ì¢…ëª© ë°œê²¬</small>
                            <div class="badge-condition mb-2">ì¡°ê±´ 3ê°œ</div>

                            <div class="condition-item">
                                <div class="condition-item-label">ëª¨ë©˜í…€ ëŒíŒŒ ì¡°ê±´</div>
                                <div class="condition-item-value">ê°•í•œ ìƒìŠ¹ ëª¨ë©˜í…€ í¬ì°©</div>
                            </div>
                            <div class="condition-item">
                                <div class="condition-item-label">ì¡°ê±´ 3ê°œ</div>
                                <div class="condition-item-value">ì¡°ê±´ ìƒì„¸ ì„¤ì •</div>
                            </div>

                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-sm btn-outline-primary btn-block" style="flex: 1;">
                                    <i class="fas fa-search"></i> ì¡°ê±´ ê²€ì¦
                                </button>
                                <button class="btn btn-sm screening-button" style="flex: 1;">
                                    <i class="fas fa-play"></i> ìŠ¤í¬ë¦° ì‹¤í–‰
                                </button>
                            </div>
                        </div>

                        <!-- ê³ ë˜ë„ ë°•ë™ ì „ëµ -->
                        <div style="margin-bottom: 25px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 style="font-weight: 600; margin: 0;">ê³ ë˜ë„ ë°•ë™ ì „ëµ</h6>
                                <button class="btn btn-sm btn-outline-secondary" onclick="editCondition('whale')">ìˆ˜ì •</button>
                            </div>
                            <small class="text-muted d-block mb-2">ê³ ë˜ì™€ ê¸°ê´€ì˜ ì›€ì§ì„ì„ ë°˜ì˜í•˜ëŠ” ì¢…ëª© ë°œê²¬</small>
                            <div class="badge-condition mb-2">ì¡°ê±´ 3ê°œ</div>

                            <div class="condition-item">
                                <div class="condition-item-label">ê³ ë˜ë„ ë°•ë™ ì¡°ê±´</div>
                                <div class="condition-item-value">ê¸°ê´€/ê³ ë˜ ê±°ë˜ëŸ‰ ì¦ê°€</div>
                            </div>
                            <div class="condition-item">
                                <div class="condition-item-label">ì¡°ê±´ 3ê°œ</div>
                                <div class="condition-item-value">ì¡°ê±´ ìƒì„¸ ì„¤ì •</div>
                            </div>

                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-sm btn-outline-primary btn-block" style="flex: 1;">
                                    <i class="fas fa-search"></i> ì¡°ê±´ ê²€ì¦
                                </button>
                                <button class="btn btn-sm screening-button" style="flex: 1;">
                                    <i class="fas fa-play"></i> ìŠ¤í¬ë¦° ì‹¤í–‰
                                </button>
                            </div>
                        </div>

                        <!-- ì•ˆì •ì  ì£¼ì„¸ ì „ëµ -->
                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 style="font-weight: 600; margin: 0;">ì•ˆì •ì  ì£¼ì„¸ ì „ëµ</h6>
                                <button class="btn btn-sm btn-outline-secondary" onclick="editCondition('stable')">ìˆ˜ì •</button>
                            </div>
                            <small class="text-muted d-block mb-2">ê³¼ì—´ë˜ì§€ ì•Šìœ¼ë©´ì„œ ì§€ì†ë˜ëŠ” ì¢…ëª© ë°œê²¬</small>
                            <div class="badge-condition mb-2">ì¡°ê±´ 3ê°œ</div>

                            <div class="condition-item">
                                <div class="condition-item-label">ì•ˆì •ì  ì£¼ì„¸ ì¡°ê±´</div>
                                <div class="condition-item-value">ì¼ì •í•œ ë²”ìœ„ì˜ ìƒìŠ¹ì¥</div>
                            </div>
                            <div class="condition-item">
                                <div class="condition-item-label">ì¡°ê±´ 3ê°œ</div>
                                <div class="condition-item-value">ì¡°ê±´ ìƒì„¸ ì„¤ì •</div>
                            </div>

                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-sm btn-outline-primary btn-block" style="flex: 1;">
                                    <i class="fas fa-search"></i> ì¡°ê±´ ê²€ì¦
                                </button>
                                <button class="btn btn-sm screening-button" style="flex: 1;">
                                    <i class="fas fa-play"></i> ìŠ¤í¬ë¦° ì‹¤í–‰
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìŠ¤í¬ë¦¬ë‹ ì„¤ì • ì„¹ì…˜ -->
                <div class="condition-list-section">
                    <div class="section-header">
                        <i class="fas fa-calendar-alt"></i> ë¶„ì„ ê¸°ê°„ ì„¤ì •
                    </div>
                    <div class="section-content">
                        <div class="date-section">
                            <label>ë¶„ì„ ì‹œì‘ì¼</label>
                            <input type="date" class="form-control" id="screen-start-date">
                        </div>
                        <div class="date-section">
                            <label>ë¶„ì„ ì¢…ë£Œì¼</label>
                            <input type="date" class="form-control" id="screen-end-date">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast ì•Œë¦¼ -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="notification-toast" class="toast bg-info" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body text-white" id="toast-message"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api/v1/screening';
        let activeConditions = [];
        let currentEditingCondition = null;

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            initializeConditions();
            // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('screen-end-date').value = today;
            document.getElementById('screen-start-date').value = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
        });

        // ì¡°ê±´ ì´ˆê¸°í™”
        function initializeConditions() {
            // APIì—ì„œ ì¡°ê±´ ëª©ë¡ ë¡œë“œ ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
            loadConditions();
        }

        // ì¡°ê±´ ëª©ë¡ ë¡œë“œ
        async function loadConditions() {
            try {
                const response = await fetch(`${API_BASE_URL}/strategies`);
                const data = await response.json();
                // ì¡°ê±´ ëª©ë¡ ì²˜ë¦¬
            } catch (error) {
                console.log('ì¡°ê±´ ë¡œë“œ:', error.message);
            }
        }

        // ì¡°ê±´ ì œì¶œ
        async function submitCondition() {
            const name = document.getElementById('condition-field').value;
            const description = document.getElementById('condition-description').value;
            const conditions = getConditions();

            if (!name) {
                showToast('ì¡°ê±´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            if (!conditions.length) {
                showToast('ìŠ¤í¬ë¦¬ë‹ ì¡°ê±´ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/strategies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description,
                        conditions
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showToast('ì¡°ê±´ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    resetForm();
                    loadConditions();
                } else {
                    showToast('ì˜¤ë¥˜: ' + (data.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
                }
            } catch (error) {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'danger');
            }
        }

        // ì¡°ê±´ í¸ì§‘
        function editCondition(strategyId) {
            showToast(`'${strategyId}' ì¡°ê±´ ìˆ˜ì • ëª¨ë“œ`, 'info');
            document.querySelector('.col-md-4').scrollIntoView({ behavior: 'smooth' });
        }

        // ì¡°ê±´ ë¸”ë¡ ì¶”ê°€
        function addConditionBlock() {
            const container = document.getElementById('conditions-container');
            const index = container.children.length;
            const block = document.createElement('div');
            block.className = 'condition-block';
            block.innerHTML = `
                <div class="row mb-2">
                    <div class="col-md-5">
                        <select class="form-select form-select-sm" onchange="updateConditionIndex(${index})">
                            <option value="">ì§€í‘œ ì„ íƒ</option>
                            <option value="close">ì¢…ê°€</option>
                            <option value="volume">ê±°ë˜ëŸ‰</option>
                            <option value="rsi">RSI</option>
                            <option value="ma20">MA20</option>
                            <option value="ma50">MA50</option>
                            <option value="bb_upper">ë³¼ë¦°ì €ë°´ë“œ ìƒë‹¨</option>
                            <option value="bb_lower">ë³¼ë¦°ì €ë°´ë“œ í•˜ë‹¨</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm">
                            <option value=">">&gt;</option>
                            <option value="<">&lt;</option>
                            <option value="=">=</option>
                            <option value=">=">&gt;=</option>
                            <option value="<=">&lt;=</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control form-control-sm" placeholder="ê°’" step="0.01">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeConditionBlock(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(block);
        }

        // ì¡°ê±´ ë°ì´í„° ì¶”ì¶œ
        function getConditions() {
            const blocks = document.querySelectorAll('.condition-block');
            return Array.from(blocks).map(block => {
                const selects = block.querySelectorAll('select');
                const input = block.querySelector('input');
                return {
                    indicator: selects[0].value,
                    operator: selects[1].value,
                    value: parseFloat(input.value) || 0
                };
            }).filter(c => c.indicator);
        }

        // ì¡°ê±´ ë¸”ë¡ ì‚­ì œ
        function removeConditionBlock(index) {
            const blocks = document.querySelectorAll('.condition-block');
            if (blocks[index]) blocks[index].remove();
        }

        // í¼ ë¦¬ì…‹
        function resetForm() {
            document.getElementById('condition-field').value = '';
            document.getElementById('condition-description').value = '';
            document.getElementById('conditions-container').innerHTML = '';
            currentEditingCondition = null;
        }

        // ì „ëµ ì‹¤í–‰
        async function executeStrategy(strategyName) {
            const startDate = document.getElementById('screen-start-date').value;
            const endDate = document.getElementById('screen-end-date').value;

            if (!startDate || !endDate) {
                showToast('ë¶„ì„ ê¸°ê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            try {
                showToast(`'${strategyName}' ì „ëµ ì‹¤í–‰ ì¤‘...`, 'info');

                const response = await fetch(
                    `${API_BASE_URL}/strategies/${encodeURIComponent(strategyName)}/execute?start_date=${startDate}&end_date=${endDate}`,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' } }
                );

                const data = await response.json();

                if (response.ok) {
                    await saveToSignals(data, strategyName);
                    showToast(`ìŠ¤í¬ë¦¬ë‹ ì™„ë£Œ! ${data.results.total_matches}ê°œ ì¢…ëª© ë°œê²¬`, 'success');
                } else {
                    showToast('ìŠ¤í¬ë¦¬ë‹ ì‹¤íŒ¨: ' + (data.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
                }
            } catch (error) {
                showToast('ìŠ¤í¬ë¦¬ë‹ ì‹¤í–‰ ì‹¤íŒ¨: ' + error.message, 'danger');
            }
        }

        // ë§¤ë§¤ì‹ í˜¸ ì €ì¥
        async function saveToSignals(screeningData, strategyName) {
            const signals = screeningData.results.results.map(stock => ({
                ticker: stock.ticker,
                company_name: stock.company_name,
                country: stock.country || 'KR',
                sector: stock.sector || '',
                signal_date: stock.date,
                strategy_name: strategyName,
                current_price: stock.current_price,
                signal_reason: `ìŠ¤í¬ë¦¬ë‹ ì¡°ê±´ ë§Œì¡± (${screeningData.results.total_matches}ê°œ ì¤‘)`
            }));

            try {
                const response = await fetch('/api/trading/signals/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signals })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(result.message, 'success');
                }
            } catch (error) {
                console.log('ì‹ í˜¸ ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        // Toast ì•Œë¦¼
        function showToast(message, type = 'info') {
            const toastEl = document.getElementById('notification-toast');
            const toastBody = document.getElementById('toast-message');

            toastBody.textContent = message;
            toastEl.className = `toast bg-${type}`;

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
