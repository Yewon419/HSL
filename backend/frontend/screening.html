<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주식 스크리닝 & 백테스팅 | HSL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0052cc;
            --success-color: #1db854;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            font-family: 'Malgun Gothic', '맑은 고딕', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            min-height: 100vh;
        }

        .navbar {
            box-shadow: 0 2px 10px rgba(0,0,0,.1);
            background: linear-gradient(90deg, #0052cc 0%, #0066ff 100%) !important;
        }

        .card {
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,.08);
            border-radius: 12px;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,.12);
        }

        .card-header {
            background: linear-gradient(90deg, #f8f9fa 0%, #ffffff 100%);
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0 !important;
        }

        .condition-card {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .condition-card:hover {
            border-color: var(--primary-color);
            background: #f8f9ff;
        }

        .btn-primary-custom {
            background: linear-gradient(90deg, var(--primary-color) 0%, #0066ff 100%);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary-custom:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,82,204,0.3);
        }

        .btn-success-custom {
            background: linear-gradient(90deg, var(--success-color) 0%, #22c55e 100%);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .preset-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin: 4px;
        }

        .preset-badge.active {
            background: var(--primary-color);
            color: white;
        }

        .preset-badge:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .preset-badge:hover:not(.active) {
            background: #dee2e6;
        }

        .indicator-select {
            min-width: 180px;
        }

        .operator-select {
            min-width: 120px;
        }

        .progress-container {
            display: none;
            margin: 20px 0;
        }

        .progress-container.active {
            display: block;
        }

        .results-table {
            font-size: 0.9rem;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            white-space: nowrap;
        }

        .results-table td {
            vertical-align: middle;
        }

        .price-up {
            color: #dc3545;
            font-weight: 600;
        }

        .price-down {
            color: #0d6efd;
            font-weight: 600;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .condition-preview {
            background: #f0f4ff;
            border: 1px solid #d0d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 15px 15px 0 0;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,82,204,0.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

    </style>
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>HSL 주식 시스템
            </a>
            <span class="navbar-text text-white">
                <i class="fas fa-filter me-1"></i> 스크리닝 & 백테스팅
            </span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <!-- 헤더 -->
        <div class="mb-4">
            <h2 class="fw-bold text-dark">주식 스크리닝</h2>
            <p class="text-muted">기술적 지표 기반으로 조건에 맞는 종목을 찾아보세요</p>
        </div>

        <div class="row">
            <!-- 왼쪽: 스크리닝 설정 -->
            <div class="col-lg-5">
                <!-- 프리셋 필터 선택 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-star me-2 text-warning"></i>프리셋 필터
                    </div>
                    <div class="card-body">
                        <div id="preset-filters">
                            <span class="preset-badge active" data-preset="custom" onclick="selectPreset('custom')">
                                <i class="fas fa-magic me-1"></i>커스텀
                            </span>
                            <span class="preset-badge" data-preset="rsi_oversold" onclick="selectPreset('rsi_oversold')">
                                RSI 과매도
                            </span>
                            <span class="preset-badge" data-preset="golden_cross" onclick="selectPreset('golden_cross')">
                                골든크로스
                            </span>
                            <span class="preset-badge" data-preset="volume_breakout" onclick="selectPreset('volume_breakout')">
                                거래량 돌파
                            </span>
                            <span class="preset-badge" data-preset="bollinger_squeeze" onclick="selectPreset('bollinger_squeeze')">
                                볼린저 스퀴즈
                            </span>
                            <span class="preset-badge" data-preset="macd_bullish" onclick="selectPreset('macd_bullish')">
                                MACD 상승전환
                            </span>
                        </div>
                        <p class="text-muted small mt-3 mb-0" id="preset-description">
                            빈 상태에서 시작하여 자유롭게 조건을 추가하세요
                        </p>
                    </div>
                </div>

                <!-- 조건 빌더 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-cogs me-2"></i>조건 편집</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="addCondition()">
                            <i class="fas fa-plus me-1"></i>조건 추가
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="conditions-container">
                            <!-- 조건들이 여기에 추가됨 -->
                        </div>

                        <!-- 조건 미리보기 -->
                        <div class="condition-preview" id="condition-preview" style="display: none;">
                            <div class="fw-bold mb-2"><i class="fas fa-eye me-1"></i>조건 미리보기</div>
                            <ul class="mb-0 ps-3" id="preview-list"></ul>
                        </div>
                    </div>
                </div>

                <!-- 시장 및 설정 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-sliders-h me-2"></i>스크리닝 설정
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">대상 시장</label>
                                <select class="form-select" id="target-market">
                                    <option value="KOSPI">KOSPI</option>
                                    <option value="KOSDAQ">KOSDAQ</option>
                                    <option value="ALL" selected>전체 (KOSPI + KOSDAQ)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">분석 기준일</label>
                                <input type="date" class="form-control" id="target-date">
                            </div>
                        </div>

                        <!-- 실행 버튼 -->
                        <button class="btn btn-success-custom w-100 mt-4" onclick="runScreening()" id="run-btn">
                            <i class="fas fa-play me-2"></i>스크리닝 실행
                        </button>

                        <!-- 전략 저장 버튼 -->
                        <button class="btn btn-outline-primary w-100 mt-2" onclick="openSaveStrategyModal()">
                            <i class="fas fa-bookmark me-2"></i>관심 전략으로 저장
                        </button>

                        <!-- 진행률 -->
                        <div class="progress-container" id="progress-container">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" id="progress-bar" style="width: 0%">
                                    <span id="progress-text">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 오른쪽: 결과 -->
            <div class="col-lg-7">
                <!-- 통계 카드 -->
                <div class="row mb-3" id="stats-container" style="display: none;">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="stat-value" id="stat-total">0</div>
                            <div class="stat-label">스캔 종목</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="stat-value text-success" id="stat-matched">0</div>
                            <div class="stat-label">매칭 종목</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="stat-value" id="stat-avg-rsi">-</div>
                            <div class="stat-label">평균 RSI</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="stat-value" id="stat-market-ratio">-</div>
                            <div class="stat-label">시장 비율</div>
                        </div>
                    </div>
                </div>

                <!-- 결과 테이블 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-table me-2"></i>스크리닝 결과</span>
                        <span class="badge bg-primary" id="result-count">0개 종목</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="results-container">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <p>스크리닝을 실행하면 결과가 여기에 표시됩니다</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 포트폴리오 추가 모달 -->
    <div class="modal fade" id="addPortfolioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>포트폴리오에 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info" id="stock-info-alert">
                        <!-- 종목 정보 표시 -->
                    </div>
                    <form id="portfolio-form">
                        <div class="mb-3">
                            <label class="form-label">수량 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="pf-quantity" min="1" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">목표가 (익절)</label>
                                <input type="number" class="form-control" id="pf-target-price" step="1">
                                <small class="text-muted">빈칸 시 +10% 자동 설정</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">손절가</label>
                                <input type="number" class="form-control" id="pf-stop-loss" step="1">
                                <small class="text-muted">빈칸 시 -5% 자동 설정</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">메모</label>
                            <textarea class="form-control" id="pf-notes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="submitToPortfolio()">추가하기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 전략 저장 모달 -->
    <div class="modal fade" id="saveStrategyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-bookmark me-2"></i>관심 전략 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">이 조건으로 매일 자동 모니터링하고 매수 기회를 알려드립니다</p>
                    <form id="strategy-form">
                        <div class="mb-3">
                            <label class="form-label">전략 이름 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="strategy-name" placeholder="예: RSI 과매도 전략" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">설명</label>
                            <textarea class="form-control" id="strategy-description" rows="2" placeholder="이 전략에 대한 설명"></textarea>
                        </div>
                        <div class="alert alert-light">
                            <div class="fw-bold mb-2">설정된 조건</div>
                            <div id="strategy-conditions-preview"></div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="strategy-notification" checked>
                            <label class="form-check-label" for="strategy-notification">
                                <i class="fas fa-bell me-1"></i>알림 받기
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveStrategy()">등록하기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========================================
        // 상수 및 설정
        // ========================================

        const INDICATORS = [
            { value: 'PRICE', label: '현재가' },
            { value: 'VOLUME', label: '거래량' },
            { value: 'VOLUME_RATIO', label: '거래량 비율 (20일 대비)' },
            { value: 'RSI', label: 'RSI' },
            { value: 'MACD', label: 'MACD' },
            { value: 'MACD_SIGNAL', label: 'MACD 시그널' },
            { value: 'MACD_HISTOGRAM', label: 'MACD 히스토그램' },
            { value: 'SMA', label: '단순이동평균(SMA)' },
            { value: 'EMA', label: '지수이동평균(EMA)' },
            { value: 'MA_20', label: 'MA 20일' },
            { value: 'MA_50', label: 'MA 50일' },
            { value: 'MA_200', label: 'MA 200일' },
            { value: 'BB_UPPER', label: '볼린저밴드 상단' },
            { value: 'BB_LOWER', label: '볼린저밴드 하단' },
            { value: 'BB_WIDTH', label: '볼린저밴드 폭' },
            { value: 'ATR', label: 'ATR (변동성)' },
            { value: 'STOCHASTIC_K', label: '스토캐스틱 %K' },
            { value: 'STOCHASTIC_D', label: '스토캐스틱 %D' },
            { value: 'ADX', label: 'ADX (추세강도)' },
            { value: 'CCI', label: 'CCI' },
            { value: 'OBV', label: 'OBV (거래량)' },
            { value: 'MFI', label: 'MFI (자금흐름)' },
            { value: 'WILLIAMS_R', label: '윌리엄스 %R' },
            { value: 'CHANGE_PERCENT', label: '등락률 (%)' }
        ];

        const OPERATORS = [
            { value: '>', label: '>' },
            { value: '>=', label: '>=' },
            { value: '<', label: '<' },
            { value: '<=', label: '<=' },
            { value: '==', label: '=' },
            { value: '!=', label: '!=' },
            { value: 'cross_above', label: '상향돌파' },
            { value: 'cross_below', label: '하향돌파' },
            { value: 'in_range', label: '범위 내' },
            { value: 'out_range', label: '범위 외' }
        ];

        const PRESETS = {
            custom: {
                name: '커스텀',
                description: '빈 상태에서 시작하여 자유롭게 조건을 추가하세요',
                conditions: []
            },
            rsi_oversold: {
                name: 'RSI 과매도',
                description: 'RSI가 30 이하로 과매도 구간에 진입한 종목을 찾습니다',
                conditions: [
                    { type: 'RSI', operator: '<=', value: 30, period: 14, description: 'RSI 과매도' }
                ]
            },
            golden_cross: {
                name: '골든크로스',
                description: 'MA20이 MA50을 상향돌파한 종목을 찾습니다',
                conditions: [
                    { type: 'MA_20', operator: 'cross_above', value: 'MA_50', description: 'MA20 > MA50 상향돌파' }
                ]
            },
            volume_breakout: {
                name: '거래량 돌파',
                description: '평균 거래량의 2배 이상 거래된 종목을 찾습니다',
                conditions: [
                    { type: 'VOLUME_RATIO', operator: '>=', value: 2.0, description: '거래량 2배 이상' },
                    { type: 'CHANGE_PERCENT', operator: '>', value: 0, description: '상승 종목' }
                ]
            },
            bollinger_squeeze: {
                name: '볼린저 스퀴즈',
                description: '볼린저밴드 하단 근처에서 반등 가능성이 있는 종목',
                conditions: [
                    { type: 'PRICE', operator: '<=', value: 'BB_LOWER', description: '가격 <= BB하단' },
                    { type: 'RSI', operator: '<', value: 40, period: 14, description: 'RSI < 40' }
                ]
            },
            macd_bullish: {
                name: 'MACD 상승전환',
                description: 'MACD가 시그널선을 상향돌파한 종목',
                conditions: [
                    { type: 'MACD', operator: 'cross_above', value: 'MACD_SIGNAL', description: 'MACD 골든크로스' },
                    { type: 'MACD_HISTOGRAM', operator: '>', value: 0, description: '히스토그램 양수' }
                ]
            }
        };

        // ========================================
        // 상태 관리
        // ========================================

        let conditions = [];
        let currentPreset = 'custom';
        let screeningResults = [];
        let selectedStock = null;

        // ========================================
        // 초기화
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            // 오늘 날짜 설정
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('target-date').value = today;

            // 최신 데이터 날짜 가져오기
            fetchLatestDate();

            // 기본 조건 추가
            addCondition();
            updatePreview();
        });

        async function fetchLatestDate() {
            try {
                const response = await fetch('/api/stocks/latest-date');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('target-date').value = data.latest_date;
                }
            } catch (error) {
                console.log('최신 날짜 조회 실패:', error);
            }
        }

        // ========================================
        // 프리셋 관리
        // ========================================

        function selectPreset(presetId) {
            currentPreset = presetId;
            const preset = PRESETS[presetId];

            // 배지 업데이트
            document.querySelectorAll('.preset-badge').forEach(badge => {
                badge.classList.toggle('active', badge.dataset.preset === presetId);
            });

            // 설명 업데이트
            document.getElementById('preset-description').textContent = preset.description;

            // 조건 로드
            conditions = JSON.parse(JSON.stringify(preset.conditions));
            renderConditions();
            updatePreview();
        }

        // ========================================
        // 조건 관리
        // ========================================

        function addCondition() {
            const newCondition = {
                type: 'RSI',
                operator: '<',
                value: 30,
                period: 14,
                description: ''
            };
            conditions.push(newCondition);
            renderConditions();
            updatePreview();
        }

        function removeCondition(index) {
            conditions.splice(index, 1);
            renderConditions();
            updatePreview();
        }

        function updateCondition(index, field, value) {
            conditions[index][field] = value;
            updatePreview();
        }

        function renderConditions() {
            const container = document.getElementById('conditions-container');

            if (conditions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state py-4">
                        <i class="fas fa-plus-circle" style="font-size: 2rem;"></i>
                        <p class="mb-0">조건 추가 버튼을 클릭하여 조건을 추가하세요</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = conditions.map((cond, index) => `
                <div class="condition-card">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label small text-muted">지표</label>
                            <select class="form-select form-select-sm indicator-select"
                                    onchange="updateCondition(${index}, 'type', this.value)">
                                ${INDICATORS.map(ind =>
                                    `<option value="${ind.value}" ${cond.type === ind.value ? 'selected' : ''}>${ind.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">조건</label>
                            <select class="form-select form-select-sm operator-select"
                                    onchange="updateCondition(${index}, 'operator', this.value)">
                                ${OPERATORS.map(op =>
                                    `<option value="${op.value}" ${cond.operator === op.value ? 'selected' : ''}>${op.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">값</label>
                            <input type="text" class="form-control form-control-sm"
                                   value="${cond.value}"
                                   onchange="updateCondition(${index}, 'value', this.value)">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">기간</label>
                            <input type="number" class="form-control form-control-sm"
                                   value="${cond.period || ''}"
                                   placeholder="일"
                                   onchange="updateCondition(${index}, 'period', parseInt(this.value) || null)">
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="removeCondition(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updatePreview() {
            const previewContainer = document.getElementById('condition-preview');
            const previewList = document.getElementById('preview-list');

            if (conditions.length === 0) {
                previewContainer.style.display = 'none';
                return;
            }

            previewContainer.style.display = 'block';
            previewList.innerHTML = conditions.map((cond, i) => {
                const indicator = INDICATORS.find(ind => ind.value === cond.type);
                const operator = OPERATORS.find(op => op.value === cond.operator);
                return `<li>${indicator?.label || cond.type} ${operator?.label || cond.operator} ${cond.value}${cond.period ? ` (${cond.period}일)` : ''}</li>`;
            }).join('');
        }

        // ========================================
        // 스크리닝 실행
        // ========================================

        async function runScreening() {
            if (conditions.length === 0) {
                showToast('최소 1개 이상의 조건을 추가해주세요', 'warning');
                return;
            }

            const targetDate = document.getElementById('target-date').value;
            const targetMarket = document.getElementById('target-market').value;

            // UI 업데이트
            const runBtn = document.getElementById('run-btn');
            runBtn.disabled = true;
            runBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>스크리닝 중...';

            const progressContainer = document.getElementById('progress-container');
            progressContainer.classList.add('active');

            // 진행률 시뮬레이션
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 15;
                    updateProgress(Math.min(progress, 90));
                }
            }, 500);

            try {
                const response = await fetch('/api/v1/screening/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conditions: conditions,
                        target_market: targetMarket,
                        target_date: targetDate
                    })
                });

                clearInterval(progressInterval);
                updateProgress(100);

                const data = await response.json();

                if (response.ok) {
                    screeningResults = data.results || [];
                    displayResults(data);
                    showToast(`스크리닝 완료! ${screeningResults.length}개 종목 발견`, 'success');
                } else {
                    showToast('스크리닝 실패: ' + (data.detail || '알 수 없는 오류'), 'danger');
                }
            } catch (error) {
                clearInterval(progressInterval);
                showToast('스크리닝 실행 오류: ' + error.message, 'danger');
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = '<i class="fas fa-play me-2"></i>스크리닝 실행';
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                    updateProgress(0);
                }, 1000);
            }
        }

        function updateProgress(value) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            progressBar.style.width = value + '%';
            progressText.textContent = Math.round(value) + '%';
        }

        function displayResults(data) {
            const results = data.results || [];
            const container = document.getElementById('results-container');
            const statsContainer = document.getElementById('stats-container');

            // 통계 표시
            document.getElementById('stat-total').textContent = data.total_scanned || 0;
            document.getElementById('stat-matched').textContent = results.length;

            // 평균 RSI 계산
            const avgRsi = results.length > 0
                ? (results.reduce((sum, r) => sum + (r.rsi || 0), 0) / results.length).toFixed(1)
                : '-';
            document.getElementById('stat-avg-rsi').textContent = avgRsi;

            // 시장 비율
            const ratio = data.total_scanned > 0
                ? ((results.length / data.total_scanned) * 100).toFixed(1) + '%'
                : '-';
            document.getElementById('stat-market-ratio').textContent = ratio;

            statsContainer.style.display = 'flex';
            document.getElementById('result-count').textContent = results.length + '개 종목';

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>조건에 맞는 종목이 없습니다</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover results-table mb-0">
                        <thead>
                            <tr>
                                <th>종목코드</th>
                                <th>종목명</th>
                                <th class="text-end">현재가</th>
                                <th class="text-end">등락률</th>
                                <th class="text-end">거래량</th>
                                <th class="text-end">RSI</th>
                                <th>매칭 조건</th>
                                <th class="text-center">액션</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(stock => `
                                <tr>
                                    <td><code>${stock.ticker}</code></td>
                                    <td class="fw-bold">${stock.company_name || stock.name || '-'}</td>
                                    <td class="text-end">${formatNumber(stock.price || stock.close_price)}원</td>
                                    <td class="text-end ${(stock.change_percent || 0) >= 0 ? 'price-up' : 'price-down'}">
                                        ${(stock.change_percent || 0) >= 0 ? '+' : ''}${(stock.change_percent || 0).toFixed(2)}%
                                    </td>
                                    <td class="text-end">${formatNumber(stock.volume)}</td>
                                    <td class="text-end">${stock.rsi ? stock.rsi.toFixed(1) : '-'}</td>
                                    <td class="small text-muted">${(stock.matched_conditions || []).slice(0, 2).join(', ') || '-'}</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="openAddToPortfolio('${stock.ticker}', '${stock.company_name || stock.name || ''}', ${stock.price || stock.close_price || 0}, ${stock.rsi || 0}, ${stock.change_percent || 0})">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ========================================
        // 포트폴리오 추가
        // ========================================

        function openAddToPortfolio(ticker, name, price, rsi, change) {
            selectedStock = { ticker, name, price, rsi, change };

            document.getElementById('stock-info-alert').innerHTML = `
                <div class="d-flex justify-content-between">
                    <span><strong>${name}</strong> (${ticker})</span>
                    <span class="fw-bold">${formatNumber(price)}원</span>
                </div>
                <div class="d-flex justify-content-between small mt-1">
                    <span>RSI: ${rsi ? rsi.toFixed(1) : '-'}</span>
                    <span class="${change >= 0 ? 'text-danger' : 'text-primary'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>
                </div>
            `;

            document.getElementById('pf-quantity').value = '';
            document.getElementById('pf-target-price').value = '';
            document.getElementById('pf-stop-loss').value = '';
            document.getElementById('pf-notes').value = `스크리닝 결과에서 추가 (${new Date().toLocaleDateString('ko-KR')})`;

            new bootstrap.Modal(document.getElementById('addPortfolioModal')).show();
        }

        async function submitToPortfolio() {
            if (!selectedStock) return;

            const quantity = parseInt(document.getElementById('pf-quantity').value);
            if (!quantity || quantity < 1) {
                showToast('수량을 입력해주세요', 'warning');
                return;
            }

            const targetPrice = parseFloat(document.getElementById('pf-target-price').value) || (selectedStock.price * 1.1);
            const stopLoss = parseFloat(document.getElementById('pf-stop-loss').value) || (selectedStock.price * 0.95);
            const notes = document.getElementById('pf-notes').value;

            try {
                const response = await fetch('/api/v1/holdings/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 5, // 기본 사용자
                        ticker: selectedStock.ticker,
                        company_name: selectedStock.name,
                        quantity: quantity,
                        avg_buy_price: selectedStock.price,
                        take_profit_price: targetPrice,
                        stop_loss_price: stopLoss,
                        notes: notes
                    })
                });

                if (response.ok) {
                    showToast('포트폴리오에 추가되었습니다!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addPortfolioModal')).hide();
                } else {
                    const data = await response.json();
                    showToast('추가 실패: ' + (data.detail || '알 수 없는 오류'), 'danger');
                }
            } catch (error) {
                showToast('추가 중 오류 발생: ' + error.message, 'danger');
            }
        }

        // ========================================
        // 전략 저장
        // ========================================

        function openSaveStrategyModal() {
            if (conditions.length === 0) {
                showToast('저장할 조건이 없습니다', 'warning');
                return;
            }

            const previewHtml = conditions.map(cond => {
                const indicator = INDICATORS.find(ind => ind.value === cond.type);
                const operator = OPERATORS.find(op => op.value === cond.operator);
                return `<div>• ${indicator?.label || cond.type} ${operator?.label || cond.operator} ${cond.value}</div>`;
            }).join('');

            document.getElementById('strategy-conditions-preview').innerHTML = previewHtml;
            document.getElementById('strategy-name').value = '';
            document.getElementById('strategy-description').value = '';

            new bootstrap.Modal(document.getElementById('saveStrategyModal')).show();
        }

        async function saveStrategy() {
            const name = document.getElementById('strategy-name').value.trim();
            if (!name) {
                showToast('전략 이름을 입력해주세요', 'warning');
                return;
            }

            const description = document.getElementById('strategy-description').value;
            const notification = document.getElementById('strategy-notification').checked;
            const targetMarket = document.getElementById('target-market').value;

            try {
                const response = await fetch('/api/v1/screening/strategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        conditions: conditions,
                        target_market: targetMarket,
                        is_active: true,
                        notification_enabled: notification
                    })
                });

                if (response.ok) {
                    showToast('전략이 저장되었습니다!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('saveStrategyModal')).hide();
                } else {
                    const data = await response.json();
                    showToast('저장 실패: ' + (data.detail || '알 수 없는 오류'), 'danger');
                }
            } catch (error) {
                showToast('저장 중 오류 발생: ' + error.message, 'danger');
            }
        }

        // ========================================
        // 유틸리티
        // ========================================

        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString('ko-KR');
        }

        function showToast(message, type = 'info') {
            // 기존 토스트 제거
            const existingToast = document.querySelector('.toast-container');
            if (existingToast) existingToast.remove();

            const toastHtml = `
                <div class="toast-container position-fixed bottom-0 end-0 p-3">
                    <div class="toast show bg-${type}" role="alert">
                        <div class="toast-body text-white">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                            ${message}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', toastHtml);

            setTimeout(() => {
                const toast = document.querySelector('.toast-container');
                if (toast) toast.remove();
            }, 3000);
        }

    </script>
</body>
</html>
